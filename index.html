<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>DeepPixel - Online √áok Oyunculu Monopoly Oyunu</title>
    <meta name="description" content="DeepPixel ile arkada≈ülarƒ±nƒ±zla online monopoly oynayƒ±n! Ger√ßek zamanlƒ± √ßok oyunculu, √∂zelle≈ütirilebilir oyun tahtasƒ±, takas sistemi ve daha fazlasƒ±. √úcretsiz monopoly oyunu ≈üimdi oyna!">
    <meta name="keywords" content="monopoly, online monopoly, √ßok oyunculu monopoly, monopoly oyna, √ºcretsiz monopoly, deeppixel, online masa oyunu, kutu oyunu, arkada≈ülarla oyna, ger√ßek zamanlƒ± oyun">
    <meta name="author" content="DeepPixel">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Turkish">
    <meta name="revisit-after" content="7 days">
    <!-- Google Site Verification - BURAYA GOOGLE'DAN ALDIƒûINIZ KODU EKLEYƒ∞N -->
    <!-- <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE_HERE" /> -->
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://deeppixel.online/">
    <meta property="og:title" content="DeepPixel - Online √áok Oyunculu Monopoly Oyunu">
    <meta property="og:description" content="Arkada≈ülarƒ±nƒ±zla online monopoly oynayƒ±n! Ger√ßek zamanlƒ± multiplayer, √∂zelle≈ütirilebilir oyun modu ve √ºcretsiz. Hemen oynamaya ba≈üla!">
    <meta property="og:image" content="https://deeppixel.online/og-image.jpg">
    <meta property="og:site_name" content="DeepPixel">
    <meta property="og:locale" content="tr_TR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://deeppixel.online/">
    <meta name="twitter:title" content="DeepPixel - Online Monopoly Oyunu">
    <meta name="twitter:description" content="Arkada≈ülarƒ±nƒ±zla online monopoly oynayƒ±n! Ger√ßek zamanlƒ± multiplayer, √ºcretsiz oyna.">
    <meta name="twitter:image" content="https://deeppixel.online/twitter-image.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://deeppixel.online/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Humans.txt -->
    <link rel="author" type="text/plain" href="/humans.txt">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#9333ea">
    
    <!-- üîÑ Cache Buster - Force Reload -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: "#A78BFA",
                            light: "#C4B5FD",
                        },
                        secondary: "#00F5D4",
                        background: "#0D0C14",
                        card: "#161523",
                        border: "#2A283E",
                    },
                    fontFamily: {
                        display: ["Rajdhani", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .material-icons-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }
        @media (max-width: 900px) {
            /* Mobilde sidebarlarƒ± gizle */
            #game-container > aside {
                display: none !important;
            }
            
            /* Center board'u tam geni≈üliƒüe al */
            #game-container > main {
                width: 100%;
                padding: 0.5rem;
            }
            
            /* Board wrapper'ƒ±n padding'ini kaldƒ±r */
            #game-container > main > div {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Game container padding */
            #game-container {
                padding: 0.5rem !important;
                gap: 0.5rem !important;
            }
            
            #mobile-controls-bar {
                display: none;
            }
            #game-container.active {
                min-height: 100vh;
                height: 100vh;
            }
            #game-log {
                font-size: 1.1rem;
                background: rgba(255,255,255,0.95);
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 40;
                max-height: 80px;
                overflow-y: auto;
                border-top: 2px solid #e5e7eb;
                padding: 8px 12px;
                margin-bottom: 120px;
            }
            
            /* Board boyutunu mobil i√ßin ayarla */
            .board {
                width: 95vw !important;
                height: 95vw !important;
                max-width: 500px !important;
                max-height: 500px !important;
            }
            
            /* Space fontlarƒ±nƒ± okunaklƒ± yap */
            .space {
                font-size: 8px;
                padding: 2px;
            }
            
            .corner {
                font-size: 10px;
            }
        }
        
        #controls-bar {
            flex-direction: column;
            gap: 8px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            overflow-y: auto;
            background-color: #0D0C14;
            background-image: radial-gradient(circle at 1px 1px, rgba(167, 139, 250, 0.1) 1px, transparent 0);
            background-size: 30px 30px;
            background-attachment: fixed;
        }
        .board {
            display: grid;
            grid-template-columns: 140px repeat(9, 1fr) 140px;
            grid-template-rows: 140px repeat(9, 1fr) 140px;
            gap: 2px;
            width: 90vmin;
            height: 90vmin;
            max-width: 800px;
            max-height: 800px;
            margin: auto;
            border: 8px solid #374151;
            background: #111827;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6), inset 0 0 30px rgba(167, 139, 250, 0.2);
            border-radius: 12px;
            position: relative;
        }
        .board::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: linear-gradient(135deg, #2A283E 0%, #161523 50%, #2A283E 100%);
            border-radius: 12px;
            z-index: -1;
        }
        .space {
            border: 2px solid #374151;
            position: relative;
            background: #1F2937;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            text-align: center;
            padding: 4px;
            overflow: hidden;
            transition: all 0.2s ease;
            border-radius: 4px;
            color: #E5E7EB;
        }
        .space:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(167, 139, 250, 0.4);
            z-index: 5;
        }
        .corner { grid-column: span 1; grid-row: span 1; }
        .top-row { grid-column: span 1; grid-row: 1; }
        .bottom-row { grid-column: span 1; grid-row: 11; }
        .left-col { grid-column: 1; grid-row: span 1; }
        .right-col { grid-column: 11; grid-row: span 1; }

        #space-0 { grid-column: 11; grid-row: 11; }
        #space-1 { grid-column: 10; grid-row: 11; }
        #space-2 { grid-column: 9; grid-row: 11; }
        #space-3 { grid-column: 8; grid-row: 11; }
        #space-4 { grid-column: 7; grid-row: 11; }
        #space-5 { grid-column: 6; grid-row: 11; }
        #space-6 { grid-column: 5; grid-row: 11; }
        #space-7 { grid-column: 4; grid-row: 11; }
        #space-8 { grid-column: 3; grid-row: 11; }
        #space-9 { grid-column: 2; grid-row: 11; }
        #space-10 { grid-column: 1; grid-row: 11; }
        #space-11 { grid-column: 1; grid-row: 10; }
        #space-12 { grid-column: 1; grid-row: 9; }
        #space-13 { grid-column: 1; grid-row: 8; }
        #space-14 { grid-column: 1; grid-row: 7; }
        #space-15 { grid-column: 1; grid-row: 6; }
        #space-16 { grid-column: 1; grid-row: 5; }
        #space-17 { grid-column: 1; grid-row: 4; }
        #space-18 { grid-column: 1; grid-row: 3; }
        #space-19 { grid-column: 1; grid-row: 2; }
        #space-20 { grid-column: 1; grid-row: 1; }
        #space-21 { grid-column: 2; grid-row: 1; }
        #space-22 { grid-column: 3; grid-row: 1; }
        #space-23 { grid-column: 4; grid-row: 1; }
        #space-24 { grid-column: 5; grid-row: 1; }
        #space-25 { grid-column: 6; grid-row: 1; }
        #space-26 { grid-column: 7; grid-row: 1; }
        #space-27 { grid-column: 8; grid-row: 1; }
        #space-28 { grid-column: 9; grid-row: 1; }
        #space-29 { grid-column: 10; grid-row: 1; }
        #space-30 { grid-column: 11; grid-row: 1; }
        #space-31 { grid-column: 11; grid-row: 2; }
        #space-32 { grid-column: 11; grid-row: 3; }
        #space-33 { grid-column: 11; grid-row: 4; }
        #space-34 { grid-column: 11; grid-row: 5; }
        #space-35 { grid-column: 11; grid-row: 6; }
        #space-36 { grid-column: 11; grid-row: 7; }
        #space-37 { grid-column: 11; grid-row: 8; }
        #space-38 { grid-column: 11; grid-row: 9; }
        #space-39 { grid-column: 11; grid-row: 10; }
        
        .center-board {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 3px solid #374151;
            background: rgba(17, 24, 39, 0.95);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        .color-bar {
            width: 100%;
            height: 22%;
            border-bottom: 2px solid #2d3748;
            border-radius: 4px 4px 0 0;
        }
        /* üé≤ 3D Dice Styles */
        #dice-animation-container {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #dice-animation-container.show {
            opacity: 1;
        }
        
        /* ü§ö El tasarƒ±mƒ± */
        .dice-hand {
            position: absolute;
            font-size: 40px;
            z-index: 1001;
            pointer-events: none;
            transition: transform 0.3s ease-out;
            opacity: 0;
        }
        
        .dice-hand.show {
            opacity: 1;
        }
        
        .dice-3d-container {
            width: 35px;
            height: 35px;
            position: relative;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        
        .dice-3d {
            width: 35px;
            height: 35px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s linear;
        }
        
        .dice-face {
            position: absolute;
            width: 35px;
            height: 35px;
            background: #000000;
            border: 2px solid #FFD700;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 4px rgba(255, 215, 0, 0.3),
                0 0 8px rgba(255, 215, 0, 0.2),
                inset 0 0 12px rgba(0, 0, 0, 0.9),
                0 4px 8px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
        }
        
        /* 3D g√∂r√ºn√ºm i√ßin kenarlar ve k√∂≈üeler - farklƒ± y√ºzler i√ßin farklƒ± tonlar (daha sade) */
        .dice-face.front {
            background: #000000;
            border-color: #FFD700;
        }
        .dice-face.back {
            background: #0a0a0a;
            border-color: #FFC700;
        }
        .dice-face.right {
            background: #000000;
            border-color: #FFD700;
        }
        .dice-face.left {
            background: #0a0a0a;
            border-color: #FFC700;
        }
        .dice-face.top {
            background: #000000;
            border-color: #FFE700;
        }
        .dice-face.bottom {
            background: #0a0a0a;
            border-color: #FFB700;
        }
        
        .dice-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            position: absolute;
            box-shadow: 
                0 0 2px currentColor,
                0 0 3px currentColor;
            z-index: 2;
            animation: rgbDot 3s infinite;
        }
        
        @keyframes rgbDot {
            0% {
                background: #ff0000;
                color: #ff0000;
            }
            16.66% {
                background: #ff8800;
                color: #ff8800;
            }
            33.33% {
                background: #ffff00;
                color: #ffff00;
            }
            50% {
                background: #00ff00;
                color: #00ff00;
            }
            66.66% {
                background: #0088ff;
                color: #0088ff;
            }
            83.33% {
                background: #0000ff;
                color: #0000ff;
            }
            100% {
                background: #ff00ff;
                color: #ff00ff;
            }
        }
        
        /* Zar y√ºzleri pozisyonlarƒ± (3D cube) - translateZ = zar boyutu / 2 */
        /* Gap olmamasƒ± i√ßin exact 17.5px (zar boyutu / 2) kullanƒ±yoruz */
        .dice-face.front { 
            transform: rotateY(0deg) translateZ(17.5px);
        }
        .dice-face.back { 
            transform: rotateY(180deg) translateZ(17.5px);
        }
        .dice-face.right { 
            transform: rotateY(90deg) translateZ(17.5px);
        }
        .dice-face.left { 
            transform: rotateY(-90deg) translateZ(17.5px);
        }
        .dice-face.top { 
            transform: rotateX(90deg) translateZ(17.5px);
        }
        .dice-face.bottom { 
            transform: rotateX(-90deg) translateZ(17.5px);
        }
        
        /* Zar kenarlarƒ±nda gap olmamasƒ± i√ßin */
        .dice-3d {
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        
        /* Zar y√ºzlerinin arkasƒ±nƒ± gizle - i√ß i√ße ge√ßmeyi √∂nler */
        .dice-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform-style: preserve-3d;
        }
        
        /* Zar y√ºzlerinin √ßakƒ±≈ümasƒ±nƒ± √∂nle - sadece √∂n y√ºz g√∂r√ºns√ºn */
        .dice-3d-container {
            transform-style: preserve-3d;
        }
        
        @keyframes diceRoll {
            0% {
                transform: translateY(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg);
            }
            25% {
                transform: translateY(-50px) rotateX(360deg) rotateY(180deg) rotateZ(90deg);
            }
            50% {
                transform: translateY(10px) rotateX(720deg) rotateY(360deg) rotateZ(180deg);
            }
            75% {
                transform: translateY(-20px) rotateX(1080deg) rotateY(540deg) rotateZ(270deg);
            }
            100% {
                transform: translateY(0) rotateX(1440deg) rotateY(720deg) rotateZ(360deg);
            }
        }
        
        .dice-rolling {
            animation: diceRoll 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* üé® End Turn Button - RGB Animated Border (Hover Only) */
        .end-turn-btn {
            position: relative;
            border: 5px solid transparent;
            background-clip: padding-box;
            isolation: isolate;
            transition: all 0.3s ease;
        }
        
        .end-turn-btn::before {
            content: '';
            position: absolute;
            inset: -7px;
            border-radius: inherit;
            padding: 7px;
            /* Conic gradient for full border coverage */
            background: conic-gradient(
                from 0deg,
                #ff0000, #ff7f00, #ffff00, #00ff00, 
                #0000ff, #4b0082, #9400d3, #ff0000
            );
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            animation: none;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .end-turn-btn:hover:not(:disabled)::before {
            opacity: 1;
            animation: rgbFlowRotate 3s linear infinite;
        }
        
        @keyframes rgbFlowRotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .end-turn-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .end-turn-btn:disabled::before {
            opacity: 0;
            animation: none;
        }
        
        .player-piece {
            position: absolute;
            width: 32px;
            height: 32px;
            font-size: 28px;
            line-height: 32px;
            text-align: center;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
            animation: pieceFloat 2s ease-in-out infinite;
            scale: 1.3;
            padding-bottom: 20px;
        }
        @keyframes pieceFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .owner-indicator {
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* üí¨ Chat Panel Styling */
        #chat-panel {
            transition: all 0.3s ease;
            min-height: 200px;
        }
        
        #chat-messages {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat-messages::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 10px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .chat-message {
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #10b981;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .chat-message .sender {
            font-weight: bold;
            color: #059669;
            font-size: 0.875rem;
        }
        
        .chat-message .text {
            color: #374151;
            font-size: 0.875rem;
            margin-top: 2px;
        }
        
        .modal {
            transition: opacity 0.25s ease;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            transition: transform 0.25s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .dice {
            font-size: 3rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 3px solid #374151;
            background: #1F2937;
            box-shadow: 0 8px 16px rgba(167, 139, 250, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            color: #E5E7EB;
        }
        .dice:hover {
            transform: rotate(5deg) scale(1.05);
        }
        
        /* 3D Dice Animation */
        .dice-3d {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            animation: rollDice 1s ease-out;
        }
        @keyframes rollDice {
            0% { transform: rotateX(0deg) rotateY(0deg) translateY(-100px); }
            50% { transform: rotateX(720deg) rotateY(720deg) translateY(0px); }
            100% { transform: rotateX(1080deg) rotateY(1080deg) translateY(0px); }
        }
        .dice-face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        .dice-dot {
            width: 14px;
            height: 14px;
            background: #333;
            border-radius: 50%;
            position: absolute;
        }
        .dice-rolling {
            animation: diceShake 0.1s infinite;
        }
        @keyframes diceShake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-3px, -3px) rotate(-8deg); }
            50% { transform: translate(3px, -2px) rotate(8deg); }
            75% { transform: translate(-2px, 3px) rotate(-5deg); }
        }
        
        /* ÔøΩ Property Buy Panel Styles */
        #property-buy-panel {
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* ÔøΩüé≠ Character & Map Button Styles */
        .character-btn, .map-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .character-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .character-btn.border-blue-500 {
            border-width: 3px !important;
            border-color: #9333ea !important;
            background: rgba(167, 139, 250, 0.2) !important;
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.6) !important;
            transform: scale(1.15) !important;
        }
        
        .character-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        .map-btn.border-blue-500 {
            border-width: 3px !important;
            border-color: #9333ea !important;
            background: rgba(167, 139, 250, 0.2) !important;
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.5) !important;
        }
        
        /* Game mode button styles */
        .game-mode-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .game-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(167, 139, 250, 0.3);
            border-color: #9333ea !important;
        }
        .game-mode-btn.border-blue-500 {
            border-color: #9333ea !important;
            background: rgba(167, 139, 250, 0.2) !important;
        }
        
        /* Enhanced space styles */
        .space.corner {
            background: #1F2937;
            font-size: 10px;
            font-weight: bold;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            color: #E5E7EB;
        }
        .space[id="space-0"] {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%) !important;
            color: white;
        }
        .space[id="space-10"] {
            background: linear-gradient(135deg, #A78BFA 0%, #9333ea 100%) !important;
            color: white;
        }
        .space[id="space-20"] {
            background: linear-gradient(135deg, #00F5D4 0%, #00c9a7 100%) !important;
            color: #030712;
        }
        .space[id="space-30"] {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%) !important;
            color: white;
        }
        
        .houses-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 2px;
        }
        .house {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #065f46;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .hotel {
            width: 24px;
            height: 14px;
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            border: 2px solid #9f1239;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* üì± Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* üì± LOBBY/MAIN MENU - Mobile Friendly */
            #lobby {
                max-width: 95vw;
                padding: 20px 16px;
                margin: 10px;
            }
            
            #lobby h1 {
                font-size: 28px;
                margin-bottom: 12px;
            }
            
            #lobby p {
                font-size: 13px;
                margin-bottom: 20px;
            }
            
            /* Character selection grid on mobile */
            #main-character-select {
                display: grid;
                grid-template-columns: repeat(8, 2fr);
                gap: 8px;
            }
            
            .character-btn {
                font-size: 28px !important;
                padding: 8px !important;
                min-height: 50px;
            }
            
            /* Map selection mobile */
            #main-map-select {
                grid-template-columns: repeat(4, 2fr);
                gap: 8px;
            }
            
            .map-btn {
                font-size: 12px;
                padding: 10px 8px !important;
                min-height: 44px;
            }
            
            /* Input fields */
            #playerNameInput,
            #gameIdInput {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Buttons */
            #createGameBtn,
            #joinGameBtn {
                font-size: 15px;
                padding: 14px 16px;
                min-height: 48px;
            }
            
            /* Smaller board on mobile */
            .board {
                width: 95vmin;
                height: 95vmin;
                grid-template-columns: 100px repeat(9, 1fr) 100px;
                grid-template-rows: 100px repeat(9, 1fr) 100px;
                gap: 1px;
                border: 4px solid #374151;
            }
            
            /* Smaller spaces */
            .space {
                font-size: 6px;
                padding: 2px;
            }
            
            /* Smaller corners */
            .corner {
                font-size: 8px;
                padding: 3px;
            }
            
            /* Smaller player pieces */
            .player-piece {
                scale: 1;
                padding-bottom: 10px;
                font-size: 20px;
                width: 22px;
                height: 22px;
            }
            
            /* Smaller houses */
            .house {
                width: 8px;
                height: 8px;
                border: 1px solid #065f46;
            }
            
            .hotel {
                width: 14px;
                height: 8px;
                border: 1px solid #9f1239;
            }
            
            /* Smaller owner indicators */
            .owner-indicator {
                width: 8px;
                height: 8px;
            }
            
            /* Mobile-friendly modals */
            #modal-overlay {
                padding: 10px;
            }
            
            #modal {
                max-width: 95vw;
                max-height: 90vh;
                padding: 16px;
            }
            
            /* Compact player cards */
            .player-card {
                padding: 8px;
                font-size: 12px;
            }
            
            /* Touch-friendly buttons */
            button {
                min-height: 44px;
                padding: 10px 16px;
            }
            
            /* Scrollable game log */
            #game-log {
                max-height: 120px;
                font-size: 11px;
            }
            
            /* Hide some decorative elements on mobile */
            .leaderboard {
                font-size: 11px;
                padding: 8px;
            }
            
            /* Make character selection more compact */
            .character-btn {
                font-size: 24px;
                padding: 4px;
            }
            
            /* üì± GAME SETTINGS SCREEN - Mobile Optimizations */
            #game-settings {
                display: none;
                max-width: 95vw !important;
                padding: 16px !important;
                margin: 10px;
                max-height: 95vh !important;
            }
            
            #game-settings h2 {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            #game-settings h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            #displayGameId {
                font-size: 20px;
                padding: 12px;
            }
            
            /* Game mode grid - 2 columns on mobile */
            #game-settings .game-mode-btn {
                font-size: 12px;
                padding: 10px 12px;
            }
            
            #game-settings .grid {
                gap: 8px;
            }
            
            /* Properties editor */
            #properties-editor {
                max-height: 250px !important;
                gap: 8px;
            }
            
            #properties-editor .property-card {
                font-size: 11px;
                padding: 8px;
            }
            
            /* Lobby controls */
            #lobby-controls {
                margin-top: 16px;
            }
            
            #lobby-players-list {
                gap: 4px;
            }
            
            #addBotBtn,
            #startGameBtn {
                font-size: 14px;
                padding: 12px 16px;
            }
            
            /* üì± GAME SCREEN - Mobile Optimizations */
            #game-container {
                display: none;
                padding: 4px !important;
                gap: 4px !important;
                flex-direction: column !important;
            }
            
            /* Leaderboard - smaller and repositioned */
            #leaderboard {
                position: relative !important;
                top: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                min-width: unset !important;
                padding: 8px !important;
                margin-bottom: 8px;
            }
            
            #leaderboard h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            #leaderboard-list {
                font-size: 11px;
            }
            
            #darkModeToggle {
                font-size: 12px;
                padding: 8px;
                margin-top: 8px;
            }
            
            /* Left panel - full width on mobile */
            #left-panel {
                width: 100% !important;
                padding: 8px !important;
                margin-bottom: 8px;
                max-height: 300px;
                overflow-y: auto;
                background: #161523 !important;
                border-color: #2A283E !important;
                color: #E5E7EB;
            }
            
            #left-panel h2 {
                font-size: 18px;
                margin-bottom: 8px;
                color: #ffffff;
            }
            
            /* Player cards - horizontal scroll */
            #players-info {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                gap: 8px;
                padding-bottom: 8px;
            }
            
            #players-info .player-card {
                min-width: 150px;
                flex-shrink: 0;
            }
            
            /* Dice container */
            #dice-container {
                height: 80px !important;
                margin-bottom: 12px;
            }
            
            .dice {
                width: 50px !important;
                height: 50px !important;
                font-size: 32px !important;
            }
            
            /* Control buttons */
            #controls button {
                font-size: 13px;
                padding: 10px 12px;
                margin-top: 6px;
            }
            
            #rollDiceBtn {
                font-size: 14px !important;
                padding: 12px !important;
            }
            
            /* Right panel - game log */
            #right-panel {
                width: 100% !important;
                padding: 8px !important;
                max-height: 150px !important;
            }
            
            #right-panel h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            #game-log {
                font-size: 11px;
                max-height: 100px;
            }
            
            /* üí¨ Chat Panel - Separate styling */
            #chat-panel {
                width: 100% !important;
                max-height: 200px !important;
                margin-top: 10px;
                order: 10; /* Put it at the bottom */
            }
            
            #chat-messages {
                font-size: 12px;
                min-height: 100px !important;
                max-height: 120px !important;
            }
            
            #chat-input {
                font-size: 14px;
            }
            
            #chat-send-btn {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            /* Board container - center and resize */
            #board-container {
                order: -1; /* Move board to top */
                width: 100% !important;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 8px;
            }
                /* --- EKSTRA MOBƒ∞L OYUN ƒ∞√áƒ∞ ƒ∞Yƒ∞LE≈ûTƒ∞RMELER --- */
                /* Oyun i√ßi ana butonlar daha b√ºy√ºk ve kolay tƒ±klanabilir */
                #controls button, .action-btn, .trade-btn, .mortgage-btn, .buy-btn, .bid-btn, .share-btn {
                    font-size: 18px !important;
                    min-width: 90px;
                    min-height: 48px;
                    padding: 12px 18px !important;
                    margin: 6px 0 !important;
                }

                /* Kartlar mobilde daha b√ºy√ºk ve kolay kaydƒ±rƒ±labilir */
                .property-card, .card-mini, .owned-card {
                    font-size: 8px !important;
                    min-width: 110px;
                    min-height: 60px;
                    margin: 4px 2px !important;
                    padding: 8px 6px !important;
                }

                /* Kartlar yatay scroll ile g√∂sterilsin */
                #owned-cards, #player-cards, .player-cards-row {
                    display: flex !important;
                    flex-direction: row !important;
                    overflow-x: auto !important;
                    gap: 6px !important;
                    padding-bottom: 8px !important;
                }

                /* Popup ve modal'lar mobilde tam ekran ve kolay kapatƒ±labilir */
                .modal, #modal, .popup, .trade-popup {
                    max-width: 99vw !important;
                    max-height: 99vh !important;
                    min-width: 90vw !important;
                    min-height: 60vh !important;
                    border-radius: 12px !important;
                    padding: 18px 8px !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    margin: auto !important;
                }

                /* Modal kapatma butonu b√ºy√ºk ve saƒü √ºstte */
                .modal-close, .popup-close, .trade-popup-close {
                    position: absolute !important;
                    top: 10px !important;
                    right: 14px !important;
                    font-size: 32px !important;
                    background: none !important;
                    border: none !important;
                    color: #333 !important;
                    z-index: 1001;
                }

                /* Oyun i√ßi alt men√º ve hƒ±zlƒ± eri≈üim barƒ± */
                #quick-access-bar {
                    display: flex !important;
                    flex-direction: row !important;
                    justify-content: space-around !important;
                    align-items: center !important;
                    position: fixed !important;
                    bottom: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    background: rgba(255,255,255,0.98) !important;
                    border-top: 2px solid #ccc !important;
                    z-index: 1002;
                    padding: 6px 0 !important;
                }

                #quick-access-bar button {
                    font-size: 20px !important;
                    min-width: 60px;
                    min-height: 44px;
                    margin: 0 4px;
                }

                /* Oyun i√ßi kartlar ve oyuncu bilgileri mobilde ekranƒ±n √ºst√ºnde sabitlenebilir */
                #mobile-player-info-bar {
                    display: flex !important;
                    flex-direction: row !important;
                    justify-content: flex-start !important;
                    align-items: center !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    background: rgba(255,255,255,0.98) !important;
                    border-bottom: 2px solid #ccc !important;
                    z-index: 1002;
                    padding: 6px 0 !important;
                    overflow-x: auto !important;
                }

                #mobile-player-info-bar .player-card, #mobile-player-info-bar .card-mini {
                    min-width: 90px;
                    font-size: 13px !important;
                    margin: 0 4px;
                }

                /* Mobilde scroll barlarƒ± daha belirgin yap */
                ::-webkit-scrollbar {
                    height: 8px;
                    background: #eee;
                }
                ::-webkit-scrollbar-thumb {
                    background: #bbb;
                    border-radius: 4px;
                }

                /* Mobilde gereksiz dekoratif √∂ƒüeleri gizle */
                .desktop-only {
                    display: none !important;
                }
        }
        
        /* üì± Very Small Phones */
        @media (max-width: 480px) {
            /* üì± LOBBY - Extra Small Phones */
            #lobby {
                padding: 16px 12px;
                margin: 5px;
            }
            
            #lobby h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            #lobby p {
                font-size: 12px;
                margin-bottom: 16px;
            }
            
            /* Character selection - 3 columns on very small screens */
            #main-character-select {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .character-btn {
                font-size: 24px !important;
                padding: 6px !important;
                min-height: 44px;
            }
            
            /* Labels smaller */
            label {
                font-size: 13px;
            }
            
            #createGameBtn,
            #joinGameBtn {
                font-size: 14px;
                padding: 12px;
            }
            
            /* üì± GAME SETTINGS - Extra Small */
            #game-settings {
                padding: 12px !important;
            }
            
            #game-settings h2 {
                font-size: 20px;
            }
            
            #displayGameId {
                font-size: 18px;
                padding: 10px;
            }
            
            #game-settings .game-mode-btn {
                font-size: 11px;
                padding: 8px;
            }
            
            #addBotBtn,
            #startGameBtn {
                font-size: 13px;
                padding: 10px 12px;
            }
            
            /* üì± GAME BOARD - Extra Small */
            .board {
                grid-template-columns: 80px repeat(9, 1fr) 80px;
                grid-template-rows: 80px repeat(9, 1fr) 80px;
            }
            
            .space {
                font-size: 5px;
                padding: 1px;
            }
            
            .corner {
                font-size: 7px;
            }
            
            .player-piece {
                scale: 0.9;
                padding-bottom: 10px;
                font-size: 18px;
                width: 20px;
                height: 20px;
            }
            
            .dice {
                width: 45px !important;
                height: 45px !important;
                font-size: 28px !important;
            }
            
            #left-panel {
                max-height: 250px;
            }
            
            #right-panel {
                max-height: 120px !important;
            }
            
            #game-log {
                font-size: 10px;
                max-height: 80px;
            }
            
            button {
                font-size: 13px;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 500px) {
            /* üì± GAME BOARD - Extra Small */
            .board {
                grid-template-columns: 50px repeat(9, 1fr) 50px;
                grid-template-rows: 50px repeat(9, 1fr) 50px;
                width: 95vw !important;
                height: 95vw !important;
                max-width: 95vw !important;
                max-height: 95vw !important;
            }
            
            .space {
                font-size: 7px;
                padding: 2px;
            }
            
            .corner {
                font-size: 9px;
            }
            
            .player-piece {
                scale: 0.8;
                padding-bottom: 8px;
                font-size: 16px;
                width: 18px;
                height: 18px;
            }
            
            .dice {
                width: 50px !important;
                height: 50px !important;
                font-size: 32px !important;
            }
            
            #left-panel {
                max-height: 250px;
            }
            
            #right-panel {
                max-height: 120px !important;
            }
            
            #game-log {
                font-size: 10px;
                max-height: 80px;
            }
            
            button {
                font-size: 13px;
                padding: 8px 12px;
            }
            
            /* Mobilde sidebarlarƒ± gizle */
            #game-container > aside {
                display: none !important;
            }
            
            /* Center board'u tam geni≈üliƒüe al */
            #game-container > main {
                width: 100%;
                padding: 0;
            }
            
            /* Center board i√ßindeki wrapper */
            #game-container > main > div {
                width: 100%;
                padding: 0;
                background: transparent !important;
                border: none !important;
            }
            
            /* Board title k√º√ß√ºlt */
            #board-title {
                font-size: 1.5rem !important;
            }
            
            /* Dice container k√º√ß√ºlt */
            #dice-container {
                gap: 0.5rem !important;
            }
            
            /* Turn info k√º√ß√ºlt */
            #turn-info {
                font-size: 0.875rem !important;
            }
            
            /* Butonlarƒ± k√º√ß√ºlt */
            .center-board button {
                font-size: 0.875rem !important;
                padding: 0.5rem 1rem !important;
            }
            
            /* Center board height ayarla */
            .center-board {
                padding: 0.5rem !important;
                gap: 0.5rem !important;
            }
            
            /* Property color bars daha g√∂r√ºn√ºr */
            .color-bar {
                height: 25% !important;
            }
            
            /* Property name text */
            .space .property-name {
                font-size: 8px !important;
            }
        }

        /* Price labels outside spaces */
        .price-bottom {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-top {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-left {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-right {
            position: absolute;
            right: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        /* MASA√úST√úNDE her ≈üeyi 0.8x yap */
        @media (min-width: 769px) {
            html {
                font-size: 12.8px; /* 16px * 0.8 = 12.8px */
            }
            
            .mobile-game-actions {
                display: none !important;
            }
        }
        
        /* SADECE MOBƒ∞L: Oyun kontrolleri sadece oyun i√ßinde g√∂r√ºn√ºr */
        @media (max-width: 768px) {
            /* Mobilde normal boyut */
            body * {
                zoom: 1;
                -moz-transform: scale(0.95);
                transform: scale(0.95);
                -moz-transform-origin: 0 0;
                transform-origin: 0 0;
            }
            
            /* Mobilde board'u tamamen gizle */
            #board,
            .board {
                display: none !important;
            }
            
            /* Sadece oyun i√ßindeyken board'u g√∂ster */
            body.in-game #board,
            body.in-game .board {
                display: grid !important;
                margin-bottom: 100px !important;
                padding-bottom: 20px !important;
            }
            
            /* Mobilde masa√ºst√º oyun kontrollerini tamamen gizle */
            #rollDiceBtn,
            #endTurnBtn,
            #teamManagerBtn,
            #takeCreditBtn,
            #managePropertiesBtn,
            #jokerCardsBtn,
            #left-panel,
            #right-panel,
            #mobile-controls-bar,
            .center-board h1,
            #dice-container,
            #dice1-wrapper,
            #dice2-wrapper,
            #dice1,
            #dice2 {
                display: none !important;
            }
            
            /* Center board alanƒ±nƒ± bo≈ü bƒ±rak */
            .center-board {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* Mobil butonlar varsayƒ±lan olarak gizli */
            .mobile-game-actions {
                display: none !important;
            }
            
            /* Sadece oyun i√ßindeyken mobil butonlarƒ± g√∂ster */
            body.in-game .mobile-game-actions {
                display: flex !important;
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 300;
                background: #fff;
                border-top: 2px solid #e0e0e0;
                box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
                padding: 0.8rem;
                justify-content: space-around;
                align-items: center;
                gap: 0.5rem;
            }
            
            body.in-game .mobile-game-actions button {
                display: inline-flex !important;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                font-weight: 600;
                border-radius: 8px;
                border: none;
                background: #1a73e8;
                color: #fff;
                cursor: pointer;
                transition: background 0.2s;
                flex: 1;
                justify-content: center;
                align-items: center;
                min-height: 44px;
            }
            
            body.in-game .mobile-game-actions button:active {
                background: #155ab6;
            }
            
            /* Mobil butonlar i√ßin grid layout - 2 satƒ±r, 3+2 buton */
            body.in-game .mobile-game-actions {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                padding: 0.8rem;
            }
            
            body.in-game .mobile-game-actions button {
                padding: 0.7rem 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>
<body style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">

    <!-- Mobilde sadece oyun i√ßi men√ºde g√∂sterilecek kontroller -->
    <div class="mobile-game-actions">
        <button id="mobile-roll-btn">üé≤ Roll</button>
        <button id="mobile-properties-btn">üè† Props</button>
        <button id="mobile-joker-btn">üÉè Joker</button>
        <button id="mobile-team-btn" style="grid-column: span 2;">üë• Team</button>
        <button id="mobile-end-turn-btn">‚úÖ End</button>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="w-full max-w-lg p-8 rounded-2xl shadow-2xl text-center border relative overflow-visible" style="background: rgba(22, 21, 35, 0.8); backdrop-filter: blur(10px); border-color: rgba(42, 40, 62, 0.6); color: #E5E7EB; z-index: 10;">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold uppercase tracking-wider" style="color: #ffffff; text-shadow: 0 0 8px rgba(167, 139, 250, 0.7);">DEEPPIXEL</h1>
            <p class="mt-2" style="color: #9CA3AF;">Yeni bir oyun ba≈ülat veya arkada≈ülarƒ±nla oyna</p>
        </div>
        
        <!-- Continue Game Button (shown only when there's a saved session) -->
        <div id="continue-game-section" class="mb-6 hidden">
            <button id="continueGameBtn" class="w-full text-white font-bold py-4 px-4 rounded-lg transition duration-300 shadow-lg transform hover:scale-105" style="background-color: #9333ea; box-shadow: 0 0 15px 0 rgba(167, 139, 250, 0.6);">
                üîÑ Oyuna Devam Et
            </button>
            <p class="text-sm mt-2" style="color: #9CA3AF;">√ñnceki oyununuza kaldƒ±ƒüƒ±nƒ±z yerden devam edin</p>
            <button id="clearSessionBtn" class="text-sm text-red-500 hover:text-red-700 mt-2 underline">Oturumu Temizle</button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1.5 text-left" style="color: #E5E7EB;">Player Name</label>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2" style="color: #9CA3AF;">person</span>
                    <input id="playerNameInput" type="text" placeholder="Enter your name" class="w-full border rounded-lg shadow-sm transition pl-10 pr-4 py-2.5" style="background: #1F2937; border-color: #374151; color: #E5E7EB;">
                </div>
            </div>
            
            <!-- Character Selection in Main Menu -->
            <div>
                <label class="block text-sm font-medium mb-2 text-left" style="color: #E5E7EB;">Select Your Character</label>
                <div id="main-character-select" class="grid grid-cols-4 sm:grid-cols-8 gap-3">
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="car" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">directions_car</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="hat" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">theater_comedy</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="dog" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">pets</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="shoe" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">directions_boat</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="iron" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">nest_cam_magnet_mount</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="ship" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">rocket_launch</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="cat" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">cruelty_free</span>
                    </button>
                    <button type="button" class="character-btn aspect-square flex items-center justify-center border rounded-lg transition" data-char="money" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-3xl">monetization_on</span>
                    </button>
                </div>
            </div>
            
            <!-- Map Selection in Main Menu -->
            <div>
                <label class="block text-sm font-medium mb-2 text-left" style="color: #E5E7EB;">Select Map <span id="main-map-preview" class="text-xs font-semibold ml-2" style="color: #A78BFA;"></span></label>
                <div id="main-map-select" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="classic" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-xl" style="color: #9CA3AF;">castle</span> <span style="color: #E5E7EB;">Classic</span>
                    </button>
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="turkey" style="background: #1F2937; border-color: #374151;">
                        <span class="font-normal" style="color: #9CA3AF;">TR</span> <span style="color: #E5E7EB;">Turkey</span>
                    </button>
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="world" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-xl" style="color: #9CA3AF;">public</span> <span style="color: #E5E7EB;">World</span>
                    </button>
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="holland" style="background: #1F2937; border-color: #374151;">
                        <span class="font-normal" style="color: #9CA3AF;">NL</span> <span style="color: #E5E7EB;">Holland</span>
                    </button>
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="megarich" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-xl" style="color: #9CA3AF;">diamond</span> <span style="color: #E5E7EB;">Mega Rich</span>
                    </button>
                    <button type="button" class="map-btn text-left font-medium p-3 border rounded-lg transition flex items-center gap-2" data-map="custom" style="background: #1F2937; border-color: #374151;">
                        <span class="material-symbols-outlined text-xl" style="color: #9CA3AF;">tune</span> <span style="color: #E5E7EB;">Custom</span>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <input id="privateGameCheckbox" type="checkbox" class="w-4 h-4 rounded" style="background: #1F2937; border-color: #374151;">
                <label for="privateGameCheckbox" class="text-sm font-medium" style="color: #E5E7EB;">Private Game (won't appear in public games list)</label>
            </div>
            
            <div class="grid sm:grid-cols-2 gap-4 pt-4">
                <button id="createGameBtn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2" style="background-color: #9333ea; box-shadow: 0 0 15px 0 rgba(167, 139, 250, 0.6);">
                    <span class="material-symbols-outlined">add</span> Create New Game
                </button>
                <button id="joinGameBtn" class="w-full font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2" style="background: #374151; color: #E5E7EB;">
                    <span class="material-symbols-outlined">group</span> Join Game
                </button>
            </div>
        </div>

        <div class="my-6 flex items-center">
            <hr class="flex-grow border-t" style="border-color: #374151;">
            <span class="px-4" style="color: #9CA3AF;">OR</span>
            <hr class="flex-grow border-t" style="border-color: #374151;">
        </div>

        <!-- Public Games List -->
        <div class="space-y-4">
            <h3 class="text-lg font-semibold" style="color: #E5E7EB;">Public Games</h3>
            <div id="public-games-list" class="space-y-2 max-h-48 overflow-y-auto">
                <!-- Public games will be listed here -->
                <p class="text-sm" style="color: #9CA3AF;">Loading games...</p>
            </div>
            <button id="refreshGamesBtn" class="w-full font-bold py-2 px-4 rounded-lg transition duration-300 text-sm" style="background: #374151; color: #E5E7EB;">üîÑ Refresh List</button>
        </div>

        <div class="my-6 flex items-center">
            <hr class="flex-grow border-t" style="border-color: #374151;">
            <span class="px-4" style="color: #9CA3AF;">OR</span>
            <hr class="flex-grow border-t" style="border-color: #374151;">
        </div>

        <div class="space-y-4">
            <input id="gameIdInput" type="text" placeholder="Enter Game ID" class="w-full px-4 py-3 border rounded-lg" style="background: #1F2937; border-color: #374151; color: #E5E7EB;">
            <button id="joinGameBtn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300" style="background-color: #00F5D4; color: #030712; box-shadow: 0 0 15px 0 rgba(0, 245, 212, 0.5);">Join Game</button>
        </div>
        <p id="lobby-error" class="text-red-500 mt-4 h-4"></p>
    </div>

    <!-- Game Settings Screen (Host Only) -->
    <div id="game-settings" class="hidden w-full max-w-4xl p-8 rounded-xl shadow-2xl overflow-y-auto border" style="max-height: 90vh; background: #161523; border-color: #2A283E; color: #E5E7EB;">
        <h2 class="text-3xl font-bold mb-2 uppercase tracking-wider" style="color: #A78BFA; text-shadow: 0 0 8px rgba(167, 139, 250, 0.7);">Game Settings</h2>
        <div class="mb-6">
            <p style="color: #9CA3AF;">Share this Game ID with your friends:</p>
            <div class="flex items-center gap-2 mt-2">
                 <p id="displayGameId" class="text-2xl font-mono p-3 rounded-lg" style="background: #0D0C14; border: 1px solid #2A283E; color: #ffffff;"></p>
                 <button id="copyGameIdBtn" class="p-3 rounded-lg transition" style="background: #1F2937; color: #E5E7EB;">
                    <span class="material-symbols-outlined">content_copy</span>
                 </button>
            </div>
            <div class="mt-3">
                <p class="text-sm" style="color: #9CA3AF;">Or share this direct link:</p>
                <div class="flex items-center gap-2 mt-1">
                    <input id="gameLinkInput" type="text" readonly class="flex-1 text-sm font-mono p-2 rounded border" onclick="this.select()" style="background: #0D0C14; border-color: #2A283E; color: #9CA3AF;">
                    <button id="copyLinkBtn" class="text-white px-3 py-2 rounded text-sm transition" style="background-color: #9333ea; box-shadow: 0 0 10px 0 rgba(167, 139, 250, 0.5);">
                        Copy Link
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium mb-2" style="color: #C4B5FD;">Game Mode</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="classic" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">üé≤ Classic</div>
                    <div class="text-xs" style="color: #9CA3AF;">Traditional rules</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="fast" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">‚ö° Fast Money</div>
                    <div class="text-xs" style="color: #9CA3AF;">2x money, 2x GO</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="hard" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">üî• Hard Mode</div>
                    <div class="text-xs" style="color: #9CA3AF;">Less money, more tax</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="noluck" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">üö´ No Luck</div>
                    <div class="text-xs" style="color: #9CA3AF;">No chance/chest cards</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="mega" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">üíé Mega Rich</div>
                    <div class="text-xs" style="color: #9CA3AF;">5x starting money</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg transition" data-mode="speed" style="background: #0D0C14; border-color: #2A283E; color: #E5E7EB;">
                    <div class="font-bold">üèÉ Speed Game</div>
                    <div class="text-xs" style="color: #9CA3AF;">Half properties</div>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="startingMoney" class="block text-sm font-medium" style="color: #9CA3AF;">Starting Money</label>
                <input type="number" id="startingMoney" value="1500" class="mt-1 block w-full px-3 py-2 border rounded-md" style="background: #0D0C14; border-color: #2A283E; color: #ffffff;">
            </div>
            <div>
                <label for="passGoAmount" class="block text-sm font-medium" style="color: #9CA3AF;">Pass "GO" Amount</label>
                <input type="number" id="passGoAmount" value="200" class="mt-1 block w-full px-3 py-2 border rounded-md" style="background: #0D0C14; border-color: #2A283E; color: #ffffff;">
            </div>
        </div>
        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="allowTrading" checked class="mr-2">
                <span class="text-sm font-medium" style="color: #ffffff;">Allow Player Trading</span>
            </label>
        </div>
        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="allowDoubles" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Allow Doubles Rule (Extra turn on doubles)</span>
            </label>
        </div>
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Map <span id="map-preview" class="text-xs text-blue-600 font-semibold ml-2"></span></label>
                    <div id="map-select" class="flex gap-2 flex-wrap">
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="classic">üèõÔ∏è Classic</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="turkey">üáπüá∑ T√ºrkiye</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="world">üåç World</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="holland">üá≥üá± Holland</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="megarich">üíé Mega Rich</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="custom">‚öôÔ∏è Custom</button>
                    </div>
                </div>
            </div>
                <label for="playerCount" class="block text-sm font-medium text-gray-700">Max Players</label>
                <input type="number" id="playerCount" value="4" min="2" max="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="auction-timer-container">
                <label for="auctionTimer" class="block text-sm font-medium text-gray-700">Auction Bid Timer (seconds)</label>
                <input type="number" id="auctionTimer" value="10" min="5" max="30" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="allow-trading-container" class="flex items-center mt-6">
                <input id="allowTrading" type="checkbox" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="allowTrading" class="ml-2 block text-sm text-gray-900">Allow Trading</label>
            </div>
        </div>

        <h3 id="customize-board-title" class="text-xl font-bold mb-4 text-gray-700">Customize Board</h3>
        <div id="properties-editor" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto" style="max-height: 400px;">
            <!-- Property editors will be dynamically inserted here -->
        </div>
        
        <div id="lobby-controls" class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-700">Players in Lobby:</h3>
                    <div id="lobby-players-list" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div class="flex gap-2">
                    <button id="addBotBtn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-300">ü§ñ Add Bot</button>
                    <button id="startGameBtn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 text-lg disabled:bg-gray-400">Start Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-container" class="flex h-screen w-full p-4 gap-4" style="display: none; background-color: #0D0C14; background-image: radial-gradient(circle at 1px 1px, rgba(167, 139, 250, 0.1) 1px, transparent 0); background-size: 30px 30px; background-attachment: fixed;">
        
        <!-- LEFT SIDEBAR: Share + Advertisement + Chat -->
        <aside class="w-80 flex-shrink-0 flex flex-col gap-4">
            <!-- Share This Game -->
            <div class="rounded-lg p-4 flex flex-col gap-3 shadow-lg" style="background: #111827; border: 1px solid #374151;">
                <h2 class="text-lg font-bold" style="color: #ffffff;">Share This Game</h2>
                <div class="flex items-center">
                    <input id="game-link-input" class="flex-grow border rounded-l-md text-sm p-2" style="background: #030712; border-color: #374151; color: #E5E7EB;" readonly type="text" value=""/>
                    <button id="copy-game-link-btn" class="text-white p-2 rounded-r-md transition-opacity flex items-center gap-1" style="background-color: #9333ea;">
                        <span class="material-icons-outlined text-base">content_copy</span>
                        <span class="text-sm font-semibold">Copy</span>
                    </button>
                </div>
            </div>
            
            <!-- Advertisement -->
            <div class="rounded-lg p-4 flex flex-col justify-center items-center text-center h-48 shadow-lg" style="background: #111827; border: 1px solid #374151;">
                <span class="font-semibold" style="color: #9CA3AF;">Advertisement</span>
                <p class="text-xs mt-1" style="color: #6B7280;">Holo-Ads Integrated</p>
            </div>
            
            <!-- Chat -->
            <div class="rounded-lg p-4 flex flex-col flex-grow shadow-lg" style="background: #111827; border: 1px solid #374151;">
                <h2 class="text-lg font-bold mb-3" style="color: #ffffff;">System Chat</h2>
                <div id="chat-messages" class="flex-grow space-y-2 text-sm overflow-y-auto" style="color: #9CA3AF;">
                    <p><span class="font-bold text-cyan-500">SYSTEM:</span> Game initialized. Waiting for players...</p>
                </div>
                <div class="mt-4 flex items-center">
                    <input id="chat-input" class="flex-grow border rounded-l-md text-sm p-2" style="background: #030712; border-color: #374151; color: #E5E7EB;" placeholder="Say something..." type="text"/>
                    <button id="send-chat-btn" class="text-white p-2 rounded-r-md transition-opacity" style="background-color: #9333ea;">
                        <span class="material-icons-outlined text-base">send</span>
                    </button>
                </div>
                
                <!-- Voice Chat Controls -->
                <div class="mt-3 flex gap-2">
                    <button id="join-voice-btn" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all" style="background: #00F5D4; color: #0D0C14;">
                        <span class="material-icons-outlined text-sm">mic</span>
                        <span>Join Voice</span>
                    </button>
                    <button id="leave-voice-btn" class="hidden flex-1 flex items-center justify-center gap-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all" style="background: #DC2626; color: #ffffff;">
                        <span class="material-icons-outlined text-sm">call_end</span>
                        <span>Leave</span>
                    </button>
                    <button id="toggle-mic-btn" class="hidden flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold transition-all" style="background: #374151; color: #E5E7EB;">
                        <span class="material-icons-outlined text-sm">mic_off</span>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- CENTER: Board -->
        <main class="flex-grow flex items-center justify-center overflow-auto">
            <div class="w-fit h-fit p-2 rounded-xl shadow-2xl" style="background: #111827; border: 1px solid #374151;">
                <div id="board" class="board">
                    <div class="center-board">
                        <div class="absolute top-0 left-0 right-0 h-1 shadow-glow" style="background-color: #9333ea; box-shadow: 0 0 15px 0 rgba(167, 139, 250, 0.6);"></div>
                        <h1 id="board-title" class="text-4xl font-bold tracking-widest" style="color: #9333ea;">DEEPPIXEL</h1>
                        
                        <!-- 3D Dice Display - Animation Container -->
                        <div id="dice-animation-container" class="absolute inset-0 flex items-center justify-center pointer-events-none" style="z-index: 1000;">
                            <!-- El elementleri -->
                            <div id="dice-hand-1" class="dice-hand">ü§ö</div>
                            <div id="dice-hand-2" class="dice-hand">ü§ö</div>
                            <div id="dice-wrapper-3d" class="flex gap-4" style="transform-style: preserve-3d;">
                                <div id="dice-3d-1" class="dice-3d-container"></div>
                                <div id="dice-3d-2" class="dice-3d-container"></div>
                            </div>
                        </div>
                        
                        <!-- Dice Display (Static) -->
                        <div id="dice-container" class="flex gap-4">
                            <div id="dice1" class="flex items-center justify-center font-bold text-4xl rounded-xl shadow-lg" style="width: 80px; height: 80px; background: #ffffff; color: #000; border: 3px solid #374151;">?</div>
                            <div id="dice2" class="flex items-center justify-center font-bold text-4xl rounded-xl shadow-lg" style="width: 80px; height: 80px; background: #ffffff; color: #000; border: 3px solid #374151;">?</div>
                        </div>
                        
                        <p id="turn-info" class="text-lg font-semibold" style="color: #E5E7EB;">It's <span class="font-bold" style="color: #9333ea;">your</span> turn to roll.</p>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col w-full max-w-sm gap-2">
                            <button id="rollDiceBtn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-opacity shadow-lg flex items-center justify-center gap-2" style="background-color: #9333ea; box-shadow: 0 0 15px 0 rgba(167, 139, 250, 0.6);">
                                <span class="material-icons-outlined">casino</span>
                                Roll Dice
                            </button>
                            <button id="managePropertiesBtn" class="w-full text-white font-bold py-2 px-4 rounded-lg transition-opacity flex items-center justify-center gap-2" style="background-color: #6B7280;">
                                <span class="material-icons-outlined">business_center</span>
                                Manage Properties
                            </button>
                            <button id="endTurnBtn" class="end-turn-btn w-full text-white font-bold py-3 px-4 rounded-lg transition-opacity shadow-lg flex items-center justify-center gap-2" style="background-color: #1F2937; position: relative; overflow: hidden;">
                                <span class="material-icons-outlined">skip_next</span>
                                End Turn
                            </button>
                        </div>
                        
                        <div class="absolute bottom-0 left-0 right-0 h-1 shadow-glow" style="background-color: #9333ea; box-shadow: 0 0 15px 0 rgba(167, 139, 250, 0.6);"></div>
                    </div>
                    <!-- Board spaces will be dynamically inserted here -->
                </div>
            </div>
        </main>
        
        <!-- RIGHT SIDEBAR: Players + Game Settings -->
        <aside class="w-80 flex-shrink-0 flex flex-col gap-4">
            <!-- Players List -->
            <div class="rounded-lg p-4 flex flex-col gap-3 shadow-lg" style="background: #111827; border: 1px solid #374151;">
                <h2 class="text-lg font-bold" style="color: #ffffff;">Players (<span id="player-count">1</span>/4)</h2>
                <div id="players-info" class="space-y-3">
                    <!-- Player cards will be dynamically added here -->
                </div>
            </div>
            
            <!-- Game Settings -->
            <div class="rounded-lg p-4 flex flex-col gap-3 shadow-lg" style="background: #111827; border: 1px solid #374151;">
                <h2 class="text-lg font-bold mb-2" style="color: #ffffff;">Game Controls</h2>
                
                <!-- Team Manager Button -->
                <button id="teamManagerBtn" class="w-full flex items-center gap-2 px-4 py-3 rounded-lg font-semibold transition-all" style="background: #9333ea; color: #ffffff;">
                    <span class="material-icons-outlined">groups</span>
                    <span>Team Manager</span>
                </button>
                
                <!-- Joker Cards Button -->
                <button id="jokerCardsBtn" class="w-full flex items-center gap-2 px-4 py-3 rounded-lg font-semibold transition-all" style="background: #00F5D4; color: #0D0C14;">
                    <span class="material-icons-outlined">style</span>
                    <span>Joker Cards</span>
                </button>
                
                <!-- Take Credit Button -->
                <button id="takeCreditBtn" class="w-full flex items-center gap-2 px-4 py-3 rounded-lg font-semibold transition-all" style="background: #F59E0B; color: #ffffff;">
                    <span class="material-icons-outlined">credit_card</span>
                    <span>Take Credit</span>
                </button>
                
                <!-- Trade Button -->
                <button id="viewTradesBtn" class="w-full flex items-center gap-2 px-4 py-3 rounded-lg font-semibold transition-all" style="background: #374151; color: #E5E7EB;">
                    <span class="material-icons-outlined">swap_horiz</span>
                    <span>Trade</span>
                </button>
            </div>
            
            <!-- Game Log -->
            <div class="rounded-lg p-4 flex flex-col gap-2 shadow-lg flex-grow overflow-hidden" style="background: #111827; border: 1px solid #374151;">
                <h2 class="text-lg font-bold" style="color: #ffffff;">Game Log</h2>
                <div id="game-log" class="overflow-y-auto flex-grow text-sm space-y-1" style="max-height: 300px; color: #9CA3AF;">
                    <!-- Game log entries will be added here -->
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Hidden elements for game functionality -->
    <div style="display: none;">
        <div id="mobile-controls-bar"></div>
    </div>
    
    <!-- üè° Property Buy Panel - Floating on Board -->
    <div id="property-buy-panel" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-2xl shadow-2xl p-6 z-40 max-w-md w-full border-4" style="background: #111827; border-color: #9333ea;">
        <div class="text-center">
            <h3 id="property-buy-title" class="text-2xl font-bold mb-2" style="color: #A78BFA;">üè° Buy Property</h3>
            <p id="property-buy-name" class="text-xl font-semibold mb-4" style="color: #E5E7EB;"></p>
            <p id="property-buy-desc" class="text-sm mb-6" style="color: #9CA3AF;"></p>
            
            <!-- Share Options -->
            <div id="property-buy-options" class="space-y-3">
                <!-- Options will be added dynamically -->
            </div>
            
            <button id="property-buy-close" class="mt-4 text-white px-6 py-2 rounded-lg font-bold" style="background: #6B7280;">Close</button>
        </div>
    </div>
    
    <!-- üí¨ Chat Panel - Now in sidebar, this is backup -->
    <div id="chat-panel" class="hidden"></div>
        
        <!-- Game Management Modal -->
        <div id="game-management-modal" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 z-50 max-w-2xl w-full border-4 border-purple-500 max-h-[90vh] overflow-y-auto">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4 text-purple-700">üéÆ Game Management</h3>
                <p class="text-sm text-gray-600 mb-4">Only the host can use these controls</p>
                <div id="game-management-players" class="space-y-3">
                    <!-- Players will be added here -->
                </div>
                <button onclick="hideGameManagementModal()" class="mt-6 bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 font-bold transition shadow-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Generic Modal -->
    <div id="modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center transform scale-95">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Modal Title</h3>
            <div id="modal-body" class="text-gray-600 mb-6">Modal body text goes here.</div>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <!-- Buttons will be added here -->
            </div>
        </div>
    </div>


    <script>
        // Oyun i√ßi men√ºde olup olmadƒ±ƒüƒ±nƒ± kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu deƒüi≈ükenini kendi oyun i√ßi men√º kontrol√ºn√ºzle deƒüi≈ütirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu deƒüi≈ütiƒüinde bu fonksiyonu √ßaƒüƒ±rƒ±n
        // √∂rn: updateMobileGameActions();
        // Oyun i√ßi men√ºde olup olmadƒ±ƒüƒ±nƒ± kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu deƒüi≈ükenini kendi oyun i√ßi men√º kontrol√ºn√ºzle deƒüi≈ütirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu deƒüi≈ütiƒüinde bu fonksiyonu √ßaƒüƒ±rƒ±n
        // √∂rn: updateMobileGameActions();
        // Oyun i√ßi men√ºde olup olmadƒ±ƒüƒ±nƒ± kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu deƒüi≈ükenini kendi oyun i√ßi men√º kontrol√ºn√ºzle deƒüi≈ütirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu deƒüi≈ütiƒüinde bu fonksiyonu √ßaƒüƒ±rƒ±n
        // √∂rn: updateMobileGameActions();
        // Mobile controls bar logic
        function updateMobileControlsBar() {
            const mobileBar = document.getElementById('mobile-controls-bar');
            const gameContainer = document.getElementById('game-container');
            if (window.innerWidth <= 900 && gameContainer && !gameContainer.classList.contains('hidden')) {
                mobileBar.classList.remove('hidden');
            } else {
                mobileBar.classList.add('hidden');
            }
        }
        window.addEventListener('resize', updateMobileControlsBar);
        window.addEventListener('DOMContentLoaded', updateMobileControlsBar);
        // Button event bindings (with null checks)
        const managePropertiesBtnMobile = document.getElementById('managePropertiesBtnMobile');
        const takeCreditBtnMobile = document.getElementById('takeCreditBtnMobile');
        const teamManagerBtnMobile = document.getElementById('teamManagerBtnMobile');
        const jokerCardsBtnMobile = document.getElementById('jokerCardsBtnMobile');
        
        if (managePropertiesBtnMobile) managePropertiesBtnMobile.onclick = () => document.getElementById('managePropertiesBtn').click();
        if (takeCreditBtnMobile) takeCreditBtnMobile.onclick = () => document.getElementById('takeCreditBtn').click();
        if (teamManagerBtnMobile) teamManagerBtnMobile.onclick = () => document.getElementById('teamManagerBtn').click();
        if (jokerCardsBtnMobile) jokerCardsBtnMobile.onclick = () => document.getElementById('jokerCardsBtn').click();
        
        // Modal toggle state tracking
        let lastOpenedModal = null;
        let lastOpenedButton = null;
        
        // Mobil oyun kontrol butonlarƒ± i√ßin toggle event listener'lar
        document.getElementById('mobile-roll-btn').onclick = () => document.getElementById('rollDiceBtn').click();
        
        document.getElementById('mobile-properties-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('managePropertiesBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-joker-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('jokerCardsBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-team-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('teamManagerBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-end-turn-btn').onclick = () => document.getElementById('endTurnBtn').click();
        
        // === WEBSOCKET CONNECTION ===
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let connectionStatus = 'disconnected'; // 'connected', 'connecting', 'disconnected'

        function connectWebSocket() {
            if (connectionStatus === 'connecting') return;
            
            connectionStatus = 'connecting';
            updateConnectionIndicator();
            
            // Allow overriding the WebSocket URL by including a small `ws-config.js`
            // that sets `window.WS_URL = 'wss://your-server.example.com';`
            const configuredWsUrl = (typeof window !== 'undefined' && window.WS_URL) ? window.WS_URL : null;
            let wsUrl;
            if (configuredWsUrl) {
                wsUrl = configuredWsUrl;
                console.log('üîå Using configured WS URL from ws-config.js:', wsUrl);
                addDebugLog('üîå WS URL (configured): ' + wsUrl);
            } else {
                // If we're hosted on a static host like Netlify and no WS_URL is configured,
                // do not attempt to connect to a WebSocket on the static host (it won't exist).
                const isLikelyStaticHost = (typeof window !== 'undefined' && window.location && window.location.hostname && (window.location.hostname.includes('netlify.app') || window.location.hostname.includes('vercel.app') || window.location.hostname === '')); 
                if (isLikelyStaticHost) {
                    console.warn('‚ö†Ô∏è No WebSocket backend configured and site appears to be on a static host. Multiplayer (WebSocket) is disabled.');
                    addDebugLog('‚ö†Ô∏è No WS backend configured ‚Äî multiplayer disabled');
                    // Show a small on-page notice for users
                    let notice = document.getElementById('ws-no-backend-notice');
                    if (!notice) {
                        notice = document.createElement('div');
                        notice.id = 'ws-no-backend-notice';
                        notice.style.cssText = 'position:fixed;top:12px;right:12px;background:#fffbeb;color:#92400e;padding:10px 14px;border:1px solid #f59e0b;border-radius:8px;z-index:10001;box-shadow:0 6px 20px rgba(0,0,0,0.12);font-weight:600;';
                        notice.innerHTML = 'Multiplayer disabled ‚Äî no WebSocket server configured. See README for deploy options.';
                        document.body.appendChild(notice);
                    }
                    connectionStatus = 'disconnected';
                    updateConnectionIndicator();
                    return; // Don't attempt to create a WebSocket
                }

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host || 'localhost:8000';
                wsUrl = `${protocol}//${host}`;
                console.log('üîå Connecting to WebSocket (fallback):', wsUrl);
                console.log('üìç Protocol:', protocol);
                console.log('üìç Host:', host);
                addDebugLog('üîå WS URL: ' + wsUrl);
            }
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected successfully!');
                console.log('üîå WebSocket URL:', wsUrl);
                console.log('üîå ReadyState:', ws.readyState);
                addDebugLog('‚úÖ WS CONNECTED!');
                reconnectAttempts = 0;
                connectionStatus = 'connected';
                updateConnectionIndicator();
                
                // üîÑ Auto-reconnect to previous game if stored
                const storedGameId = localStorage.getItem('monopolyCurrentGameId');
                const storedPlayerId = localStorage.getItem('monopolyPlayerId');
                if (storedGameId && storedPlayerId && !currentGameId) {
                    console.log('üîÑ Auto-reconnecting to game:', storedGameId);
                    currentGameId = storedGameId;
                    localPlayer.id = storedPlayerId;
                    sendMessage({
                        type: 'get_game',
                        gameId: storedGameId,
                        playerId: storedPlayerId
                    });
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };

            ws.onclose = (event) => {
                connectionStatus = 'disconnected';
                updateConnectionIndicator();
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        connectWebSocket();
                    }, 2000);
                } else {
                    alert('Connection lost. Please refresh the page to reconnect.');
                }
            };

            ws.onerror = (error) => {
                connectionStatus = 'disconnected';
                updateConnectionIndicator();
            };
        }

        function updateConnectionIndicator() {
            // Create connection indicator if it doesn't exist
            let indicator = document.getElementById('connection-status');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'connection-status';
                indicator.style.cssText = 'position: fixed; top: 10px; left: 10px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: bold; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.3s; max-width: 200px; text-align: center; cursor: pointer;';
                document.body.appendChild(indicator);
                
                // Toggle debug log on click
                indicator.addEventListener('click', () => {
                    const debugLog = document.getElementById('debug-log');
                    if (debugLog) {
                        debugLog.style.display = 'none';
                    }
                });
            }
            
            // Create debug log display
            let debugLog = document.getElementById('debug-log');
            if (!debugLog) {
                debugLog = document.createElement('div');
                debugLog.id = 'debug-log';
                debugLog.style.cssText = 'position: none; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); color: #0f0; padding: 0px; font-size: 1px; font-family: monospace; max-height: 2px; overflow-y: auto; z-index: 999999; display: none; border-top: 0px solid #0f0;';
                document.body.appendChild(debugLog);
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úï Close';
                closeBtn.style.cssText = 'position: sticky; top: 0; right: 0; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; float: right; z-index: 10000;';
                closeBtn.onclick = () => { debugLog.style.display = 'none'; };
                debugLog.appendChild(closeBtn);
            }
            
            if (connectionStatus === 'connected') {
                indicator.textContent = 'üü¢ Connected';
                indicator.style.backgroundColor = '#10b981';
                indicator.style.color = 'white';
                console.log('üü¢ Status: Connected');
                addDebugLog('üü¢ CONNECTED');
            } else if (connectionStatus === 'connecting') {
                indicator.textContent = 'üü° Connecting...';
                indicator.style.backgroundColor = '#f59e0b';
                indicator.style.color = 'white';
                console.log('üü° Status: Connecting...');
                addDebugLog('üü° CONNECTING...');
            } else {
                indicator.textContent = 'üî¥ Disconnected';
                indicator.style.backgroundColor = '#ef4444';
                indicator.style.color = 'white';
                console.log('üî¥ Status: Disconnected');
                addDebugLog('üî¥ DISCONNECTED');
            }
        }
        
        /*
        // üêõ DEBUG LOG FUNCTION - Uncomment if needed
        function addDebugLog(message) {
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                const time = new Date().toLocaleTimeString();
                debugLog.innerHTML += `<div>${time}: ${message}</div>`;
                debugLog.scrollTop = debugLog.scrollHeight;
                
                const lines = debugLog.querySelectorAll('div');
                if (lines.length > 20) {
                    lines[0].remove();
                }
            }
        }
        */
        
        // Dummy function to prevent errors
        function addDebugLog(message) {
            // Debug disabled - uncomment code above to enable
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.error('‚ùå Cannot send message - WebSocket not connected');
                alert('Connection lost. Please wait while we reconnect...');
                connectWebSocket();
            }
        }

        // ‚è∞ Aktivite ping g√∂nder (her aktivitede √ßaƒürƒ±lƒ±r)
        function sendActivityPing() {
            if (currentGameId && gameData && gameData.state === 'playing') {
                sendMessage({
                    type: 'activity_ping',
                    gameId: currentGameId
                });
            }
        }
        
        // ‚è∞ ƒ∞naktivite uyarƒ±sƒ± handler (sadece host i√ßin)
        let inactivityWarningTimer = null;
        let inactivityWarningCountdown = null;
        function handleInactivityWarning(timeLeft) {
            if (gameData.hostId !== localPlayer.id) return; // Sadece host i√ßin
            
            // Countdown ba≈ülat
            let secondsLeft = Math.floor(timeLeft / 1000);
            
            const modalHTML = `
                <div class="text-center">
                    <p class="text-6xl mb-4">‚è∞</p>
                    <p class="text-2xl font-bold text-red-600 mb-4">OYUN ƒ∞NAKTƒ∞F!</p>
                    <p class="mb-4">300 saniye boyunca hi√ßbir aktivite olmadƒ±.</p>
                    <p class="mb-2 text-lg">Kalan s√ºre:</p>
                    <p id="inactivity-countdown" class="text-4xl font-bold text-red-600 mb-4">${secondsLeft}</p>
                    <p class="text-sm text-gray-600">Devam etmek istiyor musunuz?</p>
                </div>
            `;
            
            // Countdown timer
            inactivityWarningCountdown = setInterval(() => {
                secondsLeft--;
                const countdownEl = document.getElementById('inactivity-countdown');
                if (countdownEl) {
                    countdownEl.textContent = secondsLeft;
                }
                if (secondsLeft <= 0) {
                    clearInterval(inactivityWarningCountdown);
                }
            }, 1000);
            
            showModal('‚è∞ Oyun ƒ∞naktif', modalHTML, [
                {
                    text: '‚úÖ Devam Et',
                    class: 'bg-green-600 hover:bg-green-700',
                    action: () => {
                        clearInterval(inactivityWarningCountdown);
                        inactivityWarningTimer = null;
                        sendMessage({
                            type: 'inactivity_response',
                            gameId: currentGameId,
                            continueGame: true
                        });
                        hideModal();
                    }
                },
                {
                    text: '‚ùå Oyunu Bitir',
                    class: 'bg-red-600 hover:bg-red-700',
                    action: () => {
                        clearInterval(inactivityWarningCountdown);
                        inactivityWarningTimer = null;
                        sendMessage({
                            type: 'inactivity_response',
                            gameId: currentGameId,
                            continueGame: false
                        });
                        hideModal();
                    }
                }
            ], true); // Persistent modal
            
            // 30 saniye sonra otomatik kapan (eƒüer yanƒ±t verilmezse)
            inactivityWarningTimer = setTimeout(() => {
                if (inactivityWarningTimer) {
                    clearInterval(inactivityWarningCountdown);
                    sendMessage({
                        type: 'inactivity_response',
                        gameId: currentGameId,
                        continueGame: false
                    });
                    hideModal();
                    inactivityWarningTimer = null;
                }
            }, timeLeft);
        }

        function handleServerMessage(message) {
            switch(message.type) {
                case 'game_created':
                    currentGameId = message.gameId;
                    gameData = message.game;
                    
                    // üîÑ Save session to localStorage for F5 protection
                    localStorage.setItem('monopolyCurrentGameId', currentGameId);
                    localStorage.setItem('monopolyPlayerId', localPlayer.id);
                    
                    // Re-enable create button
                    createGameBtn.disabled = false;
                    createGameBtn.textContent = 'Create New Game';
                    lobbyError.textContent = '‚úÖ Game created!';
                    lobbyError.style.color = 'green';
                    
                    showGameSettings();
                    break;
                    
                case 'game_joined':
                    currentGameId = message.gameId;
                    gameData = message.game;
                    
                    // üîÑ Save session to localStorage for F5 protection
                    localStorage.setItem('monopolyCurrentGameId', currentGameId);
                    localStorage.setItem('monopolyPlayerId', localPlayer.id);
                    
                    // Re-enable join button
                    joinGameBtn.disabled = false;
                    joinGameBtn.textContent = 'Join Game';
                    
                    // Check if this is a reconnection
                    if (message.reconnected) {
                        lobbyError.textContent = 'üîÑ Reconnected successfully!';
                        lobbyError.style.color = 'green';
                        console.log('üîÑ Successfully reconnected to game');
                        
                        // If game is already playing, show game screen
                        if (gameData.state === 'playing') {
                            showGame();
                            setTimeout(() => {
                                renderBoard();
                                updateGameUI();
                            }, 100);
                        } else {
                            showWaitingLobby();
                        }
                    } else {
                        lobbyError.textContent = '‚úÖ Joined successfully!';
                        lobbyError.style.color = 'green';
                        showWaitingLobby();
                    }
                    break;
                    
                case 'inactivity_warning':
                    // ‚è∞ ƒ∞naktivite uyarƒ±sƒ± (sadece host i√ßin)
                    if (gameData && gameData.hostId === localPlayer.id) {
                        handleInactivityWarning(message.timeLeft);
                    }
                    break;
                    
                case 'game_state':
                    // Reconnection i√ßin game state
                    currentGameId = message.gameId || currentGameId;
                    gameData = message.game;
                    
                    if (!gameData || !gameData.settings) {
                        console.error('Invalid game data received:', gameData);
                        return;
                    }
                    
                    // Game state g√ºncellemesi - game_updated ile aynƒ± i≈ülemi yap
                    const oldGameDataForState = gameData;
                    if (gameData.state === 'playing' && gameContainer.classList.contains('hidden')) {
                        showGame();
                        setTimeout(() => {
                            renderBoard();
                            updateGameUI();
                        }, 100);
                    } else {
                        updateGameUI();
                    }
                    break;
                    
                case 'game_updated':
                    const oldGameData = gameData;
                    gameData = message.game;
                    
                    if (!gameData || !gameData.settings) {
                        console.error('Invalid game data received:', gameData);
                        return;
                    }
                    
                    // üîÑ Manage Properties modal'ƒ± a√ßƒ±ksa g√ºncelle
                    if (!modal.classList.contains('hidden') && modalTitle.textContent.includes('Manage Properties')) {
                        // Kƒ±sa bir delay ile modal'ƒ± g√ºncelle (gameData g√ºncellendikten sonra)
                        setTimeout(() => {
                            refreshManagePropertiesModal();
                        }, 100);
                    }
                    
                    // üìä Kare ziyaret istatistiklerini ba≈ülat (eƒüer yoksa)
                    if (gameData.state === 'playing' && gameData.settings.board && !gameData.spaceVisits) {
                        gameData.spaceVisits = new Array(gameData.settings.board.length).fill(0);
                    }
                    
                    // üîÑ Save session data whenever game updates
                    if (gameData.state === 'playing' && localPlayer.id) {
                        localStorage.setItem('monopolyCurrentGameId', currentGameId);
                        localStorage.setItem('monopolyPlayerId', localPlayer.id);
                        
                        // Save additional player info for better reconnection
                        const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
                        if (myPlayer) {
                            localStorage.setItem('monopolyPlayerMoney', myPlayer.money);
                            localStorage.setItem('monopolyPlayerPosition', myPlayer.position);
                        }
                    }
                    
                    // Ensure all players have joker cards and secret trades
                    if (gameData && gameData.players) {
                        gameData.players = gameData.players.map(player => {
                            if (!player.jokerCards) {
                                player.jokerCards = {
                                    steal: 1,
                                    skip: 1,
                                    reroll: 1
                                };
                            }
                            if (player.secretTradesAvailable === undefined) {
                                player.secretTradesAvailable = 3;
                            }
                            return player;
                        });
                    }
                    
                    if (gameData.state === 'lobby') {
                        updateLobbyUI();
                        if(gameData.hostId !== localPlayer.id) {
                            showWaitingLobby();
                        } else {
                            showGameSettings();
                        }
                    } else if (gameData.state === 'playing') {
                        if (gameContainer.classList.contains('hidden')) {
                            showGame();
                            setTimeout(() => {
                                renderBoard();
                                updateGameUI();
                            }, 100);
                        } else {
                            updateGameUI();
                        }
                        
                        // ü§ù Check for pending trades
                        if (gameData.trades && gameData.trades.length > 0) {
                            checkPendingTrades();
                        }
                        
                        // ü§ù Check for partnership requests
                        if (gameData.partnershipRequests && gameData.partnershipRequests.length > 0) {
                            checkPartnershipRequests();
                        }
                        
                        // ‚ùå Check for declined partnership requests
                        if (gameData.declinedPartnershipRequests && gameData.declinedPartnershipRequests.length > 0) {
                            checkDeclinedPartnerships(oldGameData);
                        }
                        
                        // Check for active auction
                        if (gameData.auction && gameData.auction.active) {
                            const auctionChanged = !oldGameData || !oldGameData.auction || 
                                                  JSON.stringify(oldGameData.auction) !== JSON.stringify(gameData.auction);
                            
                            // Start timer if auction just started
                            if (auctionChanged && !auctionTimerInterval) {
                                auctionTimerInterval = setInterval(updateAuctionTimer, 1000);
                            }
                            
                            // Bot auction bidding logic - Botlar kendi adlarƒ±na bid veriyor
                            if (auctionChanged && gameData.players[gameData.currentPlayerIndex].isBot && 
                                gameData.auction.playersInAuction.includes(gameData.players[gameData.currentPlayerIndex].id)) {
                                // Bot should bid if current bid is less than property price
                                const space = gameData.settings.board[gameData.auction.position];
                                const currentBid = gameData.auction.currentBid;
                                const botPlayer = gameData.players[gameData.currentPlayerIndex];
                                
                                // Bot kendi ID'si ile bid vermeli
                                const botId = botPlayer.id;
                                
                                // Can bid if not the last bidder
                                if (gameData.auction.lastBidder !== botId && 
                                    currentBid < space.price && 
                                    botPlayer.money > currentBid + 10) {
                                    // Bot bids up to the original price
                                    const bidAmount = Math.min(currentBid + Math.floor(Math.random() * 20) + 10, space.price, botPlayer.money - 1);
                                    if (bidAmount > currentBid) {
                                        setTimeout(() => {
                                            // Bot kendi ID'si ile bid veriyor
                                            placeBid(bidAmount, botId);
                                        }, 1000 + Math.random() * 1000); // Random delay 1-2 seconds
                                    }
                                }
                            }
                            
                            if (auctionChanged && gameData.auction.playersInAuction.includes(localPlayer.id)) {
                                showAuctionModal();
                            }
                        } else {
                            // Auction ended - close modal for everyone
                            if (oldGameData && oldGameData.auction && oldGameData.auction.active) {
                                hideModal();
                            }
                            
                            // Clear timer if auction ended
                            if (auctionTimerInterval) {
                                clearInterval(auctionTimerInterval);
                                auctionTimerInterval = null;
                            }
                        }
                        
                        // Check for incoming trade offer
                        if (gameData.trade && gameData.trade.toId === localPlayer.id && 
                            (!oldGameData || JSON.stringify(oldGameData.trade) !== JSON.stringify(gameData.trade))) {
                            // Trade popup otomatik g√∂sterilmeyecek eƒüer "decide later" denmi≈ü ise
                            const tradeId = gameData.trade.id || JSON.stringify(gameData.trade);
                            if (!decidedLaterTrades.includes(tradeId) && !shownTradeIds.has(tradeId)) {
                                shownTradeIds.add(tradeId);
                                showTradeOfferModal();
                            }
                        }
                    }
                    
                    // ü§ñ Bot AI - if current player is a bot, make it move automatically
                    if (gameData.state === 'playing' && gameData.players && gameData.players[gameData.currentPlayerIndex] && 
                        gameData.players[gameData.currentPlayerIndex].id.startsWith('bot_') && 
                        gameData.players[gameData.currentPlayerIndex].id !== localPlayer.id &&
                        !window.isBotTurnInProgress) {
                        window.isBotTurnInProgress = true;
                        setTimeout(() => botTurn(), 1500); // Delay for better UX
                    }
                    
                    break;
                    
                case 'game_started':
                    gameData = message.game;
                    console.log('‚úÖ Game started, rendering board...');
                    
                    // Ensure all players have joker cards
                    if (gameData && gameData.players) {
                        gameData.players = gameData.players.map(player => {
                            if (!player.jokerCards) {
                                player.jokerCards = {
                                    steal: 1,
                                    skip: 1,
                                    reroll: 1
                                };
                            }
                            if (player.secretTradesAvailable === undefined) {
                                player.secretTradesAvailable = 3;
                            }
                            return player;
                        });
                    }
                    
                    showGame();
                    setTimeout(() => {
                        renderBoard();
                        updateGameUI();
                    }, 100);
                    break;
                    
                case 'chat_message':
                    if (message.playerName !== localPlayer.name) {
                        addChatMessage(message.playerName, message.text);
                    }
                    break;
                
                case 'voice_join':
                    // Another player joined voice chat
                    if (message.playerId !== localPlayer.id && isInVoice) {
                        console.log(`üé§ ${message.playerName} joined voice chat`);
                        addChatMessage('SYSTEM', `üé§ ${message.playerName} joined voice chat`, false);
                        // Create peer connection as initiator
                        createPeerConnection(message.playerId, true);
                    }
                    break;
                
                case 'voice_users':
                    // Received list of users already in voice chat
                    console.log('üé§ Users already in voice chat:', message.users);
                    if (isInVoice) {
                        // Connect to all existing voice users
                        message.users.forEach(userId => {
                            if (userId !== localPlayer.id && !peers[userId]) {
                                console.log(`üîó Connecting to existing voice user: ${userId}`);
                                createPeerConnection(userId, true);
                            }
                        });
                    }
                    break;
                    
                case 'voice_leave':
                    // Another player left voice chat
                    if (peers[message.playerId]) {
                        peers[message.playerId].destroy();
                        delete peers[message.playerId];
                        console.log(`üîá Player ${message.playerId} left voice chat`);
                    }
                    break;
                    
                case 'voice_signal':
                    // Received WebRTC signal from another player
                    if (message.to === localPlayer.id && isInVoice) {
                        console.log(`üì° Received signal from ${message.from}`);
                        
                        if (!peers[message.from]) {
                            // Create peer connection as non-initiator
                            createPeerConnection(message.from, false);
                        }
                        
                        // Process the signal
                        peers[message.from].signal(message.signal);
                    }
                    break;
                    
                case 'games_list':
                    displayPublicGames(message.games);
                    break;
                    
                case 'player_reconnected':
                    if (message.playerName) {
                        addLog(`üîÑ ${message.playerName} reconnected to the game`);
                        console.log(`üîÑ Player ${message.playerName} reconnected`);
                    }
                    break;
                    
                case 'error':
                    // Sadece √∂nemli hatalarƒ± g√∂ster, "Unknown message type" gibi tekrarlayan hatalarƒ± g√∂sterme
                    if (message.message && !message.message.includes('Unknown message type')) {
                    console.error('‚ùå Server error:', message.message);
                    lobbyError.textContent = message.message;
                    lobbyError.style.color = 'red';
                    
                    // Re-enable join button if it was disabled
                        if (joinGameBtn && joinGameBtn.disabled) {
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    }
                        if (createGameBtn && createGameBtn.disabled) {
                        createGameBtn.disabled = false;
                        createGameBtn.textContent = 'Create New Game';
                    }
                    
                        // √ñnemli hatalar i√ßin modal g√∂ster (lobby ekranƒ±ndaysa)
                        if (lobby && !lobby.classList.contains('hidden')) {
                            // Lobby ekranƒ±ndayken √∂nemli hatalarƒ± g√∂ster
                            if (!message.message.includes('Unknown message type')) {
                    showModal('Error', message.message, [{text:'OK', class:'bg-red-500', action:hideModal}]);
                            }
                        }
                    } else {
                        // "Unknown message type" gibi tekrarlayan hatalarƒ± sadece console'da logla
                        console.warn('‚ö†Ô∏è Ignored error message:', message.message);
                    }
                    break;
                    
                default:
                    // Bilinmeyen mesaj tipleri i√ßin sadece console'da logla, pop-up g√∂sterme
                    console.warn('‚ö†Ô∏è Unknown message type received:', message.type, message);
                    break;
            }
        }

        async function updateGame(updates) {
            // ‚è∞ Aktivite ping g√∂nder
            sendActivityPing();
            
            sendMessage({
                type: 'update_game',
                gameId: currentGameId,
                updates: updates
            });
        }

        // --- DOM ELEMENTS ---
        const lobby = document.getElementById('lobby');
        console.log('üöÄ JavaScript loading...');
        const gameSettingsScreen = document.getElementById('game-settings');
        const gameContainer = document.getElementById('game-container');
        
        const playerNameInput = document.getElementById('playerNameInput');
        const createGameBtn = document.getElementById('createGameBtn');
        console.log('üéØ createGameBtn:', createGameBtn);
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const lobbyError = document.getElementById('lobby-error');

        const displayGameId = document.getElementById('displayGameId');
        const copyGameIdBtn = document.getElementById('copyGameIdBtn');
        const propertiesEditor = document.getElementById('properties-editor');
        const startGameBtn = document.getElementById('startGameBtn');
        const lobbyPlayersList = document.getElementById('lobby-players-list');
        
        const board = document.getElementById('board');
        const playersInfo = document.getElementById('players-info');
        const rollDiceBtn = document.getElementById('rollDiceBtn');
        const endTurnBtn = document.getElementById('endTurnBtn');
        const managePropertiesBtn = document.getElementById('managePropertiesBtn');
        const jokerCardsBtn = document.getElementById('jokerCardsBtn');
        const dice1El = document.getElementById('dice1');
        const dice2El = document.getElementById('dice2');
        const gameLogEl = document.getElementById('game-log');

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalButtons = document.getElementById('modal-buttons');

        // Property Buy Panel Elements
        const propertyBuyPanel = document.getElementById('property-buy-panel');
        const propertyBuyTitle = document.getElementById('property-buy-title');
        const propertyBuyName = document.getElementById('property-buy-name');
        const propertyBuyDesc = document.getElementById('property-buy-desc');
        const propertyBuyOptions = document.getElementById('property-buy-options');
        const propertyBuyClose = document.getElementById('property-buy-close');

        // Prevent clicks inside modal content from bubbling to modal overlay
        modalContent.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // üé® Dark Mode System
        const darkModeToggle = document.getElementById('darkModeToggle');
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function applyDarkMode() {
            if (isDarkMode) {
                document.body.style.background = 'linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0f0f0f 100%)';
                board.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%)';
                board.style.borderColor = '#00ffff';
                board.style.boxShadow = '0 0 40px rgba(0, 255, 255, 0.5), 0 25px 80px rgba(0,0,0,0.8)';
                darkModeToggle.innerHTML = '‚òÄÔ∏è Light Mode';
                darkModeToggle.className = 'absolute top-4 right-4 bg-gradient-to-r from-yellow-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-yellow-600 hover:to-orange-700 transition-all shadow-lg text-sm font-bold z-20';
            } else {
                // Restore to current map theme
                applyMapTheme();
                darkModeToggle.innerHTML = 'üåô Dark Mode';
                darkModeToggle.className = 'absolute top-4 right-4 bg-gradient-to-r from-gray-700 to-gray-900 text-white px-4 py-2 rounded-lg hover:from-gray-800 hover:to-black transition-all shadow-lg text-sm font-bold z-20';
            }
        }
        
        if (darkModeToggle) {
            // Apply saved dark mode preference
            if (isDarkMode && gameData && gameData.state === 'playing') {
                applyDarkMode();
            }
            
            darkModeToggle.addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                applyDarkMode();
            });
        }

        // üì∏ Screenshot System
        const screenshotBtn = document.getElementById('screenshotBtn');
        if (screenshotBtn) {
            screenshotBtn.addEventListener('click', async () => {
                try {
                    // Use html2canvas library if available, otherwise use native approach
                    const boardElement = document.getElementById('board');
                    
                    // Simple canvas approach
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const rect = boardElement.getBoundingClientRect();
                    canvas.width = rect.width * 2; // Higher resolution
                    canvas.height = rect.height * 2;
                    ctx.scale(2, 2);
                    
                    // Draw background
                    const bgStyle = window.getComputedStyle(boardElement).background;
                    ctx.fillStyle = bgStyle || '#f5e6d3';
                    ctx.fillRect(0, 0, rect.width, rect.height);
                    
                    // Convert canvas to blob
                    canvas.toBlob(async (blob) => {
                        const url = URL.createObjectURL(blob);
                        
                        // Download the image
                        const link = document.createElement('a');
                        link.download = `monopoly-game-${Date.now()}.png`;
                        link.href = url;
                        link.click();
                        
                        // Also try to share if supported
                        if (navigator.share && navigator.canShare) {
                            try {
                                const file = new File([blob], 'monopoly-game.png', { type: 'image/png' });
                                if (navigator.canShare({ files: [file] })) {
                                    await navigator.share({
                                        title: 'üé≤ My Monopoly Game!',
                                        text: 'Check out my Monopoly game!',
                                        files: [file]
                                    });
                                }
                            } catch (shareError) {
                                console.log('Share cancelled or not supported');
                            }
                        }
                        
                        URL.revokeObjectURL(url);
                        showModal('üì∏ Screenshot Saved!', 'Your game screenshot has been downloaded!', [
                            { text: 'OK', class: 'bg-green-500', action: hideModal }
                        ]);
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Screenshot error:', error);
                    showModal('Error', 'Could not take screenshot. Try again!', [
                        { text: 'OK', class: 'bg-red-500', action: hideModal }
                    ]);
                }
            });
        }

        // --- GAME STATE ---
        let localPlayer = { id: '', name: '' };
        let currentGameId = null;
        let gameData = null;
        // Her oyuncu i√ßin √ßok belirgin ve farklƒ± renkler - 8 oyuncuya kadar benzersiz
        const playerColors = [
            '#EF4444',  // Parlak Kƒ±rmƒ±zƒ±
            '#3B82F6',  // Parlak Mavi
            '#10B981',  // Parlak Ye≈üil
            '#F59E0B',  // Parlak Turuncu
            '#8B5CF6',  // Parlak Mor
            '#EC4899',  // Parlak Pembe
            '#06B6D4',  // Parlak Cyan
            '#F97316'   // Parlak Koyu Turuncu
        ];
        let selectedGameMode = 'classic';
        let decidedLaterTrades = []; // Trade'ler i√ßin "decide later" takibi
        let shownTradeIds = new Set(); // G√∂sterilen trade ID'lerini takip et
        let turnTimer = null; // ‚è∞ Turn timer for auto-end turn
        let turnStartTime = null; // ‚è∞ Turn start time for countdown
        let turnUpdateInterval = null; // ‚è∞ Interval for updating board title

        // --- DEFAULT GAME DATA ---
        function getDefaultBoard() {
            return [
                { name: "GO", type: "go" },
                { name: "Mediterranean Ave", type: "property", price: 60, rent: [2, 10, 30, 90, 160, 250], color: "#a55a40", houseCost: 50 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Baltic Ave", type: "property", price: 60, rent: [4, 20, 60, 180, 320, 450], color: "#a55a40", houseCost: 50 },
                { name: "Income Tax", type: "tax", amount: 200 },
                { name: "Reading Railroad", type: "railroad", price: 200 },
                { name: "Oriental Ave", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], color: "#add8e6", houseCost: 50 },
                { name: "Chance", type: "chance" },
                { name: "Vermont Ave", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], color: "#add8e6", houseCost: 50 },
                { name: "Connecticut Ave", type: "property", price: 120, rent: [8, 40, 100, 300, 450, 600], color: "#add8e6", houseCost: 50 },
                { name: "Jail / Just Visiting", type: "jail" },
                { name: "St. Charles Place", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], color: "#d25298", houseCost: 100 },
                { name: "Electric Company", type: "utility", price: 150 },
                { name: "States Ave", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], color: "#d25298", houseCost: 100 },
                { name: "Virginia Ave", type: "property", price: 160, rent: [12, 60, 180, 500, 700, 900], color: "#d25298", houseCost: 100 },
                { name: "Pennsylvania Railroad", type: "railroad", price: 200 },
                { name: "St. James Place", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], color: "#f7941e", houseCost: 100 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Tennessee Ave", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], color: "#f7941e", houseCost: 100 },
                { name: "New York Ave", type: "property", price: 200, rent: [16, 80, 220, 600, 800, 1000], color: "#f7941e", houseCost: 100 },
                { name: "Free Parking", type: "free_parking" },
                { name: "Kentucky Ave", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], color: "#ed1c24", houseCost: 150 },
                { name: "Chance", type: "chance" },
                { name: "Indiana Ave", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], color: "#ed1c24", houseCost: 150 },
                { name: "Illinois Ave", type: "property", price: 240, rent: [20, 100, 300, 750, 925, 1100], color: "#ed1c24", houseCost: 150 },
                { name: "B. & O. Railroad", type: "railroad", price: 200 },
                { name: "Atlantic Ave", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], color: "#ffeb3b", houseCost: 150 },
                { name: "Ventnor Ave", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], color: "#ffeb3b", houseCost: 150 },
                { name: "Water Works", type: "utility", price: 150 },
                { name: "Marvin Gardens", type: "property", price: 280, rent: [24, 120, 360, 850, 1025, 1200], color: "#ffeb3b", houseCost: 150 },
                { name: "Secim kazandin, hapse gir.", type: "go_to_jail" },
                { name: "Pacific Ave", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: "#4caf50", houseCost: 200 },
                { name: "North Carolina Ave", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: "#4caf50", houseCost: 200 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Pennsylvania Ave", type: "property", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], color: "#4caf50", houseCost: 200 },
                { name: "Short Line", type: "railroad", price: 200 },
                { name: "Chance", type: "chance" },
                { name: "Park Place", type: "property", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], color: "#2196f3", houseCost: 200 },
                { name: "Luxury Tax", type: "tax", amount: 100 },
                { name: "Boardwalk", type: "property", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], color: "#2196f3", houseCost: 200 }
            ];
        }
        
        const defaultCards = {
            chance: [
                { text: "Advance to Go (Collect $200)", action: "move_to", space: 0, collect: true },
                { text: "Advance to Illinois Ave.", action: "move_to", space: 24 },
                { text: "Advance to St. Charles Place.", action: "move_to", space: 11 },
                { text: "Bank pays you dividend of $50.", action: "add_money", amount: 50 },
                { text: "Get Out of Jail Free.", action: "get_out_of_jail" },
                { text: "Go Back 3 Spaces.", action: "move_back", amount: 3 },
                { text: "Diktatore karsi secim kazandin, hapse gir.", action: "go_to_jail" },
                { text: "Pay poor tax of $15.", action: "remove_money", amount: 15 },
                { text: "Your building loan matures. Collect $150.", action: "add_money", amount: 150 },
                { text: "Speeding fine $50.", action: "remove_money", amount: 50 },
                { text: "Pay school fees of $50.", action: "remove_money", amount: 50 },
                { text: "Take a trip to Reading Railroad.", action: "move_to", space: 5 },
                { text: "Advance to Boardwalk.", action: "move_to", space: 39 },
                { text: "Make general repairs on all properties. $25 per house, $100 per hotel.", action: "repair", house: 25, hotel: 100 },
            ],
            community_chest: [
                { text: "Advance to Go (Collect $200).", action: "move_to", space: 0, collect: true },
                { text: "Bank error in your favor. Collect $200.", action: "add_money", amount: 200 },
                { text: "Doctor's fees. Pay $50.", action: "remove_money", amount: 50 },
                { text: "From sale of stock you get $50.", action: "add_money", amount: 50 },
                { text: "Get Out of Jail Free.", action: "get_out_of_jail" },
                { text: "Diktatore karsi secim kazandin, hapse gir.", action: "go_to_jail" },
                { text: "Holiday fund matures. Receive $100.", action: "add_money", amount: 100 },
                { text: "Income tax refund. Collect $20.", action: "add_money", amount: 20 },
                { text: "Life insurance matures. Collect $100.", action: "add_money", amount: 100 },
                { text: "Pay hospital fees of $100.", action: "remove_money", amount: 100 },
                { text: "You inherit $100.", action: "add_money", amount: 100 },
                { text: "You have won second prize in a beauty contest. Collect $10.", action: "add_money", amount: 10 },
                { text: "Receive $25 consultancy fee.", action: "add_money", amount: 25 },
                { text: "Street repairs. $40 per house, $115 per hotel.", action: "repair", house: 40, hotel: 115 },
            ]
        };
        
        // Game Mode Presets
        const gameModes = {
            classic: { startingMoney: 1500, passGoAmount: 200, multiplier: 1, noLuck: false, name: "Classic" },
            fast: { startingMoney: 3000, passGoAmount: 400, multiplier: 2, noLuck: false, name: "Fast Money" },
            hard: { startingMoney: 1000, passGoAmount: 150, multiplier: 0.75, noLuck: false, name: "Hard Mode" },
            noluck: { startingMoney: 1500, passGoAmount: 200, multiplier: 1, noLuck: true, name: "No Luck" },
            mega: { startingMoney: 7500, passGoAmount: 1000, multiplier: 5, noLuck: false, name: "Mega Rich" },
            speed: { startingMoney: 2000, passGoAmount: 300, multiplier: 1.5, noLuck: false, name: "Speed Game" }
        };

        // --- CHARACTER & MAP SELECTION ---
        let selectedCharacter = ''; // No default, user must choose
        let selectedMap = '';

        const characterIcons = {
          car: 'üöó', hat: 'üé©', dog: 'üêï', shoe: 'üëû', iron: 'üß≤', ship: 'üö¢', cat: 'üêà', money: 'üí∞'
        };
        
        // Her karaktere √∂zel renk
        const characterColors = {
          car: '#EF4444',    // Kƒ±rmƒ±zƒ±
          hat: '#3B82F6',    // Mavi
          dog: '#10B981',    // Ye≈üil
          shoe: '#F59E0B',   // Turuncu
          iron: '#8B5CF6',   // Mor
          ship: '#06B6D4',   // Cyan
          cat: '#EC4899',    // Pembe
          money: '#F97316'   // Koyu Turuncu
        };

        // üéµ Sound Effects System using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'dice':
                    // Dice roll sound - quick rattle
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                    
                case 'purchase':
                    // Cash register cha-ching
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'jail':
                    // Jail door slam - low thud
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'win':
                    // Victory fanfare
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.15);
                    oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
            }
        }

        // üí´ Confetti Animation for Property Purchase
        function createConfetti(x, y) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
            const confettiCount = 30;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = x + 'px';
                confetti.style.top = y + 'px';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.zIndex = '9999';
                confetti.style.pointerEvents = 'none';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 100 + Math.random() * 100;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity - 200;
                
                let posX = x;
                let posY = y;
                let velX = vx;
                let velY = vy;
                const gravity = 500;
                let opacity = 1;
                
                const startTime = Date.now();
                const duration = 2000;
                
                function animate() {
                    const elapsed = Date.now() - startTime;
                    const dt = 0.016;
                    
                    velY += gravity * dt;
                    posX += velX * dt;
                    posY += velY * dt;
                    opacity = 1 - (elapsed / duration);
                    
                    confetti.style.left = posX + 'px';
                    confetti.style.top = posY + 'px';
                    confetti.style.opacity = opacity;
                    confetti.style.transform = `rotate(${elapsed / 10}deg)`;
                    
                    if (elapsed < duration && opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // üé® Animate Property Card on Purchase
        function animatePropertyPurchase(position, ownerColor) {
            const spaceEl = document.getElementById(`space-${position}`);
            if (!spaceEl) return;
            
            // Get position for confetti
            const rect = spaceEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Trigger confetti
            createConfetti(centerX, centerY);
            
            // Hemen owner indicator ekle
            let indicator = spaceEl.querySelector('.owner-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'owner-indicator';
                spaceEl.appendChild(indicator);
            }
            indicator.style.backgroundColor = ownerColor;
            
            // Animate the space card
            spaceEl.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            spaceEl.style.transform = 'scale(1.2)';
            spaceEl.style.boxShadow = `0 0 30px ${ownerColor}`;
            
            setTimeout(() => {
                spaceEl.style.transform = 'scale(1)';
                spaceEl.style.boxShadow = '';
            }, 500);
        }

        const mapBoards = {
          classic: getDefaultBoard(),
          
          turkey: [
            { name: "BA≈ûLANGI√á", type: "go" },
            { name: "ƒ∞stanbul - Kadƒ±k√∂y", type: "property", price: 80, rent: [6,30,90,270,400,550], color: "#a55a40", houseCost: 50 },
            { name: "Kamu Sandƒ±ƒüƒ±", type: "community_chest" },
            { name: "Ankara - Kƒ±zƒ±lay", type: "property", price: 80, rent: [8,40,100,300,450,600], color: "#a55a40", houseCost: 50 },
            { name: "Gelir Vergisi", type: "tax", amount: 200 },
            { name: "TCDD Tren Hattƒ±", type: "railroad", price: 200 },
            { name: "ƒ∞zmir - Alsancak", type: "property", price: 120, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "≈ûans", type: "chance" },
            { name: "Antalya - Kalei√ßi", type: "property", price: 120, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Bursa - Osmangazi", type: "property", price: 140, rent: [12,60,180,500,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Hapishane / Ziyaret", type: "jail" },
            { name: "Trabzon", type: "property", price: 160, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Elektrik ≈ûirketi", type: "utility", price: 150 },
            { name: "Gaziantep", type: "property", price: 160, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Adana", type: "property", price: 180, rent: [16,80,220,600,800,1000], color: "#d25298", houseCost: 100 },
            { name: "THY Hava Yolu", type: "railroad", price: 200 },
            { name: "Eski≈üehir", type: "property", price: 200, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Kamu Sandƒ±ƒüƒ±", type: "community_chest" },
            { name: "Konya", type: "property", price: 200, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Kayseri", type: "property", price: 220, rent: [20,100,300,750,925,1100], color: "#f7941e", houseCost: 100 },
            { name: "√úcretsiz Park", type: "free_parking" },
            { name: "Bodrum", type: "property", price: 240, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "≈ûans", type: "chance" },
            { name: "√áe≈üme", type: "property", price: 240, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Marmaris", type: "property", price: 260, rent: [24,120,360,850,1025,1200], color: "#ed1c24", houseCost: 150 },
            { name: "ƒ∞DO Deniz Otob√ºs√º", type: "railroad", price: 200 },
            { name: "ƒ∞stanbul - Ni≈üanta≈üƒ±", type: "property", price: 280, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Ankara - √áankaya", type: "property", price: 280, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Su ≈ûirketi", type: "utility", price: 150 },
            { name: "ƒ∞zmir - Kar≈üƒ±yaka", type: "property", price: 300, rent: [28,150,450,1000,1200,1400], color: "#ffeb3b", houseCost: 150 },
            { name: "Hapse Git", type: "go_to_jail" },
            { name: "ƒ∞stanbul - Bebek", type: "property", price: 320, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Ankara - Bilkent", type: "property", price: 320, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Kamu Sandƒ±ƒüƒ±", type: "community_chest" },
            { name: "ƒ∞stanbul - Etiler", type: "property", price: 350, rent: [35,175,500,1200,1400,1600], color: "#4caf50", houseCost: 200 },
            { name: "Marmaray", type: "railroad", price: 200 },
            { name: "≈ûans", type: "chance" },
            { name: "ƒ∞stanbul - Tarabya", type: "property", price: 380, rent: [40,200,600,1400,1700,2000], color: "#2196f3", houseCost: 200 },
            { name: "L√ºks Vergi", type: "tax", amount: 150 },
            { name: "ƒ∞stanbul - Emirgan", type: "property", price: 420, rent: [50,250,750,1600,1900,2200], color: "#2196f3", houseCost: 200 }
          ],
          
          world: [
            { name: "START", type: "go" },
            { name: "New York - Brooklyn", type: "property", price: 70, rent: [5,25,75,225,350,500], color: "#a55a40", houseCost: 50 },
            { name: "Community Chest", type: "community_chest" },
            { name: "London - Soho", type: "property", price: 70, rent: [7,35,105,315,450,625], color: "#a55a40", houseCost: 50 },
            { name: "Income Tax", type: "tax", amount: 200 },
            { name: "International Airport", type: "railroad", price: 200 },
            { name: "Paris - Montmartre", type: "property", price: 110, rent: [9,45,135,405,575,750], color: "#add8e6", houseCost: 50 },
            { name: "Chance", type: "chance" },
            { name: "Berlin - Mitte", type: "property", price: 110, rent: [9,45,135,405,575,750], color: "#add8e6", houseCost: 50 },
            { name: "Tokyo - Shibuya", type: "property", price: 130, rent: [11,55,165,495,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Jail / Just Visiting", type: "jail" },
            { name: "Rome - Colosseum", type: "property", price: 150, rent: [13,65,195,575,800,1025], color: "#d25298", houseCost: 100 },
            { name: "Power Company", type: "utility", price: 150 },
            { name: "Madrid - Plaza Mayor", type: "property", price: 150, rent: [13,65,195,575,800,1025], color: "#d25298", houseCost: 100 },
            { name: "Barcelona - Gothic Quarter", type: "property", price: 170, rent: [15,75,225,625,875,1100], color: "#d25298", houseCost: 100 },
            { name: "Trans-Europe Railway", type: "railroad", price: 200 },
            { name: "Amsterdam - Canal District", type: "property", price: 190, rent: [17,85,255,725,950,1200], color: "#f7941e", houseCost: 100 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Brussels - Grand Place", type: "property", price: 190, rent: [17,85,255,725,950,1200], color: "#f7941e", houseCost: 100 },
            { name: "Vienna - Ringstrasse", type: "property", price: 210, rent: [19,95,285,775,1025,1300], color: "#f7941e", houseCost: 100 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Sydney - Opera House", type: "property", price: 230, rent: [21,105,315,850,1100,1400], color: "#ed1c24", houseCost: 150 },
            { name: "Chance", type: "chance" },
            { name: "Dubai - Marina", type: "property", price: 230, rent: [21,105,315,850,1100,1400], color: "#ed1c24", houseCost: 150 },
            { name: "Singapore - Marina Bay", type: "property", price: 250, rent: [23,115,345,900,1150,1500], color: "#ed1c24", houseCost: 150 },
            { name: "Pacific Airlines", type: "railroad", price: 200 },
            { name: "Hong Kong - Victoria Peak", type: "property", price: 270, rent: [25,125,375,950,1200,1600], color: "#ffeb3b", houseCost: 150 },
            { name: "Shanghai - Bund", type: "property", price: 270, rent: [25,125,375,950,1200,1600], color: "#ffeb3b", houseCost: 150 },
            { name: "Water Works", type: "utility", price: 150 },
            { name: "Mumbai - Gateway of India", type: "property", price: 290, rent: [27,135,405,1000,1250,1700], color: "#ffeb3b", houseCost: 150 },
            { name: "Secim kazandin, hapse gir.", type: "go_to_jail" },
            { name: "New York - Manhattan", type: "property", price: 310, rent: [29,145,435,1050,1300,1800], color: "#4caf50", houseCost: 200 },
            { name: "London - Mayfair", type: "property", price: 310, rent: [29,145,435,1050,1300,1800], color: "#4caf50", houseCost: 200 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Paris - Champs-√âlys√©es", type: "property", price: 340, rent: [33,165,495,1150,1400,1950], color: "#4caf50", houseCost: 200 },
            { name: "Global Express", type: "railroad", price: 200 },
            { name: "Chance", type: "chance" },
            { name: "Tokyo - Ginza", type: "property", price: 370, rent: [38,190,570,1300,1600,2100], color: "#2196f3", houseCost: 200 },
            { name: "Luxury Tax", type: "tax", amount: 150 },
            { name: "Monaco - Monte Carlo", type: "property", price: 410, rent: [48,240,720,1600,2000,2400], color: "#2196f3", houseCost: 200 }
          ],
          
          holland: [
            { name: "START", type: "go" },
            { name: "Amsterdam - Jordaan", type: "property", price: 75, rent: [6,30,90,270,400,550], color: "#a55a40", houseCost: 50 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Rotterdam - Delfshaven", type: "property", price: 75, rent: [8,40,100,300,450,600], color: "#a55a40", houseCost: 50 },
            { name: "Inkomstenbelasting", type: "tax", amount: 200 },
            { name: "NS Spoorweg", type: "railroad", price: 200 },
            { name: "Utrecht - Oudegracht", type: "property", price: 115, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Kans", type: "chance" },
            { name: "Den Haag - Binnenhof", type: "property", price: 115, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Groningen - Grote Markt", type: "property", price: 135, rent: [12,60,180,500,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Gevangenis / Bezoek", type: "jail" },
            { name: "Eindhoven - Strijp-S", type: "property", price: 155, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Elektriciteitsbedrijf", type: "utility", price: 150 },
            { name: "Leiden - Burcht", type: "property", price: 155, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Delft - Markt", type: "property", price: 175, rent: [16,80,220,600,800,1000], color: "#d25298", houseCost: 100 },
            { name: "Connexxion Bus", type: "railroad", price: 200 },
            { name: "Haarlem - Grote Markt", type: "property", price: 195, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Maastricht - Vrijthof", type: "property", price: 195, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Nijmegen - Waalkade", type: "property", price: 215, rent: [20,100,300,750,925,1100], color: "#f7941e", houseCost: 100 },
            { name: "Gratis Parkeren", type: "free_parking" },
            { name: "Amsterdam - De Pijp", type: "property", price: 235, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Kans", type: "chance" },
            { name: "Rotterdam - Katendrecht", type: "property", price: 235, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Utrecht - Museum Quarter", type: "property", price: 255, rent: [24,120,360,850,1025,1200], color: "#ed1c24", houseCost: 150 },
            { name: "GVB Tram", type: "railroad", price: 200 },
            { name: "Amsterdam - Oud-Zuid", type: "property", price: 275, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Den Haag - Scheveningen", type: "property", price: 275, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Waterbedrijf", type: "utility", price: 150 },
            { name: "Rotterdam - Kralingen", type: "property", price: 295, rent: [28,150,450,1000,1200,1400], color: "#ffeb3b", houseCost: 150 },
            { name: "Ga Naar Gevangenis", type: "go_to_jail" },
            { name: "Amsterdam - Centrum", type: "property", price: 315, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Rotterdam - Centrum", type: "property", price: 315, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Den Haag - Centrum", type: "property", price: 345, rent: [35,175,500,1200,1400,1600], color: "#4caf50", houseCost: 200 },
            { name: "Metro Amsterdam", type: "railroad", price: 200 },
            { name: "Kans", type: "chance" },
            { name: "Amsterdam - Grachtengordel", type: "property", price: 375, rent: [40,200,600,1400,1700,2000], color: "#2196f3", houseCost: 200 },
            { name: "Luxe Belasting", type: "tax", amount: 150 },
            { name: "Amsterdam - Museum Quarter", type: "property", price: 415, rent: [50,250,750,1600,1900,2200], color: "#2196f3", houseCost: 200 }
          ],
          
          megarich: [
            { name: "START", type: "go" },
            { name: "Budget District", type: "property", price: 50, rent: [10,50,150,450,800,1200], color: "#8b4513", houseCost: 25 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Cheap Avenue", type: "property", price: 60, rent: [12,60,180,500,900,1400], color: "#8b4513", houseCost: 25 },
            { name: "Income Tax", type: "tax", amount: 100 },
            { name: "Economy Railroad", type: "railroad", price: 200 },
            { name: "Thrift Street", type: "property", price: 80, rent: [15,75,225,650,1100,1600], color: "#a55a40", houseCost: 30 },
            { name: "Chance", type: "chance" },
            { name: "Economy Lane", type: "property", price: 100, rent: [20,100,300,750,1300,1800], color: "#a55a40", houseCost: 30 },
            { name: "Market Place", type: "property", price: 120, rent: [25,125,375,900,1500,2000], color: "#a55a40", houseCost: 30 },
            { name: "Jail / Just Visiting", type: "jail" },
            { name: "Standard Plaza", type: "property", price: 200, rent: [40,200,600,1400,2200,3000], color: "#add8e6", houseCost: 50 },
            { name: "Electric Company", type: "utility", price: 150 },
            { name: "Common Boulevard", type: "property", price: 250, rent: [50,250,750,1800,2700,3600], color: "#add8e6", houseCost: 50 },
            { name: "Regular Street", type: "property", price: 300, rent: [60,300,900,2200,3300,4400], color: "#add8e6", houseCost: 50 },
            { name: "Standard Railroad", type: "railroad", price: 200 },
            { name: "Middle Avenue", type: "property", price: 400, rent: [80,400,1200,2800,4200,5600], color: "#d25298", houseCost: 75 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Good Quarter", type: "property", price: 500, rent: [100,500,1500,3500,5000,6500], color: "#d25298", houseCost: 75 },
            { name: "Nice District", type: "property", price: 600, rent: [120,600,1800,4200,6000,7800], color: "#d25298", houseCost: 75 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Quality Street", type: "property", price: 750, rent: [150,750,2250,5000,7000,9000], color: "#f7941e", houseCost: 100 },
            { name: "Chance", type: "chance" },
            { name: "Premium Place", type: "property", price: 900, rent: [180,900,2700,6000,8400,10800], color: "#f7941e", houseCost: 100 },
            { name: "Fine Avenue", type: "property", price: 1100, rent: [220,1100,3300,7500,10500,13500], color: "#f7941e", houseCost: 100 },
            { name: "Premium Railroad", type: "railroad", price: 200 },
            { name: "Upscale Boulevard", type: "property", price: 1600, rent: [320,1600,4800,11000,15400,19800], color: "#ed1c24", houseCost: 250 },
            { name: "Expensive Plaza", type: "property", price: 1900, rent: [380,1900,5700,13300,18600,23900], color: "#ed1c24", houseCost: 250 },
            { name: "Water Works", type: "utility", price: 150 },
            { name: "Luxury Lane", type: "property", price: 2200, rent: [440,2200,6600,15400,21500,27600], color: "#ed1c24", houseCost: 250 },
            { name: "Go To Jail", type: "go_to_jail" },
            { name: "Elite Street", type: "property", price: 2500, rent: [500,2500,7500,17500,24500,31500], color: "#ffeb3b", houseCost: 500 },
            { name: "Exclusive Avenue", type: "property", price: 3000, rent: [600,3000,9000,21000,29400,37800], color: "#ffeb3b", houseCost: 500 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Prestige Plaza", type: "property", price: 3500, rent: [700,3500,10500,24500,34300,44100], color: "#ffeb3b", houseCost: 500 },
            { name: "Luxury Railroad", type: "railroad", price: 400 },
            { name: "Chance", type: "chance" },
            { name: "VIP Quarter", type: "property", price: 4000, rent: [800,4000,12000,28000,39200,50400], color: "#4caf50", houseCost: 1000 },
            { name: "Luxury Tax", type: "tax", amount: 500 },
            { name: "Royal District", type: "property", price: 4600, rent: [920,4600,13800,32200,45000,57800], color: "#4caf50", houseCost: 1000 }
          ],
          
          custom: getDefaultBoard()
        };

        // Character selection
        const characterBtns = document.querySelectorAll('.character-btn');
        
        // Function to update character button availability
        function updateCharacterAvailability() {
            if (!gameData || !gameData.players) return;
            
            // Get list of taken characters (excluding local player)
            const takenCharacters = gameData.players
                .filter(p => p.id !== localPlayer.id)
                .map(p => p.character);
            
            characterBtns.forEach(btn => {
                const char = btn.dataset.char;
                const isTaken = takenCharacters.includes(char);
                
                if (isTaken) {
                    // Disable taken characters
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                    btn.style.filter = 'grayscale(100%)';
                    btn.title = 'Bu karakter ba≈üka bir oyuncu tarafƒ±ndan se√ßildi';
                } else {
                    // Enable available characters
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.filter = 'none';
                    btn.title = '';
                }
            });
        }
        
        characterBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // Check if character is taken
            if (this.disabled) {
                alert('Bu karakter ba≈üka bir oyuncu tarafƒ±ndan se√ßildi. L√ºtfen ba≈üka bir karakter se√ßin.');
                return;
            }
            
            // Remove selection from all
            characterBtns.forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'border-4');
                b.style.boxShadow = '';
                b.style.transform = '';
            });
            
            // Add strong visual selection
            this.classList.add('border-blue-500', 'bg-blue-50', 'border-4');
            this.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8)';
            this.style.transform = 'scale(1.1)';
            
            selectedCharacter = this.dataset.char;
            console.log(`‚úÖ Character selected: ${selectedCharacter}`);
            
            // Visual feedback for mobile
            const emoji = this.textContent;
            lobbyError.textContent = `Selected: ${emoji}`;
            lobbyError.style.color = '#3b82f6';
            setTimeout(() => {
                lobbyError.textContent = '';
                lobbyError.style.color = '';
            }, 2000);
          });
        });
        // Don't auto-select first character - let user choose
        // characterBtns[0].click();

        // Map selection
        const mapBtns = document.querySelectorAll('.map-btn');
        const mapPreview = document.getElementById('map-preview');
        const mapNames = {
            classic: 'üèõÔ∏è Classic',
            turkey: 'üáπüá∑ T√ºrkiye',
            world: 'üåç World',
            holland: 'üá≥üá± Holland',
            megarich: 'üíé Mega Rich',
            custom: '‚öôÔ∏è Custom'
        };
        mapBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        mapBtns.forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                        this.classList.add('border-blue-500', 'bg-blue-50');
                        selectedMap = this.dataset.map;
                        
                        // Update both preview elements (main menu and lobby)
                        const mainMapPreview = document.getElementById('main-map-preview');
                        if (mapPreview) {
                                mapPreview.textContent = `(${mapNames[selectedMap]} selected)`;
                        }
                        if (mainMapPreview) {
                                mainMapPreview.textContent = `(${mapNames[selectedMap]} selected)`;
                        }
                        
                        console.log('‚úÖ Selected map:', selectedMap);
                    });
                });
                // Otomatik map se√ßimi kaldƒ±rƒ±ldƒ±. Kullanƒ±cƒ± bir map se√ßmeli.

        // Game mode selection
        const gameModeBtns = document.querySelectorAll('.game-mode-btn');
        gameModeBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            gameModeBtns.forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
            this.classList.add('border-blue-500', 'bg-blue-50');
            selectedGameMode = this.dataset.mode;
            
            // Update settings based on game mode
            const mode = gameModes[selectedGameMode];
            if (mode) {
                document.getElementById('startingMoney').value = mode.startingMoney;
                document.getElementById('passGoAmount').value = mode.passGoAmount;
            }
            console.log('‚úÖ Selected game mode:', selectedGameMode);
          });
        });
        if (gameModeBtns.length > 0) gameModeBtns[0].click();

        // --- LOBBY LOGIC ---
        console.log('üîó Adding event listener to createGameBtn...');
        if (createGameBtn) {
            createGameBtn.addEventListener('click', async () => {
                console.log('üÜï Create Game button clicked');
                addDebugLog('üÜï CREATE CLICKED');
            
            // Disable button and show loading
            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creating...';
            lobbyError.textContent = '';
            lobbyError.style.color = '';
            
            if (!validatePlayerName()) {
                addDebugLog('‚ùå NAME INVALID');
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
                return;
            }
            addDebugLog('‚úÖ Name valid: ' + localPlayer.name);
            
            // Check if character is selected
            if (!selectedCharacter) {
                addDebugLog('‚ùå NO CHARACTER');
                showModal('Character Required', 'Please select a character before creating the game!', [{text: 'OK', class: 'bg-red-500', action: hideModal}]);
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
                return;
            }
            addDebugLog('‚úÖ Character: ' + selectedCharacter);
            
            // Check WebSocket connection
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('‚ùå WebSocket not connected');
                addDebugLog('‚ùå WS NOT CONNECTED');
                lobbyError.textContent = 'Connecting to server...';
                lobbyError.style.color = 'orange';
                connectWebSocket();
                
                setTimeout(() => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        lobbyError.textContent = 'Connection failed. Please refresh the page.';
                        lobbyError.style.color = 'red';
                        createGameBtn.disabled = false;
                        createGameBtn.textContent = 'Create New Game';
                    } else {
                        createGameBtn.click();
                    }
                }, 2000);
                return;
            }
            addDebugLog('‚úÖ WS Connected');
            
            // Eƒüer harita se√ßilmemi≈üse varsayƒ±lan olarak Classic kullan
            if (!selectedMap) {
                selectedMap = 'classic';
                console.log('‚ö†Ô∏è No map selected, defaulting to classic');
                addDebugLog('‚ö†Ô∏è Map defaulted to classic');
            }
            addDebugLog('‚úÖ Map: ' + selectedMap);
            
            console.log('üéÆ CREATE GAME CLICKED!');
            console.log('üìç selectedMap variable:', selectedMap);
            console.log('üìç selectedCharacter:', selectedCharacter);
            console.log('üìç selectedGameMode:', selectedGameMode);
            
            const gameId = generateGameId();
            currentGameId = gameId;
            
            const hostPlayer = {
                id: localPlayer.id,
                name: localPlayer.name,
                color: playerColors[0],
                money: parseInt(document.getElementById('startingMoney').value),
                position: 0,
                character: selectedCharacter,
                team: '', // No team at start, can join later
                getOutOfJailCards: 0,
                bankrupt: false
            };

            const mode = gameModes[selectedGameMode];
            
            try {
                console.log('üéÆ Creating game with map:', selectedMap);
                console.log('üìã mapBoards object keys:', Object.keys(mapBoards));
                console.log('üìã mapBoards[selectedMap] exists?', selectedMap in mapBoards);
                console.log('üìã Board data:', mapBoards[selectedMap]);
                console.log('üìç First 5 spaces:', mapBoards[selectedMap].slice(0, 5).map(s => s.name));
                
                addDebugLog('üì§ Sending create_game...');
                
                sendMessage({
                    type: 'create_game',
                    gameId: gameId,
                    hostId: localPlayer.id,
                    player: hostPlayer,
                    private: document.getElementById('privateGameCheckbox').checked,
                    settings: {
                        startingMoney: parseInt(document.getElementById('startingMoney').value),
                        passGoAmount: parseInt(document.getElementById('passGoAmount').value),
                        maxPlayers: parseInt(document.getElementById('playerCount').value),
                        auctionTimer: parseInt(document.getElementById('auctionTimer').value),
                        allowTrading: document.getElementById('allowTrading').checked,
                        gameMode: selectedGameMode,
                        noLuck: mode.noLuck,
                        board: mapBoards[selectedMap],
                        map: selectedMap,
                        chanceCards: mode.noLuck ? [] : defaultCards.chance,
                        communityChestCards: mode.noLuck ? [] : defaultCards.community_chest,
                    }
                });
                console.log('‚úÖ Game creation message sent:', gameId);
                addDebugLog('‚úÖ Create msg sent: ' + gameId);
            } catch (error) {
                console.error("‚ùå Error creating game:", error);
                addDebugLog('‚ùå CREATE ERROR: ' + error.message);
                lobbyError.textContent = `Error: ${error.message}. Check connection.`;
                lobbyError.style.color = 'red';
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
            }
        });
        } // End of if (createGameBtn)

        if (joinGameBtn) {
        joinGameBtn.addEventListener('click', async () => {
            console.log('üîò Join Game button clicked');
            console.log('üìù Player name:', playerNameInput.value);
            console.log('üé≠ Selected character:', selectedCharacter);
            console.log('üéÆ Game ID:', gameIdInput.value);
            console.log('üîå WebSocket state:', ws ? ws.readyState : 'null');
            addDebugLog('üîò JOIN CLICKED');
            
            // Visual feedback - disable button
            joinGameBtn.disabled = true;
            joinGameBtn.textContent = 'Joining...';
            lobbyError.textContent = '';
            lobbyError.style.color = '';
            
            // Allow joining even if game is playing
            if (!validatePlayerName()) {
                console.log('‚ùå Name validation failed');
                addDebugLog('‚ùå NAME INVALID');
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            // Check if character is selected
            if (!selectedCharacter) {
                console.log('‚ùå No character selected');
                addDebugLog('‚ùå NO CHARACTER');
                showModal('Character Required', 'Please select a character before joining!', [{text: 'OK', class: 'bg-red-500', action: hideModal}]);
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId) {
                console.log('‚ùå No game ID');
                addDebugLog('‚ùå NO GAME ID');
                lobbyError.textContent = 'Please enter a Game ID.';
                lobbyError.style.color = 'red';
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            currentGameId = gameId;

            if (!currentGameId) {
                showModal('Error', 'Game ID is missing. L√ºtfen ge√ßerli bir oyun kodu girin.', [{text:'Tamam', class:'bg-red-500', action:hideModal}]);
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            // Check WebSocket connection
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('‚ùå WebSocket not connected, attempting to reconnect...');
                addDebugLog('‚ùå WS NOT CONNECTED! State: ' + (ws ? ws.readyState : 'null'));
                lobbyError.textContent = 'Connecting to server...';
                lobbyError.style.color = 'orange';
                connectWebSocket();
                
                // Wait a bit for connection
                setTimeout(() => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        lobbyError.textContent = 'Connection failed. Please refresh the page.';
                        lobbyError.style.color = 'red';
                        addDebugLog('‚ùå RECONNECT FAILED');
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    } else {
                        // Retry join
                        addDebugLog('‚úÖ RECONNECTED, RETRY');
                        joinGameBtn.click();
                    }
                }, 2000);
                return;
            }

            try {
                // Her oyuncuya benzersiz renk ata - karakterden baƒüƒ±msƒ±z
                // Client tarafƒ±nda renk atamƒ±yoruz, server otomatik atayacak
                const newPlayer = {
                    id: localPlayer.id,
                    name: localPlayer.name,
                    color: '', // Server tarafƒ±nda atanacak
                    position: 0,
                    character: selectedCharacter,
                    team: '', // No team at start
                    getOutOfJailCards: 0,
                    bankrupt: false,
                    secretTradesAvailable: 3, // Gizli trade haklarƒ± (ba≈ülangƒ±√ß: 3)
                    jokerCards: {
                        steal: 1, // Kart √ßalma joker'i
                        skip: 1, // Tur atlama joker'i
                        reroll: 1 // Zar tekrar atma joker'i
                    }
                };
                
                console.log('üì§ Sending join_game message:', newPlayer);
                addDebugLog('üì§ SENDING JOIN MSG');
                lobbyError.textContent = 'Joining game...';
                lobbyError.style.color = 'blue';
                
                sendMessage({
                    type: 'join_game',
                    gameId: gameId,
                    player: newPlayer
                });

                console.log('‚úÖ Join message sent to game:', gameId);
                
                // Set timeout to re-enable button if no response
                setTimeout(() => {
                    if (joinGameBtn.disabled) {
                        console.log('‚ö†Ô∏è No response from server after 5 seconds');
                        addDebugLog('‚ö†Ô∏è NO RESPONSE (5s)');
                        lobbyError.textContent = 'No response from server. Check Game ID or try again.';
                        lobbyError.style.color = 'red';
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    }
                }, 5000);
                
            } catch (error) {
                console.error("‚ùå Error joining game:", error);
                addDebugLog('‚ùå JOIN ERROR: ' + error.message);
                lobbyError.textContent = `Error: ${error.message}. Check game ID.`;
                lobbyError.style.color = 'red';
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
            }
        });
        } // End of if (joinGameBtn)
        
        // ü§ñ Add Bot Player
        const addBotBtn = document.getElementById('addBotBtn');
        addBotBtn.addEventListener('click', () => {
            // Coming Soon - Bots disabled
            showModal('ü§ñ Bots Coming Soon!', 
                '<p class="text-center">Bot players are currently under development, so if you have any problems with them you can mail coxaexs@gmail.com. We assure you that they will be better with future updates!</p><p class="text-center mt-4 text-gray-600">Stay tuned! üöÄ</p>', 
                [{text: 'OK', class: 'bg-blue-500', action: hideModal}]
            );
        });
        
        // Add Bot button
        addBotBtn.addEventListener('click', () => {
            sendMessage({
                type: 'add_bot'
            });
        });

        startGameBtn.addEventListener('click', async () => {
            if (gameData.players.length < 2) {
                showModal("Not Enough Players", "You need at least 2 players to start the game.", [{ text: 'OK', class: 'bg-blue-500', action: hideModal }]);
                return;
            }

            // Save final settings
            const settings = {
                startingMoney: parseInt(document.getElementById('startingMoney').value),
                passGoAmount: parseInt(document.getElementById('passGoAmount').value),
                maxPlayers: parseInt(document.getElementById('playerCount').value),
                allowTrading: document.getElementById('allowTrading').checked,
                allowDoubles: document.getElementById('allowDoubles').checked,
                board: gameData.settings.board, // Use the board that was set during game creation
                map: gameData.settings.map, // Preserve the map selection
                chanceCards: defaultCards.chance, 
                communityChestCards: defaultCards.community_chest,
            };
            
            console.log('üéÆ Starting game with map:', gameData.settings.map);
            console.log('üìç Board has', settings.board.length, 'spaces');
            console.log('üìç First property:', settings.board[1]?.name);
            
            // üåü Select random lucky player for bonus
            const luckyPlayerIndex = Math.floor(Math.random() * gameData.players.length);
            
            // Initialize game state properties for each player
            const initializedPlayers = gameData.players.map((p, i) => ({
                ...p,
                money: settings.startingMoney,
                position: 0,
                properties: [],
                inJail: false,
                jailTurns: 0,
                getOutOfJailCards: 0,
                isBankrupt: false,
                isLucky: i === luckyPlayerIndex, // Lucky player flag
                luckyTurnsLeft: i === luckyPlayerIndex ? 3 : 0, // 3 turns of double money
                jailCount: 0, // Track jail visits
                doublesCount: 0, // Track lucky doubles
                // üí≥ Kredi Sistemi
                creditAmount: 0, // Alƒ±nan toplam kredi miktarƒ±
                creditTurnsLeft: 0, // Geri √∂deme i√ßin kalan tur sayƒ±sƒ±
                creditHistory: [] // Kredi ge√ßmi≈üi
            }));
            
            sendMessage({
                type: 'start_game',
                gameId: currentGameId,
                settings: settings,
                players: initializedPlayers
            });
        });

        // --- UI TRANSITIONS ---
        function showGameSettings() {
            lobby.classList.add('hidden');
            gameContainer.classList.add('hidden');
            gameSettingsScreen.classList.remove('hidden');
            displayGameId.textContent = currentGameId;
            
            // Generate shareable link
            const currentUrl = window.location.origin + window.location.pathname;
            const gameLink = `${currentUrl}?gameId=${currentGameId}`;
            const gameLinkInput = document.getElementById('gameLinkInput');
            if (gameLinkInput) {
                gameLinkInput.value = gameLink;
            }
            
            populateSettingsEditor(gameData.settings.board);
            
            // Mobilde oyun kontrol butonlarƒ±nƒ± gizle
            document.body.classList.remove('in-game');
            
            // Hide game link display in settings screen
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            if (gameLinkDisplay) {
                gameLinkDisplay.classList.add('hidden');
            }
            if (gameLinkDisplayMobile) {
                gameLinkDisplayMobile.classList.add('hidden');
            }
            
            // Show game-settings-only elements
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'block';
            if (propertiesEditor) propertiesEditor.style.display = 'grid';
            if (lobbyControls) lobbyControls.style.display = 'flex';
            if (allowTradingContainer) allowTradingContainer.style.display = 'flex';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'block';
        }

        function showWaitingLobby() {
            lobby.classList.add('hidden');
            gameContainer.classList.add('hidden');
            gameSettingsScreen.classList.remove('hidden');
            
            // Mobilde oyun kontrol butonlarƒ±nƒ± gizle
            document.body.classList.remove('in-game');
            
            // Hide game link display in waiting lobby
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            if (gameLinkDisplay) {
                gameLinkDisplay.classList.add('hidden');
            }
            if (gameLinkDisplayMobile) {
                gameLinkDisplayMobile.classList.add('hidden');
            }
            
            gameSettingsScreen.querySelectorAll('input, button').forEach(el => {
                if (el.id !== 'displayGameId' && el.id !== 'copyGameIdBtn') el.disabled = true;
            });
            startGameBtn.textContent = 'Waiting for Host to Start...';
            displayGameId.textContent = currentGameId;
            
            // Show game-settings-only elements (but disabled)
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'block';
            if (propertiesEditor) propertiesEditor.style.display = 'grid';
            if (lobbyControls) lobbyControls.style.display = 'flex';
            if (allowTradingContainer) allowTradingContainer.style.display = 'flex';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'block';
        }

        // Apply map-specific theme to board
        function applyMapTheme() {
            if (!gameData || !gameData.settings) return;
            
            const mapThemes = {
                classic: {
                    boardBg: 'linear-gradient(135deg, #f5e6d3 0%, #e8d4ba 50%, #f5e6d3 100%)',
                    bodyBg: '#0D0C14',
                    borderColor: '#374151'
                },
                turkey: {
                    boardBg: 'linear-gradient(135deg, #f5e6d3 0%, #ffd6d6 50%, #f5e6d3 100%)',
                    bodyBg: '#0D0C14',
                    borderColor: '#e30a17'
                },
                world: {
                    boardBg: 'linear-gradient(135deg, #e8f4ff 0%, #c8e0f5 50%, #e8f4ff 100%)',
                    bodyBg: '#0D0C14',
                    borderColor: '#0066cc'
                },
                holland: {
                    boardBg: 'linear-gradient(135deg, #fff5e6 0%, #ffe0b3 50%, #fff5e6 100%)',
                    bodyBg: '#0D0C14',
                    borderColor: '#ff6600'
                },
                mega_rich: {
                    boardBg: 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%)',
                    bodyBg: '#0D0C14',
                    borderColor: '#d4af37'
                }
            };
            
            const currentMap = gameData.settings.map || 'classic';
            const theme = mapThemes[currentMap] || mapThemes.classic;
            
            // Apply theme to board
            board.style.background = theme.boardBg;
            board.style.borderColor = theme.borderColor;
            
            // Apply theme to body
            document.body.style.backgroundColor = theme.bodyBg;
            document.body.style.backgroundImage = 'radial-gradient(circle at 1px 1px, rgba(167, 139, 250, 0.1) 1px, transparent 0)';
            document.body.style.backgroundSize = '30px 30px';
            document.body.style.backgroundAttachment = 'fixed';
            
            console.log('üé® Applied theme for map:', currentMap);
        }

        function showGame() {
            lobby.classList.add('hidden');
            lobby.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; z-index: -9999 !important;';
            
            gameSettingsScreen.classList.add('hidden');
            gameSettingsScreen.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; z-index: -9999 !important;';
            
            gameContainer.classList.remove('hidden');
            gameContainer.style.cssText = 'display: flex !important; visibility: visible !important; position: relative !important; z-index: 1 !important;';
            
            // Mobilde oyun kontrol butonlarƒ±nƒ± g√∂stermek i√ßin body'ye in-game class'ƒ± ekle
            document.body.classList.add('in-game');
            
            // Show chat panel
            const chatPanel = document.getElementById('chat-panel');
            if (chatPanel) {
                chatPanel.style.display = 'flex';
            }
            
            // Show game link display
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkInput = document.getElementById('game-link-input');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            const gameLinkInputMobile = document.getElementById('game-link-input-mobile');
            
            if (gameLinkDisplay && gameLinkInput) {
                const currentUrl = window.location.origin + window.location.pathname;
                const gameLink = `${currentUrl}?gameId=${currentGameId}`;
                gameLinkInput.value = gameLink;
                gameLinkDisplay.classList.remove('hidden');
            }
            
            if (gameLinkDisplayMobile && gameLinkInputMobile) {
                const currentUrl = window.location.origin + window.location.pathname;
                const gameLink = `${currentUrl}?gameId=${currentGameId}`;
                gameLinkInputMobile.value = gameLink;
                gameLinkDisplayMobile.classList.remove('hidden');
            }
            
            // Hide game-settings-only elements
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'none';
            if (propertiesEditor) propertiesEditor.style.display = 'none';
            if (lobbyControls) lobbyControls.style.display = 'none';
            if (allowTradingContainer) allowTradingContainer.style.display = 'none';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'none';
            
            // Apply map theme (unless dark mode is on)
            if (!isDarkMode) {
                applyMapTheme();
            } else {
                applyDarkMode();
            }
            
            console.log('‚úÖ Showing game screen');
        }

        // --- SETTINGS EDITOR ---
        function populateSettingsEditor(boardData) {
            propertiesEditor.innerHTML = '';
            boardData.forEach((prop, index) => {
                if (prop.type === 'property' || prop.type === 'railroad' || prop.type === 'utility') {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg bg-gray-50';
                    div.innerHTML = `
                        <label class="block text-xs font-bold text-gray-600">Space ${index}</label>
                        <input data-index="${index}" data-field="name" type="text" value="${prop.name}" class="w-full text-sm font-semibold border-b bg-transparent">
                        <input data-index="${index}" data-field="price" type="number" value="${prop.price || ''}" class="w-full text-sm mt-1 border-b bg-transparent" placeholder="Price">
                    `;
                    propertiesEditor.appendChild(div);
                }
            });
        }
        
        function getEditedBoardData() {
            const newBoard = JSON.parse(JSON.stringify(getDefaultBoard())); // Deep copy
            propertiesEditor.querySelectorAll('input').forEach(input => {
                const index = input.dataset.index;
                const field = input.dataset.field;
                const value = field === 'price' ? parseInt(input.value) : input.value;
                if(newBoard[index] && field in newBoard[index]) {
                    newBoard[index][field] = value;
                }
            });
            return newBoard;
        }

        // --- REAL-TIME LISTENER ---
        // No longer needed - WebSocket automatically receives updates

        function updateLobbyUI() {
            lobbyPlayersList.innerHTML = gameData.players.map(p => `
                <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-md">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${p.color};"></div>
                    <span class="font-medium">${p.name} ${p.isBot ? 'ü§ñ' : (characterIcons[p.character] || '')}</span>
                </div>
            `).join('');
            startGameBtn.disabled = gameData.players.length < 2;

            const joinBtn = document.getElementById('joinGameBtn');
            if (gameData && gameData.state === 'playing') {
                joinBtn.disabled = true;
                joinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                joinBtn.innerText = 'Oyun Ba≈üladƒ±';
            } else {
                joinBtn.disabled = false;
                joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                joinBtn.innerText = 'Join Game';
            }
            
            // Update character availability based on taken characters
            updateCharacterAvailability();
        }

        // --- GAME UI RENDERING ---
        function renderBoard() {
            if (!gameData || !gameData.settings) {
                console.error('‚ùå Cannot render board: gameData or settings missing');
                return;
            }
            
            console.log('üé® Rendering board...');
            console.log('üìã Map selected:', gameData.settings.map);
            console.log('üìç Total spaces:', gameData.settings.board.length);
            console.log('üìç First 5 spaces:', gameData.settings.board.slice(0, 5).map(s => s.name));
            console.log('üìç Spaces 10-15:', gameData.settings.board.slice(10, 15).map(s => s.name));
            console.log('üìç Last 3 spaces:', gameData.settings.board.slice(-3).map(s => s.name));
            
            // Apply map-specific theme
            applyMapTheme();
            
            const spacesContainer = document.createDocumentFragment();
            gameData.settings.board.forEach((spaceData, i) => {
                const spaceEl = document.createElement('div');
                spaceEl.id = `space-${i}`;
                spaceEl.className = 'space';
                
                // Add corner class for special spaces
                if ([0, 10, 20, 30].includes(i)) {
                    spaceEl.classList.add('corner');
                }
                
                let content = `<div class="font-bold uppercase">${spaceData.name}</div>`;
                // Price labels removed for cleaner board appearance
                let priceLabel = '';
                /*
                if (spaceData.type === 'property' || spaceData.type === 'railroad' || spaceData.type === 'utility') {
                    if (i >=1 && i <=9) { // bottom row - √ºstlerinde
                        priceLabel = `<div class="price price-top">üí∞ $${spaceData.price}</div>`;
                    } else if (i >=21 && i <=30) { // top row - altlarƒ±nda
                        priceLabel = `<div class="price price-bottom">üí∞ $${spaceData.price}</div>`;
                    } else if (i >=11 && i <=19) { // left col - saƒülarƒ±nda
                        priceLabel = `<div class="price price-right">üí∞ $${spaceData.price}</div>`;
                    } else if (i >=31 && i <=39) { // right col - sollarƒ±nda
                        priceLabel = `<div class="price price-left">üí∞ $${spaceData.price}</div>`;
                    }
                }
                */
                if (spaceData.type === 'property') {
                    const property = gameData.properties[i];
                    let ownersHTML = '';
                    if (property && property.owners) {
                        ownersHTML = Object.entries(property.owners).map(([ownerId, percentage]) => {
                            const owner = gameData.players.find(p => p.id === ownerId);
                            if (!owner) return '';
                            return `<span class="inline-block text-[8px] mr-1 px-1 py-0.5 rounded bg-gray-100 border border-gray-300" style="color:${owner.color}">${owner.name} <span class="font-bold">${percentage}%</span></span>`;
                        }).join(' ');
                    }
                    const ownerColor = property && property.ownerId ? (gameData.players.find(p => p.id === property.ownerId)?.color || '#ffffff') : '#ffffff';
                    content = `
                        <div class="houses-container"></div>
                        <div class="color-bar" style="background: linear-gradient(135deg, ${spaceData.color} 0%, ${adjustColor(spaceData.color, -20)} 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <div class="p-1 flex-grow flex flex-col justify-center" style="background: ${ownerColor ? `linear-gradient(135deg, ${ownerColor}20 0%, ${ownerColor}40 100%)` : 'transparent'}; border: ${ownerColor ? `2px solid ${ownerColor}` : 'none'}; border-radius: 4px;">
                           <div class="font-bold text-[12px] uppercase leading-tight">${spaceData.name}</div>
                           ${ownersHTML ? `<div class="text-[8px] text-gray-700 mt-1">Owners: ${ownersHTML}</div>` : ''}
                        </div>`;
                } else if(spaceData.type === 'railroad') {
                     content = `<div class="text-center p-2"><div class="text-2xl">üöÇ</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'utility') {
                     const icon = spaceData.name.includes('Electric') ? '‚ö°' : 'üíß';
                     content = `<div class="text-center p-2"><div class="text-2xl">${icon}</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'tax') {
                     content = `<div class="text-center p-2"><div class="text-2xl">üí∏</div><div class="font-bold text-[11px]">${spaceData.name}</div><div class="text-[10px]">Pay $${spaceData.amount}</div></div>`;
                } else if(spaceData.type === 'chance') {
                     content = `<div class="text-center p-2"><div class="text-2xl">‚ùì</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'community_chest') {
                     content = `<div class="text-center p-2"><div class="text-2xl">üéÅ</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'go') {
                     content = `<div class="text-center p-2"><div class="text-3xl">‚û°Ô∏è</div><div class="font-bold text-[13px]">GO</div><div class="text-[11px]">Collect $200</div></div>`;
                } else if(spaceData.type === 'jail') {
                     content = `<div class="text-center p-2"><div class="text-3xl">üîí</div><div class="font-bold text-[11px]">Jail</div></div>`;
                } else if(spaceData.type === 'free_parking') {
                     content = `<div class="text-center p-2"><div class="text-3xl">üÖøÔ∏è</div><div class="font-bold text-[11px]">Free Parking</div></div>`;
                } else if(spaceData.type === 'go_to_jail') {
                     content = `<div class="text-center p-2"><div class="text-3xl">üëÆ</div><div class="font-bold text-[11px]">Go To Jail</div></div>`;
                }
                
                spaceEl.innerHTML = content + priceLabel;
                spacesContainer.appendChild(spaceEl);
                
                // üè† Add click event to show property details
                if (spaceData.type === 'property' || spaceData.type === 'railroad' || spaceData.type === 'utility') {
                    spaceEl.style.cursor = 'pointer';
                    spaceEl.addEventListener('click', () => {
                        showPropertyDetails(i, spaceData);
                    });
                }
            });
             const piecesContainer = document.createElement('div');
             piecesContainer.id = "pieces-container";
             piecesContainer.style.position = 'relative';
             piecesContainer.style.gridColumn = '1 / -1';
             piecesContainer.style.gridRow = '1 / -1';
             piecesContainer.style.pointerEvents = 'none';

             board.querySelectorAll('.space').forEach(s => s.remove());
             board.appendChild(spacesContainer);
             board.appendChild(piecesContainer);
        }

        function updateBoardTitle() {
            if (!gameData || !gameData.players || !turnStartTime) {
                document.getElementById('board-title').textContent = 'BUSINESS';
                return;
            }
            
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            if (!currentPlayer || currentPlayer.isBot) {
                document.getElementById('board-title').textContent = 'BUSINESS';
                return;
            }
            
            const elapsed = Math.floor((Date.now() - turnStartTime) / 1000);
            const remaining = Math.max(0, 90 - elapsed);
            
            document.getElementById('board-title').textContent = `${currentPlayer.name} - ${remaining}s`;
        }

        function updateGameUI() {
            updatePlayersInfo();
            updateBoardPiecesAndHouses();
            updateControls();
            updateGameLog();
            updateBoardTitle();
            
            // Update dice display if lastDiceRoll exists
            if (gameData.lastDiceRoll && gameData.lastDiceRoll.length === 2) {
                updateDiceDisplay(gameData.lastDiceRoll[0], gameData.lastDiceRoll[1]);
            }
            
            // ‚è∞ Handle turn timer for auto-end turn
            handleTurnTimer();
            
            // Leaderboard kaldƒ±rƒ±ldƒ±
        }

        // ‚è∞ Handle turn timer for auto-end turn
        function handleTurnTimer() {
            if (!gameData || !gameData.players) return;
            
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.id === localPlayer.id;
            
            // Clear existing timer and interval
            if (turnTimer) {
                clearTimeout(turnTimer);
                turnTimer = null;
            }
            if (turnUpdateInterval) {
                clearInterval(turnUpdateInterval);
                turnUpdateInterval = null;
            }
            turnStartTime = null;
            
            // Start timer if it's our turn and we're not a bot
            if (isMyTurn && !currentPlayer.isBot) {
                console.log('‚è∞ Starting turn timer (90 seconds)');
                turnStartTime = Date.now();
                turnTimer = setTimeout(() => {
                    console.log('‚è∞ Turn timer expired, auto-ending turn');
                    // Clear interval
                    if (turnUpdateInterval) {
                        clearInterval(turnUpdateInterval);
                        turnUpdateInterval = null;
                    }
                    turnStartTime = null;
                    // Reset board title
                    document.getElementById('board-title').textContent = 'BUSINESS';
                    // Auto-end turn
                    sendMessage({
                        type: 'end_turn',
                        gameId: currentGameId
                    });
                }, 90000); // 1.5 minutes = 90 seconds
                
                // Start interval to update board title every second
                turnUpdateInterval = setInterval(() => {
                    updateBoardTitle();
                }, 1000);
            } else {
                // Not our turn or bot, reset title
                document.getElementById('board-title').textContent = 'BUSINESS';
            }
        }

        function updatePlayersInfo() {
            if (!gameData || !gameData.players) {
                showModal('Error', 'Oyuncu verisi eksik. L√ºtfen tekrar baƒülanƒ±n.', [{text:'Tamam', class:'bg-red-500', action:hideModal}]);
                return;
            }
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            playersInfo.innerHTML = gameData.players.map((p) => {
                if (p.isBankrupt) return '';
                const isCurrent = p.id === currentPlayer.id;
                // Team badge
                const teamBadges = {
                    red: 'üî¥',
                    blue: 'üîµ',
                    green: 'üü¢',
                    yellow: 'üü°'
                };
                const teamBadge = p.team ? teamBadges[p.team] || '' : '';
                // Sahip olunan kartlarƒ± al ve mini ikonlar olarak g√∂ster
                const playerProperties = gameData.properties
                    .map((prop, idx) => ({...prop, spaceIndex: idx}))
                    .filter(prop => prop.owners && prop.owners[p.id] > 0);
                let propertiesHTML = '';
                if (playerProperties.length > 0) {
                    // Mobile: expandable property list
                    propertiesHTML = `
                        <div class="mt-2">
                            <button class="property-list-toggle text-xs bg-gray-200 px-2 py-1 rounded mb-1" onclick="window.togglePropertyList('${p.id}')">${playerProperties.length} Properties ‚ñº</button>
                            <div class="property-list hidden flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                                ${playerProperties.map(prop => {
                                    const space = gameData.settings.board[prop.spaceIndex];
                                    const propColor = space.color || '#cccccc';
                                    const housesDisplay = prop.houses > 0 ? (prop.houses === 5 ? 'üè®' : `üè†${prop.houses}`) : '';
                                    const share = prop.owners[p.id] || 0;
                                    return `<div class=\"property-mini-icon text-xs px-1 py-0.5 rounded border\" style=\"background: linear-gradient(135deg, ${propColor} 0%, ${p.color}40 100%); border-color: ${p.color}; min-width: 40px;\" title=\"${space.name}\">${space.name.substring(0, 3)}${housesDisplay} <span class=\"font-bold text-[8px]\">${share}%</span></div>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="player-card border rounded-xl p-3 ${isCurrent ? 'border-blue-500 border-2 shadow-xl bg-gradient-to-r from-blue-50 to-white' : 'border-gray-200 bg-white'} transition-all duration-300 cursor-pointer hover:shadow-lg" data-player-id="${p.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full shadow-md" style="background: linear-gradient(135deg, ${p.color} 0%, ${adjustColor(p.color, -30)} 100%); border: 2px solid white;"></div>
                                <span class="font-bold text-lg">${teamBadge} ${p.name} ${p.id === localPlayer.id ? '(You)' : ''} ${p.isLucky && p.luckyTurnsLeft > 0 ? `‚≠ê(${p.luckyTurnsLeft} turns)` : ''}</span>
                            </div>
                            <span class="font-semibold text-green-600 text-xl">üí∞ $${p.money}</span>
                        </div>
                        ${p.creditAmount > 0 ? `
                        <div class="mt-2 bg-red-50 border border-red-300 rounded-lg p-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-red-600 font-semibold">üí≥ Kredi: $${p.creditAmount}</span>
                                <span class="text-red-500 text-xs">‚è∞ ${p.creditTurnsLeft} tur kaldƒ±</span>
                            </div>
                        </div>
                        ` : ''}
                        ${propertiesHTML}
                        <div class="flex justify-between items-center mt-2">
                            ${p.inJail ? `<div class="text-red-500 font-bold text-sm flex items-center gap-1">üîí IN JAIL</div>` : '<div></div>'}
                            <div class="flex gap-2">
                                ${p.id === localPlayer.id && p.money < 0 ? `<button onclick="window.declareBankruptcy()" class="text-xs bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-lg hover:from-red-600 hover:to-red-700 shadow transition-all">üí• ƒ∞flas Et</button>` : ''}
                                ${p.id !== localPlayer.id && gameData.settings.allowTrading ? `<button data-player-id="${p.id}" onclick="window.showTradeModal('${p.id}')" class="trade-btn text-xs bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-lg hover:from-blue-600 hover:to-blue-700 shadow transition-all">ü§ù Trade</button>` : ''}
                                ${p.id === gameData.hostId && localPlayer.id === gameData.hostId ? `<button onclick="showGameManagementModal()" class="text-xs bg-gradient-to-r from-purple-500 to-purple-600 text-white px-3 py-1 rounded-lg hover:from-purple-600 hover:to-purple-700 shadow transition-all">üéÆ Oyun Y√∂netimi</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        // Mobile: property list toggle logic
        window.togglePropertyList = function(playerId) {
            document.querySelectorAll('.player-card').forEach(card => {
                if (card.dataset.playerId === playerId) {
                    const list = card.querySelector('.property-list');
                    if (list) {
                        list.classList.toggle('hidden');
                    }
                }
            });
        }
        
        window.showGameManagementModal = function() {
            // Only host can access
            if (localPlayer.id !== gameData.hostId) {
                alert('Only the host can manage the game!');
                return;
            }
            
            const modal = document.getElementById('game-management-modal');
            const playersContainer = document.getElementById('game-management-players');
            
            playersContainer.innerHTML = gameData.players.map(p => {
                const isCurrent = gameData.players[gameData.currentPlayerIndex].id === p.id;
                return `
                <div class="bg-gradient-to-r from-gray-50 to-white p-4 rounded-lg border-2 ${isCurrent ? 'border-blue-500' : 'border-gray-200'} shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full border-2 border-white shadow" style="background: ${p.color}"></div>
                            <div>
                                <span class="font-bold text-lg">${p.name}</span>
                                <span class="text-xs text-gray-500 ml-2">${isCurrent ? 'üé≤ Current Turn' : ''}</span>
                                <div class="text-sm text-green-600 font-semibold">üí∞ $${p.money}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        ${!p.isBankrupt ? `
                        <button onclick="adjustMoney('${p.id}', 100)" class="text-xs bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition">
                            üí∞ +$100
                        </button>
                        <button onclick="adjustMoney('${p.id}', -100)" class="text-xs bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 transition">
                            üí∏ -$100
                        </button>
                        <button onclick="adjustMoneyCustom('${p.id}')" class="text-xs bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition">
                            üíµ Custom Amount
                        </button>
                        ${isCurrent ? `
                        <button onclick="forceEndTurnPlayer('${p.id}')" class="text-xs bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 transition">
                            ‚è≠Ô∏è Force End Turn
                        </button>
                        ` : '<div></div>'}
                        <button onclick="teleportPlayer('${p.id}')" class="text-xs bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 transition col-span-2">
                            üìç Teleport Player
                        </button>
                        ` : ''}
                        ${p.id !== localPlayer.id ? `
                        <button onclick="kickPlayer('${p.id}')" class="text-xs bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition col-span-2">
                            ‚ùå Kick Player
                        </button>
                        ` : '<div class="col-span-2 text-xs text-gray-500 text-center">You cannot kick yourself</div>'}
                    </div>
                </div>
            `}).join('');
            
            modal.classList.remove('hidden');
        };
        
        window.hideGameManagementModal = function() {
            document.getElementById('game-management-modal').classList.add('hidden');
        };
        
        window.adjustMoney = async function(playerId, amount) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            player.money += amount;
            await updateGame({ players: gameData.players });
            
            const action = amount > 0 ? 'added' : 'removed';
            const absAmount = Math.abs(amount);
            addLog(`üéÆ Host ${action} $${absAmount} ${amount > 0 ? 'to' : 'from'} ${player.name}'s account`);
            
            // Refresh modal
            showGameManagementModal();
        };
        
        window.adjustMoneyCustom = async function(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            const amount = prompt(`Enter amount to add/remove from ${player.name}:\n(Use negative numbers to remove money)\nCurrent: $${player.money}`);
            if (amount === null || amount === '') return;
            
            const numAmount = parseInt(amount);
            if (isNaN(numAmount)) {
                alert('Please enter a valid number');
                return;
            }
            
            player.money += numAmount;
            await updateGame({ players: gameData.players });
            
            const action = numAmount > 0 ? 'added' : 'removed';
            const absAmount = Math.abs(numAmount);
            addLog(`üéÆ Host ${action} $${absAmount} ${numAmount > 0 ? 'to' : 'from'} ${player.name}'s account`);
            
            // Refresh modal
            showGameManagementModal();
        };
        
        window.teleportPlayer = async function(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            const position = prompt(`Teleport ${player.name} to position (0-39):\nCurrent position: ${player.position}`);
            if (position === null || position === '') return;
            
            const numPosition = parseInt(position);
            if (isNaN(numPosition) || numPosition < 0 || numPosition > 39) {
                alert('Please enter a valid position (0-39)');
                return;
            }
            
            const oldPos = player.position;
            player.position = numPosition;
            await updateGame({ players: gameData.players });
            
            const spaceName = gameData.settings.board[numPosition].name;
            addLog(`üéÆ Host teleported ${player.name} from position ${oldPos} to ${numPosition} (${spaceName})`);
            
            // Refresh modal
            showGameManagementModal();
        };
        
        window.kickPlayer = async function(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            if (!confirm(`Are you sure you want to kick ${player.name}?`)) return;
            
            const playersCopy = gameData.players.filter(p => p.id !== playerId);
            
            // üè¶ Kick edilen oyuncunun t√ºm property'lerini bankaya devret (sƒ±fƒ±rla)
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            propertiesCopy.forEach((prop, index) => {
                if (prop.ownerId === playerId) {
                    // Property'yi bankaya devret - hi√ß satƒ±n alƒ±nmamƒ±≈ü gibi yap
                    prop.ownerId = null;
                    prop.houses = 0;
                    prop.mortgaged = false;
                    // Shared ownership varsa onu da temizle
                    if (prop.owners) {
                        delete prop.owners[playerId];
                        // Eƒüer ba≈üka owner yoksa owners objesini de temizle
                        if (Object.keys(prop.owners).length === 0) {
                            prop.owners = null;
                        }
                    }
                }
            });
            
            await updateGame({ players: playersCopy, properties: propertiesCopy });
            hideGameManagementModal();
            addLog(`üéÆ Host kicked ${player.name} from the game. All their properties returned to the bank.`);
        };
        
        window.forceEndTurnPlayer = async function(playerId) {
            if (gameData.players[gameData.currentPlayerIndex].id !== playerId) {
                alert('This player is not currently taking their turn.');
                return;
            }
            
            const player = gameData.players.find(p => p.id === playerId);
            sendMessage({
                type: 'update_game',
                gameId: currentGameId,
                updates: {
                    currentPlayerIndex: (gameData.currentPlayerIndex + 1) % gameData.players.length,
                    turnState: 'start'
                }
            });
            
            hideGameManagementModal();
            addLog(`üéÆ Host forced ${player.name} to end their turn`);
        };
            
            // Add click event to show player stats
            document.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking trade button
                    if (e.target.classList.contains('trade-btn')) return;
                    const playerId = card.dataset.playerId;
                    showPlayerStats(playerId);
                });
            });
        }

        // ü§ñ Bot AI - Handle bot turns automatically
        function handleBotTurn() {
            if (!gameData || !gameData.players || gameData.players[gameData.currentPlayerIndex].id === localPlayer.id) {
                return; // Not bot's turn or no game data
            }
            
            const bot = gameData.players[gameData.currentPlayerIndex];
            if (!bot.isBot) return;
            
            console.log(`ü§ñ Bot ${bot.name}'s turn`);
            
            // Simple bot AI logic
            setTimeout(() => {
                // Roll dice
                sendMessage({ type: 'roll_dice' });
                
                // After rolling, wait a bit then make decisions
                setTimeout(() => {
                    // If bot landed on an unowned property, decide whether to buy
                    const currentSpace = gameData.settings.board[bot.position];
                    if (currentSpace && currentSpace.type === 'property' && !gameData.properties[bot.position].ownerId) {
                        const canAfford = bot.money >= currentSpace.price;
                        if (canAfford && Math.random() > 0.3) { // 70% chance to buy
                            setTimeout(() => sendMessage({ type: 'buy_property' }), 1000);
                        } else {
                            // Don't buy, end turn
                            setTimeout(() => sendMessage({ type: 'end_turn' }), 1000);
                        }
                    } else {
                        // Not on a buyable property, end turn
                        setTimeout(() => sendMessage({ type: 'end_turn' }), 1000);
                    }
                }, 2000);
            }, 500);
        }

        // üìä Show Player Statistics Modal
        function showPlayerStats(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            // Calculate statistics
            // Find all properties where player owns a share
            const properties = gameData.properties
                .map((prop, idx) => ({...prop, spaceIndex: idx}))
                .filter(prop => prop.owners && prop.owners[playerId] > 0);
            const totalProperties = properties.length;
            let totalPropertyValue = 0;
            properties.forEach(prop => {
                const space = gameData.settings.board[prop.spaceIndex];
                if (space.price) {
                    totalPropertyValue += space.price * (prop.owners[playerId] || 0) / 100;
                    if (prop.houses > 0 && prop.houses < 5) {
                        totalPropertyValue += prop.houses * (space.houseCost || 50) * (prop.owners[playerId] || 0) / 100;
                    } else if (prop.houses === 5) {
                        totalPropertyValue += 5 * (space.houseCost || 50) * (prop.owners[playerId] || 0) / 100;
                    }
                }
            });
            
            const totalWealth = player.money + totalPropertyValue;
            const emoji = player.isBot ? 'ü§ñ' : (characterIcons[player.character] || '‚ùì');
            
            // Stats tracking (you can extend this by adding these to player object)
            const jailTimes = player.jailCount || 0;
            const doubles = player.doublesCount || 0;
            
            // Find most expensive property
            let mostExpensive = null;
            let maxPrice = 0;
            properties.forEach(prop => {
                const space = gameData.settings.board[prop.spaceIndex];
                if (space.price && space.price > maxPrice) {
                    maxPrice = space.price;
                    mostExpensive = space.name;
                }
            });
            
            // Expandable property list for modal
            let propertiesListHTML = '';
            if (properties.length > 0) {
                propertiesListHTML = `
                    <div class="mt-4">
                        <button id="modal-property-list-toggle" class="property-list-toggle text-xs bg-gray-200 px-2 py-1 rounded mb-1">${properties.length} Properties ‚ñº</button>
                        <div id="modal-property-list" class="property-list hidden flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                            ${properties.map(prop => {
                                const space = gameData.settings.board[prop.spaceIndex];
                                const propColor = space.color || '#cccccc';
                                const housesDisplay = prop.houses > 0 ? (prop.houses === 5 ? 'üè®' : `üè†${prop.houses}`) : '';
                                const share = prop.owners[playerId] || 0;
                                return `<div class=\"property-mini-icon text-xs px-1 py-0.5 rounded border\" style=\"background: linear-gradient(135deg, ${propColor} 0%, ${player.color}40 100%); border-color: ${player.color}; min-width: 40px;\" title=\"${space.name}\">${space.name.substring(0, 3)}${housesDisplay} <span class=\"font-bold text-[8px]\">${share}%</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            const statsHTML = `
                <div class="text-center mb-4">
                    <div class="text-6xl mb-2">${emoji}</div>
                    <div class="text-2xl font-bold" style="color: ${player.color}">${player.name}</div>
                </div>
                <div class="space-y-3 text-left">
                    <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                        <div class="text-sm text-gray-600">üí∞ Total Wealth</div>
                        <div class="text-2xl font-bold text-green-700">$${totalWealth}</div>
                        <div class="text-xs text-gray-500">Cash: $${player.money} + Properties: $${totalPropertyValue.toFixed(0)}</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="text-sm text-gray-600">üè† Properties Owned</div>
                        <div class="text-xl font-bold text-blue-700">${totalProperties} properties</div>
                        ${propertiesListHTML}
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                        <div class="text-sm text-gray-600">üíé Most Expensive Property</div>
                        <div class="text-lg font-bold text-purple-700">${mostExpensive || 'None'}</div>
                        ${mostExpensive ? `<div class="text-xs text-gray-500">$${maxPrice}</div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-red-50 p-2 rounded-lg border-l-4 border-red-500">
                            <div class="text-xs text-gray-600">üîí Jail Visits</div>
                            <div class="text-xl font-bold text-red-700">${jailTimes}</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded-lg border-l-4 border-yellow-500">
                            <div class="text-xs text-gray-600">üé≤ Lucky Doubles</div>
                            <div class="text-xl font-bold text-yellow-700">${doubles}</div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`üìä Player Statistics`, statsHTML, [
                { text: 'Close', class: 'bg-blue-500', action: hideModal },
                ...(playerId === localPlayer.id && player.money < 0 ? [{ text: 'üí• ƒ∞flas Et', class: 'bg-red-600', action: () => {
                    hideModal();
                    setTimeout(() => window.declareBankruptcy(), 300);
                }}] : [])
            ]);
            // Add toggle logic for modal property list
            setTimeout(() => {
                const toggleBtn = document.getElementById('modal-property-list-toggle');
                const list = document.getElementById('modal-property-list');
                if (toggleBtn && list) {
                    toggleBtn.onclick = () => {
                        list.classList.toggle('hidden');
                    };
                }
            }, 100);
        }

        // üè† Show Property Details Modal
        function showPropertyDetails(position, spaceData) {
            const property = gameData.properties[position];
            // Owner bilgisini al (hisse sistemi varsa ilk owner'ƒ±, yoksa ownerId'den)
            let owner = null;
            if (property && property.owners && Object.keys(property.owners).length > 0) {
                const firstOwnerId = Object.keys(property.owners)[0];
                owner = gameData.players.find(p => p.id === firstOwnerId);
            } else if (property && property.ownerId) {
                owner = gameData.players.find(p => p.id === property.ownerId);
            }
            
            let detailsHTML = `
                <div class="text-center mb-4">
                    <div class="text-3xl mb-2">${spaceData.type === 'property' ? 'üè†' : spaceData.type === 'railroad' ? 'üöÇ' : '‚ö°'}</div>
                    <div class="text-2xl font-bold">${spaceData.name}</div>
                    ${spaceData.color ? `<div class="w-full h-3 rounded-full mt-2" style="background: ${spaceData.color};"></div>` : ''}
                </div>
            `;
            if (spaceData.type === 'property') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">üí∞ Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">üíµ Rent Details</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between"><span>Base Rent:</span><span class="font-bold">$${spaceData.rent[0]}</span></div>
                                <div class="flex justify-between"><span>With 1 House:</span><span class="font-bold">$${spaceData.rent[1]}</span></div>
                                <div class="flex justify-between"><span>With 2 Houses:</span><span class="font-bold">$${spaceData.rent[2]}</span></div>
                                <div class="flex justify-between"><span>With 3 Houses:</span><span class="font-bold">$${spaceData.rent[3]}</span></div>
                                <div class="flex justify-between"><span>With 4 Houses:</span><span class="font-bold">$${spaceData.rent[4]}</span></div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1"><span class="font-bold">With Hotel:</span><span class="font-bold text-purple-700">$${spaceData.rent[5]}</span></div>
                            </div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-500">
                            <div class="text-sm text-gray-600">üèóÔ∏è House Cost</div>
                            <div class="text-xl font-bold text-orange-700">$${spaceData.houseCost || 50} each</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                            <div class="text-sm text-gray-600">üë§ Owners</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${property && property.owners ? Object.entries(property.owners).map(([ownerId, percentage]) => {
                                    const owner = gameData.players.find(p => p.id === ownerId);
                                    if (!owner) return '';
                                    return `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300\" style=\"color:${owner.color}\">${owner.name} <span class=\"font-bold\">${percentage}%</span></span>`;
                                }).join(' ') : '<span class="text-gray-500">üÜì Available for Purchase</span>'}
                            </div>
                            ${property && property.houses > 0 ? `<div class="text-sm text-gray-600 mt-1">${property.houses === 5 ? 'üè® Hotel' : `üè† ${property.houses} House${property.houses > 1 ? 's' : ''}`}</div>` : ''}
                        </div>
                    </div>
                `;
            } else if (spaceData.type === 'railroad') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">üí∞ Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">üíµ Rent by Railroads Owned</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>1 Railroad:</span>
                                    <span class="font-bold">$25</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>2 Railroads:</span>
                                    <span class="font-bold">$50</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>3 Railroads:</span>
                                    <span class="font-bold">$100</span>
                                </div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1">
                                    <span class="font-bold">4 Railroads:</span>
                                    <span class="font-bold text-purple-700">$200</span>
                                </div>
                            </div>
                        </div>
                        
                            <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                            <div class="text-sm text-gray-600">üë§ Owners</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${property && property.owners ? Object.entries(property.owners).map(([ownerId, percentage]) => {
                                    const ownerPlayer = gameData.players.find(p => p.id === ownerId);
                                    if (!ownerPlayer) return '';
                                    return `<span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300" style="color:${ownerPlayer.color}">${ownerPlayer.name} <span class="font-bold">${percentage}%</span></span>`;
                                }).join(' ') : owner ? `<span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300" style="color:${owner.color}">${owner.name} ${characterIcons[owner.character] || ''} 100%</span>` : '<span class="text-gray-500">üÜì Available for Purchase</span>'}
                            </div>
                            ${property && property.mortgaged ? `<div class="text-sm text-red-600 mt-1">üîí MORTGAGED</div>` : ''}
                        </div>
                    </div>
                `;
            } else if (spaceData.type === 'utility') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">üí∞ Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">üíµ Rent Formula</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>1 Utility Owned:</span>
                                    <span class="font-bold">4√ó Dice Roll</span>
                                </div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1">
                                    <span class="font-bold">2 Utilities Owned:</span>
                                    <span class="font-bold text-purple-700">10√ó Dice Roll</span>
                                </div>
                            </div>
                        </div>
                        
                            <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                            <div class="text-sm text-gray-600">üë§ Owners</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${property && property.owners ? Object.entries(property.owners).map(([ownerId, percentage]) => {
                                    const ownerPlayer = gameData.players.find(p => p.id === ownerId);
                                    if (!ownerPlayer) return '';
                                    return `<span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300" style="color:${ownerPlayer.color}">${ownerPlayer.name} <span class="font-bold">${percentage}%</span></span>`;
                                }).join(' ') : owner ? `<span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300" style="color:${owner.color}">${owner.name} ${characterIcons[owner.character] || ''} 100%</span>` : '<span class="text-gray-500">üÜì Available for Purchase</span>'}
                            </div>
                            ${property && property.mortgaged ? `<div class="text-sm text-red-600 mt-1">üîí MORTGAGED</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± tipine g√∂re ayarla
            const modalTitle = spaceData.type === 'property' ? 'üè† Property Details' : spaceData.type === 'railroad' ? 'üöÇ Railroad Details' : '‚ö° Utility Details';
            
            showModal(modalTitle, detailsHTML, [
                { text: 'Close', class: 'bg-blue-500', action: hideModal }
            ]);
        }
        
        function updateBoardPiecesAndHouses() {
            const piecesContainer = document.getElementById('pieces-container');
            if (!piecesContainer) return;
            piecesContainer.innerHTML = ''; 
            
            // Display player emojis on board (always show them, not just after dice roll)
            gameData.players.forEach((p, i) => {
                if (p.isBankrupt) return;
                
                const pieceEl = document.createElement('div');
                pieceEl.className = 'player-piece';
                pieceEl.id = `piece-${p.id}`;
                
                // Get emoji from characterIcons (ü§ñ for bots)
                const emoji = p.isBot ? 'ü§ñ' : (characterIcons[p.character] || '‚ùì');
                
                // Debug log
                console.log(`üéÆ Player ${p.name}: character='${p.character}', emoji='${emoji}'`);
                
                pieceEl.textContent = emoji;
                
                const targetSpace = document.getElementById(`space-${p.position}`);
                if (targetSpace) {
                    // Calculate offset for multiple players on same space
                    // Group players by position
                    const playersOnSameSpace = gameData.players.filter(
                        player => player.position === p.position && !player.isBankrupt
                    );
                    const positionIndex = playersOnSameSpace.findIndex(player => player.id === p.id);
                    
                    // Arrange players in a 2x2 grid if multiple on same space
                    const offsetX = (positionIndex % 2) * 18;
                    const offsetY = Math.floor(positionIndex / 2) * 18;
                    
                    // Smooth transition i√ßin CSS ekle
                    pieceEl.style.transition = 'left 0.15s ease-out, top 0.15s ease-out';
                    
                    pieceEl.style.left = `${targetSpace.offsetLeft + 8 + offsetX}px`;
                    pieceEl.style.top = `${targetSpace.offsetTop + 8 + offsetY}px`;
                }
                piecesContainer.appendChild(pieceEl);
            });
            
            // Update property ownership and houses
            board.querySelectorAll('.owner-indicator, .houses-container > *').forEach(el => el.remove());
            gameData.properties.forEach((prop, i) => {
                const spaceEl = document.getElementById(`space-${i}`);
                if (!spaceEl) return;

                if (prop.ownerId) {
                    const owner = gameData.players.find(p => p.id === prop.ownerId);
                    if(owner) {
                        const indicator = document.createElement('div');
                        indicator.className = 'owner-indicator';
                        indicator.style.backgroundColor = owner.color;
                        spaceEl.appendChild(indicator);
                    }
                }
                
                if (prop.houses > 0) {
                    const housesContainer = spaceEl.querySelector('.houses-container');
                    if(housesContainer) {
                        if (prop.houses === 5) { // Hotel
                            const hotelEl = document.createElement('div');
                            hotelEl.className = 'hotel';
                            housesContainer.appendChild(hotelEl);
                        } else { // Houses
                            for (let j = 0; j < prop.houses; j++) {
                                const houseEl = document.createElement('div');
                                houseEl.className = 'house';
                                housesContainer.appendChild(houseEl);
                            }
                        }
                    }
                }
            });
            
            // Mobil players men√ºs√ºn√º g√ºncelle
            updateMobilePlayersBar();
        }
        
        function updateMobilePlayersBar() {
            const mobilePlayersList = document.getElementById('mobile-players-list');
            if (!mobilePlayersList || !gameData) return;
            
            mobilePlayersList.innerHTML = '';
            
            gameData.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'mobile-player-card';
                if (player.id === gameData.players[gameData.currentPlayerIndex].id) {
                    card.classList.add('active');
                }
                
                const emoji = player.isBot ? 'ü§ñ' : (characterIcons[player.character] || '‚ùì');
                const name = player.name.length > 8 ? player.name.substring(0, 8) + '...' : player.name;
                const money = `$${player.money}`;
                
                card.innerHTML = `
                    <div style="font-size: 1.5rem;">${emoji}</div>
                    <div style="font-weight: 600; color: ${player.color};">${name}</div>
                    <div style="color: #059669; font-size: 0.7rem;">${money}</div>
                `;
                
                card.onclick = () => {
                    showPlayerProfile(player);
                };
                
                // Trade butonu ekle (kendisi ve iflaslar hari√ß)
                if (player.id !== localPlayer.id && !player.isBankrupt) {
                    const tradeBtn = document.createElement('button');
                    tradeBtn.textContent = 'ü§ù';
                    tradeBtn.style.cssText = 'margin-top: 0.25rem; padding: 0.25rem 0.5rem; background: #1a73e8; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;';
                    tradeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Team manager'ƒ± a√ß
                        document.getElementById('teamManagerBtn').click();
                    });
                    card.appendChild(tradeBtn);
                }
                
                // Host management butonu (host ise ve kendisi hari√ß)
                if (localPlayer.id === gameData.players[0].id && player.id !== localPlayer.id) {
                    console.log('Adding manage button for player:', player.id);
                    const manageBtn = document.createElement('button');
                    manageBtn.textContent = '‚öôÔ∏è';
                    manageBtn.style.cssText = 'margin-top: 0.25rem; margin-left: 0.25rem; padding: 0.25rem 0.5rem; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;';
                    manageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log('manageBtn clicked, player.id:', player.id);
                        showGameManagementModal(player.id);
                    });
                    card.appendChild(manageBtn);
                }
                
                if (player.isBankrupt) {
                    card.style.opacity = '0.5';
                    card.style.textDecoration = 'line-through';
                }
                
                mobilePlayersList.appendChild(card);
            });
        }

        function updateControls() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isMyTurn = currentPlayer.id === localPlayer.id;

            dice1El.textContent = gameData.lastDiceRoll[0] || 'üé≤';
            dice2El.textContent = gameData.lastDiceRoll[1] || 'üé≤';

            const canAct = isMyTurn && !currentPlayer.isBankrupt;
            rollDiceBtn.disabled = !canAct || gameData.turnState !== 'start';
            
            // End turn butonu her zaman g√∂r√ºn√ºr ama sadece kendi turunda ve action_complete'de aktif
            endTurnBtn.classList.remove('hidden'); // Her zaman g√∂ster
            endTurnBtn.disabled = !canAct || gameData.turnState !== 'action_complete';
            if (!canAct) {
                endTurnBtn.style.opacity = '0.5';
                endTurnBtn.style.cursor = 'not-allowed';
            } else if (gameData.turnState !== 'action_complete') {
                endTurnBtn.style.opacity = '0.6';
                endTurnBtn.style.cursor = 'not-allowed';
            } else {
                endTurnBtn.style.opacity = '1';
                endTurnBtn.style.cursor = 'pointer';
            }
            
            managePropertiesBtn.classList.toggle('hidden', !canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete'));
            
            // üí≥ Kredi butonunu g√∂ster/gizle
            takeCreditBtn.classList.toggle('hidden', !canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete'));
            
            // Mobil butonlarƒ± da g√ºncelle
            const mobileRollBtn = document.getElementById('mobile-roll-btn');
            const mobileEndTurnBtn = document.getElementById('mobile-end-turn-btn');
            const mobilePropertiesBtn = document.getElementById('mobile-properties-btn');
            const mobileJokerBtn = document.getElementById('mobile-joker-btn');
            const mobileTeamBtn = document.getElementById('mobile-team-btn');
            
            if (mobileRollBtn) mobileRollBtn.disabled = !canAct || gameData.turnState !== 'start';
            if (mobileEndTurnBtn) {
                mobileEndTurnBtn.disabled = !canAct || gameData.turnState !== 'action_complete';
                mobileEndTurnBtn.style.display = 'inline-flex'; // Her zaman g√∂ster
                if (!canAct) {
                    mobileEndTurnBtn.style.opacity = '0.5';
                    mobileEndTurnBtn.style.cursor = 'not-allowed';
                } else if (gameData.turnState !== 'action_complete') {
                    mobileEndTurnBtn.style.opacity = '0.6';
                    mobileEndTurnBtn.style.cursor = 'not-allowed';
                } else {
                    mobileEndTurnBtn.style.opacity = '1';
                    mobileEndTurnBtn.style.cursor = 'pointer';
                }
            }
            if (mobilePropertiesBtn) {
                mobilePropertiesBtn.disabled = !canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete');
                mobilePropertiesBtn.style.display = (!canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete')) ? 'none' : 'inline-flex';
            }
            // Team, Joker her zaman g√∂r√ºn√ºr (team her oyuncu yapabilir, joker kendi turunda)
            if (mobileJokerBtn) mobileJokerBtn.disabled = !canAct;
            
            // Update trades button - show sent + received trades
            const sentTrades = (gameData.trades || []).filter(t => t.fromId === localPlayer.id && t.status === 'pending');
            const receivedTrades = (gameData.trades || []).filter(t => t.toId === localPlayer.id && t.status === 'pending');
            const totalTrades = sentTrades.length + receivedTrades.length;
            
            const tradesCount = document.getElementById('pending-trades-count');
            if (tradesCount) tradesCount.textContent = totalTrades;
            viewTradesBtn.classList.toggle('hidden', totalTrades === 0);
            
            // ü§ñ Bot AI - Disabled for now (coming soon)
            // if (currentPlayer.isBot && isMyTurn === false && gameData.turnState === 'start') {
            //     setTimeout(() => handleBotTurn(), 1500);
            // }
        }
        
        // ü§ñ Bot AI Handler (Disabled - Coming Soon)
        async function handleBotTurn() {
            // Bot functionality coming soon!
            console.log('ü§ñ Bot AI is currently disabled');
        }
        
        function updateGameLog() {
            gameLogEl.innerHTML = gameData.gameLog.map(msg => `<div>${msg}</div>`).join('');
            gameLogEl.scrollTop = gameLogEl.scrollHeight;
        }

        // --- IMPROVED DICE SYSTEM ---
        // G√ºvenli rastgele sayƒ± √ºretici (Crypto API kullanarak)
        function secureRandomInt(min, max) {
            const range = max - min + 1;
            const maxValid = Math.floor(256 / range) * range - 1;
            let randomValue;
            do {
                const randomArray = new Uint8Array(1);
                if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
                    crypto.getRandomValues(randomArray);
                } else {
                    // Fallback to Math.random if crypto not available
                    randomArray[0] = Math.floor(Math.random() * 256);
                }
                randomValue = randomArray[0];
            } while (randomValue > maxValid);
            return min + (randomValue % range);
        }

        // Geli≈ümi≈ü zar atma fonksiyonu - istatistiksel takip ile
        function rollDiceImproved(currentPosition = null) {
            // ƒ∞lk zarƒ± at
            let die1 = secureRandomInt(1, 6);
            let die2 = secureRandomInt(1, 6);
            
            // ƒ∞statistiksel d√ºzeltme (sadece gameData hazƒ±rsa)
            if (gameData && gameData.settings && gameData.settings.board && currentPosition !== null) {
                // Kare ziyaret sayƒ±larƒ±nƒ± ba≈ülat (eƒüer yoksa)
                if (!gameData.spaceVisits) {
                    gameData.spaceVisits = new Array(gameData.settings.board.length).fill(0);
                }
                
                // Toplam ziyaret sayƒ±sƒ±nƒ± hesapla
                const totalVisits = gameData.spaceVisits.reduce((sum, visits) => sum + visits, 0);
                const averageVisits = totalVisits / gameData.settings.board.length;
                
                // Eƒüer yeterince veri varsa (en az 40 tur), istatistiksel d√ºzeltme yap
                if (totalVisits >= 40 && averageVisits > 0) {
                    // Mevcut pozisyondan ula≈üƒ±labilir kareleri bul
                    const reachableSpaces = [];
                    for (let roll = 2; roll <= 12; roll++) {
                        const targetSpace = (currentPosition + roll) % gameData.settings.board.length;
                        const visits = gameData.spaceVisits[targetSpace] || 0;
                        const deviation = averageVisits - visits; // Ortalamadan ne kadar az ziyaret edilmi≈ü
                        
                        // Eƒüer kare ortalamadan %40+ daha az ziyaret edilmi≈üse, hafif aƒüƒ±rlƒ±k ver
                        if (deviation > averageVisits * 0.4) {
                            reachableSpaces.push({ roll, weight: 1 + (deviation / averageVisits) * 0.15 }); // Max %15 aƒüƒ±rlƒ±k
                        } else {
                            reachableSpaces.push({ roll, weight: 1.0 });
                        }
                    }
                    
                    // Eƒüer d√ºzeltme gereken kareler varsa, hafif bir aƒüƒ±rlƒ±klandƒ±rma uygula
                    if (reachableSpaces.some(s => s.weight > 1.0)) {
                        const totalWeight = reachableSpaces.reduce((sum, s) => sum + s.weight, 0);
                        let random = Math.random() * totalWeight;
                        let selectedRoll = 7; // Default
                        
                        for (const space of reachableSpaces) {
                            random -= space.weight;
                            if (random <= 0) {
                                selectedRoll = space.roll;
                                break;
                            }
                        }
                        
                        // Se√ßilen roll'e yakƒ±n bir kombinasyon olu≈ütur (ama tam deƒüil, hala rastgele olsun)
                        const currentTotal = die1 + die2;
                        const difference = selectedRoll - currentTotal;
                        
                        // Eƒüer fark k√º√ß√ºkse (%30 ≈üans), hafif√ße ayarla
                        if (Math.abs(difference) <= 2 && Math.random() < 0.3) {
                            // Sadece √ßok k√º√ß√ºk bir ayarlama yap
                            if (difference > 0 && die1 < 6) die1++;
                            else if (difference > 0 && die2 < 6) die2++;
                            else if (difference < 0 && die1 > 1) die1--;
                            else if (difference < 0 && die2 > 1) die2--;
                        }
                        // %70 ≈üansla normal rastgele zarƒ± kullan (kullanƒ±cƒ± zar atƒ±yor hissi vermeli)
                    }
                }
            }
            
            return { die1, die2, total: die1 + die2 };
        }

        // --- GAME ACTIONS ---
        rollDiceBtn.addEventListener('click', async () => {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // üö´ Bot kontrol√º - Botlar zar atamaz!
            if (currentPlayer.id !== localPlayer.id) {
                console.warn('‚ö†Ô∏è Only the current player can roll dice!');
                return;
            }
            
            if (currentPlayer.inJail) {
                handleJailTurn();
                return;
            }

            // Animate dice rolling
            rollDiceBtn.disabled = true;
            
            // üé≤ Geli≈ümi≈ü zar atma sistemi kullan
            const diceResult = rollDiceImproved(currentPlayer.position);
            const die1 = diceResult.die1;
            const die2 = diceResult.die2;
            const total = diceResult.total;
            
            console.log('üé≤ Rolled dice:', die1, '+', die2, '=', total);
            
            // üé≤ 3D Zar animasyonu ba≈ülat
            // Zarlar end turn'e kadar masada kalacak, burada gizlenmiyor
            animate3DDiceRoll(die1, die2);
            
            // Eski animasyon (geriye d√∂n√ºk uyumluluk)
            animateDiceRoll();
            
            // üéµ Play dice roll sound
            playSound('dice');
            
            // ‚è∞ Aktivite ping g√∂nder
            sendActivityPing();

            let logMessages = [];

            // Update dice display after animation
            setTimeout(() => {
                console.log('üé≤ Updating dice display to:', die1, die2);
                updateDiceDisplay(die1, die2);
                dice1El.classList.remove('dice-rolling');
                dice2El.classList.remove('dice-rolling');
            }, 2000);
            
            const oldPosition = currentPlayer.position;
            const newPosition = (currentPlayer.position + total) % gameData.settings.board.length;
            
            // üìä Kare ziyaret istatistiklerini g√ºncelle
            if (!gameData.spaceVisits) {
                gameData.spaceVisits = new Array(gameData.settings.board.length).fill(0);
            }
            gameData.spaceVisits[newPosition] = (gameData.spaceVisits[newPosition] || 0) + 1;
            
            // üé≤ Check for doubles
            const isDouble = (die1 === die2);
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // ‚≠ê Check if passed GO (position wrapped around)
            let passGoBonus = 0;
            if (newPosition < oldPosition) {
                // Passed GO
                passGoBonus = gameData.settings.passGoBonus || 200;
                playersCopy[gameData.currentPlayerIndex].money += passGoBonus;
                logMessages.push(`üí∞ ${currentPlayer.name} passed GO! +$${passGoBonus}`);
            } else if (newPosition === 0) {
                // Landed exactly on GO
                passGoBonus = (gameData.settings.passGoBonus || 200) + 100;
                playersCopy[gameData.currentPlayerIndex].money += passGoBonus;
                logMessages.push(`üéØ ${currentPlayer.name} landed on GO! +$${passGoBonus}`);
            }
            
            // Update lucky turns and track doubles
            if (currentPlayer.isLucky && currentPlayer.luckyTurnsLeft > 0) {
                playersCopy[gameData.currentPlayerIndex].luckyTurnsLeft -= 1;
                if (playersCopy[gameData.currentPlayerIndex].luckyTurnsLeft === 0) {
                    playersCopy[gameData.currentPlayerIndex].isLucky = false;
                    logMessages.push(`‚≠ê ${currentPlayer.name}'s lucky streak has ended!`);
                }
            }
            
            if (isDouble) {
                playersCopy[gameData.currentPlayerIndex].doublesCount = (currentPlayer.doublesCount || 0) + 1;
                logMessages.push(`üé≤ ${currentPlayer.name} rolled ${die1} + ${die2} = ${total} (DOUBLES!)`);
            } else {
                logMessages.push(`üé≤ ${currentPlayer.name} rolled ${die1} + ${die2} = ${total}`);
            }
            
            // üé¨ Karakter animasyonu - kare kare ilerleme
            await animatePlayerMovement(currentPlayer.id, oldPosition, newPosition, total);
            
            // Final pozisyonu ayarla
            playersCopy[gameData.currentPlayerIndex].position = newPosition;
            
            await updateGame({
                lastDiceRoll: [die1, die2],
                players: playersCopy,
                turnState: 'rolled',
                spaceVisits: gameData.spaceVisits,
                gameLog: [...gameData.gameLog, ...logMessages]
            });
            
            setTimeout(() => {
                handleLanding(newPosition);
            }, 500);
            
            // Re-enable dice button after animation
            setTimeout(() => {
                rollDiceBtn.disabled = false;
            }, 2500);
        });
        
        // 3D Dice Animation Function
        function animateDiceRoll() {
            dice1El.classList.add('dice-rolling');
            dice2El.classList.add('dice-rolling');
            
            let rolls = 0;
            const rollInterval = setInterval(() => {
                const randomDie1 = secureRandomInt(1, 6);
                const randomDie2 = secureRandomInt(1, 6);
                updateDiceDisplay(randomDie1, randomDie2);
                rolls++;
                if (rolls >= 10) {
                    clearInterval(rollInterval);
                }
            }, 100);
        }
        
        // Function to update dice display
        function updateDiceDisplay(die1, die2) {
            dice1El.textContent = die1;
            dice2El.textContent = die2;
        }
        
        // üé≤ 3D Zar olu≈üturma fonksiyonu - Animasyonda 3D, finalde 2D
        function create3DDice(diceId, value) {
            const diceContainer = document.getElementById(diceId);
            if (!diceContainer) return null;
            
            diceContainer.innerHTML = '';
            const dice = document.createElement('div');
            dice.className = 'dice-3d';
            dice.id = `${diceId}-cube`;
            
            // Klasik zar nokta d√ºzeni (standart Monopoly zarƒ±) - t√ºm y√ºzlerde aynƒ±
            const dotPositions = {
                1: [[17.5, 17.5]],
                2: [[12, 12], [23, 23]],
                3: [[12, 12], [17.5, 17.5], [23, 23]],
                4: [[12, 12], [23, 12], [12, 23], [23, 23]],
                5: [[12, 12], [23, 12], [17.5, 17.5], [12, 23], [23, 23]],
                6: [[12, 12], [12, 17.5], [12, 23], [23, 12], [23, 17.5], [23, 23]]
            };
            
            // 6 y√ºz olu≈ütur - animasyon i√ßin 3D cube
            const faces = ['front', 'back', 'right', 'left', 'top', 'bottom'];
            faces.forEach((face, index) => {
                const faceEl = document.createElement('div');
                faceEl.className = `dice-face ${face}`;
                
                // Her y√ºze final deƒüerin noktalarƒ±nƒ± koy (final pozisyonda doƒüru g√∂r√ºns√ºn)
                const dots = dotPositions[value] || [];
                
                dots.forEach(([x, y]) => {
                    const dot = document.createElement('div');
                    dot.className = 'dice-dot';
                    dot.style.left = `${x - 3.5}px`;
                    dot.style.top = `${y - 3.5}px`;
                    faceEl.appendChild(dot);
                });
                
                dice.appendChild(faceEl);
            });
            
            diceContainer.appendChild(dice);
            return dice;
        }
        
        // üé≤ 3D Zar animasyonu - √áapraz k√∂≈üelerden ortaya fƒ±rlatma
        async function animate3DDiceRoll(dice1Value, dice2Value) {
            const animationContainer = document.getElementById('dice-animation-container');
            const dice1Container = document.getElementById('dice-3d-1');
            const dice2Container = document.getElementById('dice-3d-2');
            
            if (!animationContainer || !dice1Container || !dice2Container) return;
            
            // Tahtanƒ±n boyutlarƒ±nƒ± al (center-board)
            const centerBoard = document.querySelector('.center-board');
            if (!centerBoard) return;
            
            const boardRect = centerBoard.getBoundingClientRect();
            
            // Tahtanƒ±n geni≈ülik ve y√ºksekliƒüi
            const boardWidth = boardRect.width;
            const boardHeight = boardRect.height;
            
            // Pop-up'ƒ±n boyutlarƒ±nƒ± tahmin et (property-buy-panel en b√ºy√ºk)
            // max-w-md = ~28rem = ~448px geni≈ülik, y√ºkseklik ~300-400px arasƒ±
            const popupWidth = 450;
            const popupHeight = 350;
            const popupMargin = 20; // Pop-up'ƒ±n etrafƒ±ndaki bo≈üluk
            
            // Zar container'larƒ±nƒ± g√∂ster
            animationContainer.classList.add('show');
            
            // ƒ∞ki zarƒ± olu≈ütur
            const dice1 = create3DDice('dice-3d-1', dice1Value);
            const dice2 = create3DDice('dice-3d-2', dice2Value);
            
            if (!dice1 || !dice2) return;
            
            // Tur sayƒ±sƒ±nƒ± takip et (her turda k√∂≈üeler deƒüi≈üsin)
            if (!window.diceCornerToggle) window.diceCornerToggle = false;
            window.diceCornerToggle = !window.diceCornerToggle;
            
            // √áapraz k√∂≈üeler - her turda deƒüi≈üir
            // El pozisyonlarƒ± (k√∂≈üelerden biraz yukarƒ±da - el yukarƒ±dan tutuyor)
            let hand1Pos, hand2Pos, start1, start2;
            if (window.diceCornerToggle) {
                // Tur 1: Sol alt + Saƒü √ºst
                hand1Pos = { x: -boardWidth / 2 - 80, y: boardHeight / 2 + 80 };  // Sol alt el
                hand2Pos = { x: boardWidth / 2 + 80, y: -boardHeight / 2 - 80 };  // Saƒü √ºst el
                start1 = { x: -boardWidth / 2 - 80, y: boardHeight / 2 + 60 };  // Sol alt - elin altƒ±ndan
                start2 = { x: boardWidth / 2 + 80, y: -boardHeight / 2 - 60 };  // Saƒü √ºst - elin altƒ±ndan
            } else {
                // Tur 2: Saƒü alt + Sol √ºst
                hand1Pos = { x: boardWidth / 2 + 80, y: boardHeight / 2 + 80 };   // Saƒü alt el
                hand2Pos = { x: -boardWidth / 2 - 80, y: -boardHeight / 2 - 80 };  // Sol √ºst el
                start1 = { x: boardWidth / 2 + 80, y: boardHeight / 2 + 60 };   // Saƒü alt - elin altƒ±ndan
                start2 = { x: -boardWidth / 2 - 80, y: -boardHeight / 2 - 60 };  // Sol √ºst - elin altƒ±ndan
            }
            
            // El animasyonu kaldƒ±rƒ±ldƒ± - zarlar hemen ba≈ülƒ±yor
            // (El animasyonu gecikme yaratƒ±yor, istenmiyor)
            
            // √áarpƒ±≈üma noktalarƒ± - zarlar birbirine √ßok yakla≈üsa da √ßakƒ±≈ümasƒ±n
            // ƒ∞ki zar i√ßin farklƒ± collision noktalarƒ± (biraz offset ile)
            const collisionOffset = 40; // Zarlar arasƒ± minimum mesafe
            const collisionX1 = -collisionOffset / 2;
            const collisionY1 = -collisionOffset / 2;
            const collisionX2 = collisionOffset / 2;
            const collisionY2 = collisionOffset / 2;
            
            // Final pozisyon - pop-up'ƒ±n ve property alanlarƒ±nƒ±n dƒ±≈üƒ±nda
            // Center-board'un kenarlarƒ±na yakƒ±n ama i√ßinde
            // Zarlar farklƒ± k√∂≈üelere gidecek - bir tanesi bir k√∂≈üeye, diƒüeri ba≈üka bir k√∂≈üeye
            const boardMin = Math.min(boardWidth, boardHeight);
            
            // ƒ∞ki zar i√ßin farklƒ± final pozisyonlar (farklƒ± k√∂≈üelere)
            const corner1 = secureRandomInt(0, 3); // 0: sol-√ºst, 1: saƒü-√ºst, 2: saƒü-alt, 3: sol-alt
            let corner2 = secureRandomInt(0, 3);
            // ƒ∞kinci k√∂≈üe birinciden farklƒ± olsun
            while (corner2 === corner1) {
                corner2 = secureRandomInt(0, 3);
            }
            
            const getCornerPosition = (corner) => {
                switch(corner) {
                    case 0: return { x: -boardMin * 0.3, y: -boardMin * 0.3 }; // sol-√ºst
                    case 1: return { x: boardMin * 0.3, y: -boardMin * 0.3 }; // saƒü-√ºst
                    case 2: return { x: boardMin * 0.3, y: boardMin * 0.3 }; // saƒü-alt
                    case 3: return { x: -boardMin * 0.3, y: boardMin * 0.3 }; // sol-alt
                    default: return { x: 0, y: 0 };
                }
            };
            
            const finalPos1 = getCornerPosition(corner1);
            const finalPos2 = getCornerPosition(corner2);
            
            // Fizik mekanikleri - daha basit ve akƒ±≈ükan yuvarlanma (az d√∂n√º≈ü)
            const roll1X = (Math.random() - 0.5) * 720 + 360;  // 0-720 derece
            const roll1Y = (Math.random() - 0.5) * 720 + 360;
            const roll1Z = (Math.random() - 0.5) * 720 + 360;
            
            const roll2X = (Math.random() - 0.5) * 720 + 360;
            const roll2Y = (Math.random() - 0.5) * 720 + 360;
            const roll2Z = (Math.random() - 0.5) * 720 + 360;
            
            // Animasyon s√ºresi - daha akƒ±≈ükan
            const duration = 1500; // 1.5 saniye (daha hƒ±zlƒ±)
            const steps = 60;
            const stepDuration = duration / steps;
            
            // DEBUG: Console'a zar deƒüerlerini yazdƒ±r
            console.log('üé≤ Animating dice:', dice1Value, '+', dice2Value);
            
            // ƒ∞ki a≈üamalƒ± animasyon: K√∂≈üeden ortaya √ßarpƒ±≈üma, sonra final pozisyona
            // Z-index ayarƒ±: birinci zar √ºstte, ikinci zar altta (g√∂rsel √ßakƒ±≈üma √∂nleme)
            dice1.style.zIndex = '10';
            dice2.style.zIndex = '9';
            
            const animateDice = (diceEl, startX, startY, collisionX, collisionY, finalX, finalY, rollX, rollY, rollZ, finalValue, isFirstDice) => {
                return new Promise((resolve) => {
                    // Ba≈ülangƒ±√ßta g√∂r√ºn√ºr - gecikme yok
                    diceEl.style.opacity = '1';
                    diceEl.style.transform = `translateX(${startX}px) translateY(${startY}px) translateZ(0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)`;
                    
                    let step = 0;
                    const delaySteps = 0; // Gecikme yok - animasyon hemen ba≈ülƒ±yor
                    const collisionSteps = delaySteps + Math.floor(steps * 0.55); // %55 √ßarpƒ±≈üma, %35 final pozisyon
                    
                    const interval = setInterval(() => {
                        const progress = step / steps;
                        
                        if (step < delaySteps) {
                            // GECƒ∞KME: El zarƒ± tutuyor, zar hen√ºz g√∂r√ºnmez
                            step++;
                            return; // Hen√ºz hareket yok
                        } else if (step < collisionSteps) {
                            // A≈ûAMA 1: K√∂≈üeden ortaya √ßarpƒ±≈üma - 3D animasyon (zar yuvarlanƒ±yor)
                            const collisionProgress = (step - delaySteps) / (collisionSteps - delaySteps);
                            const easeOut = 1 - Math.pow(1 - collisionProgress, 1.5);
                            const parabola = Math.sin(collisionProgress * Math.PI) * 0.5;
                            
                            const currentX = startX + (collisionX - startX) * easeOut;
                            const currentY = startY + (collisionY - startY) * easeOut - (parabola * 60);
                            
                            // 3D rotasyon - zar yuvarlanƒ±yor
                            const rotationProgress = collisionProgress;
                            const currentRotX = rollX * rotationProgress;
                            const currentRotY = rollY * rotationProgress;
                            const currentRotZ = rollZ * rotationProgress;
                            
                            diceEl.style.transform = `
                                translateX(${currentX}px) 
                                translateY(${currentY}px) 
                                translateZ(${collisionProgress * 15}px)
                                rotateX(${currentRotX}deg) 
                                rotateY(${currentRotY}deg) 
                                rotateZ(${currentRotZ}deg)
                            `;
                        } else if (step >= collisionSteps && step < steps) {
                            // A≈ûAMA 2: √áarpƒ±≈ümadan final pozisyona - 3D'den 2D'ye ge√ßi≈ü
                            const finalProgress = (step - collisionSteps) / (steps - collisionSteps);
                            const finalEaseOut = 1 - Math.pow(1 - finalProgress, 1.5);
                            
                            const finalParabola = Math.sin(finalProgress * Math.PI) * 0.2;
                            
                            const currentX = collisionX + (finalX - collisionX) * finalEaseOut;
                            const currentY = collisionY + (finalY - collisionY) * finalEaseOut - (finalParabola * 30);
                            
                            // 3D rotasyon'dan 2D d√ºze ge√ßi≈ü (yava≈ü yava≈ü d√ºzle≈üiyor)
                            const rotationProgress = 1 - (finalProgress * 0.8); // %100'den %20'ye
                            const currentRotX = rollX * rotationProgress;
                            const currentRotY = rollY * rotationProgress;
                            const currentRotZ = rollZ * rotationProgress;
                            
                            // Z deƒüeri de azaltƒ±lƒ±yor (3D'den 2D'ye)
                            const currentZ = 15 - (finalProgress * 15); // 15'ten 0'a
                            
                            diceEl.style.transform = `
                                translateX(${currentX}px) 
                                translateY(${currentY}px) 
                                translateZ(${currentZ}px)
                                rotateX(${currentRotX}deg) 
                                rotateY(${currentRotY}deg) 
                                rotateZ(${currentRotZ}deg)
                            `;
                        } else {
                            // Final pozisyon - 2D d√ºz zar (sadece √ºst y√ºz g√∂r√ºns√ºn)
                            // Animasyon 3D olur ama finalde 2D d√ºz zar g√∂r√ºn√ºr
                            // Final rotation sƒ±fƒ±rla - d√ºz bir zar y√ºz√º g√∂ster
                            diceEl.style.transform = `translateX(${finalX}px) translateY(${finalY}px) translateZ(0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)`;
                            
                            clearInterval(interval);
                            resolve();
                            return;
                        }
                        
                        step++;
                    }, stepDuration);
                });
            };
            
            // ƒ∞ki zar i√ßin final pozisyonlarƒ± (farklƒ± k√∂≈üelere)
            const finalX1 = finalPos1.x;
            const finalY1 = finalPos1.y;
            const finalX2 = finalPos2.x;
            const finalY2 = finalPos2.y;
            
            await Promise.all([
                // ƒ∞lk zar: sol collision noktasƒ±na gider, sonra finalPos1'e
                animateDice(dice1, start1.x, start1.y, collisionX1, collisionY1, finalPos1.x, finalPos1.y, roll1X, roll1Y, roll1Z, dice1Value, true),
                // ƒ∞kinci zar: saƒü collision noktasƒ±na gider, sonra finalPos2'ye
                animateDice(dice2, start2.x, start2.y, collisionX2, collisionY2, finalPos2.x, finalPos2.y, roll2X, roll2Y, roll2Z, dice2Value, false)
            ]);
        }
        
        // üé¨ Karakter animasyonu - kare kare ilerleme
        async function animatePlayerMovement(playerId, startPos, endPos, totalMoves) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            const pieceEl = document.getElementById(`piece-${playerId}`);
            if (!pieceEl) {
                // Eƒüer piece elementi yoksa, normal g√ºncelleme yap
                player.position = endPos;
                updateBoardPiecesAndHouses();
                return;
            }
            
            // Eƒüer GO'yu ge√ßtiyse (endPos < startPos), √∂nce board'un sonuna kadar git, sonra ba≈üa d√∂n
            const boardLength = gameData.settings.board.length;
            let positionsToMove = [];
            
            if (endPos < startPos) {
                // GO'yu ge√ßti - √∂nce sona kadar, sonra ba≈üa
                for (let i = startPos + 1; i < boardLength; i++) {
                    positionsToMove.push(i);
                }
                for (let i = 0; i <= endPos; i++) {
                    positionsToMove.push(i);
                }
            } else {
                // Normal ilerleme
                for (let i = startPos + 1; i <= endPos; i++) {
                    positionsToMove.push(i);
                }
            }
            
            // Ge√ßici olarak pozisyonu takip et (animasyon i√ßin)
            const originalPosition = player.position;
            player.position = startPos; // Ba≈ülangƒ±√ß pozisyonunu ayarla
            
            // Her kare i√ßin animasyon (seri ama g√∂r√ºn√ºr)
            const delayPerSpace = 120; // Her kare i√ßin 120ms (hƒ±zlƒ± ama g√∂r√ºn√ºr)
            
            for (let i = 0; i < positionsToMove.length; i++) {
                const nextPos = positionsToMove[i];
                
                // Ge√ßici pozisyon g√ºncelle (sadece g√∂rsel i√ßin)
                player.position = nextPos;
                
                // Mevcut piece elementinin pozisyonunu g√ºncelle (t√ºm board'u yeniden render etmeden)
                const targetSpace = document.getElementById(`space-${nextPos}`);
                if (targetSpace && pieceEl) {
                    // Aynƒ± pozisyondaki diƒüer oyuncularƒ± hesapla (animasyon i√ßin ge√ßici pozisyon kullan)
                    // Animasyon sƒ±rasƒ±nda sadece bu oyuncunun pozisyonu deƒüi≈üti, diƒüerleri ger√ßek pozisyonlarƒ±nda
                    const tempPlayersForAnimation = gameData.players.map(p => {
                        if (p.id === playerId) {
                            return { ...p, position: nextPos }; // Animasyon i√ßin ge√ßici pozisyon
                        }
                        return p; // Diƒüerleri ger√ßek pozisyonlarƒ±nda
                    });
                    
                    const playersOnSameSpace = tempPlayersForAnimation.filter(
                        p => p.position === nextPos && !p.isBankrupt
                    );
                    const positionIndex = playersOnSameSpace.findIndex(p => p.id === playerId);
                    const offsetX = (positionIndex % 2) * 18;
                    const offsetY = Math.floor(positionIndex / 2) * 18;
                    
                    // Smooth transition ile pozisyonu g√ºncelle
                    pieceEl.style.transition = 'left 0.12s ease-out, top 0.12s ease-out';
                    pieceEl.style.left = `${targetSpace.offsetLeft + 8 + offsetX}px`;
                    pieceEl.style.top = `${targetSpace.offsetTop + 8 + offsetY}px`;
                }
                
                // Kƒ±sa bir bekleme (animasyon i√ßin)
                await new Promise(resolve => setTimeout(resolve, delayPerSpace));
            }
            
            // Final pozisyonu ayarla
            player.position = endPos;
            
            // Son bir kez t√ºm board'u g√ºncelle (diƒüer oyuncularƒ±n pozisyonlarƒ± i√ßin)
            updateBoardPiecesAndHouses();
        }
        
        // View Trades Button
        const viewTradesBtn = document.getElementById('viewTradesBtn');
        viewTradesBtn.addEventListener('click', viewPendingTrades);
        
        // üí≥ Credit Button
        const takeCreditBtn = document.getElementById('takeCreditBtn');
        takeCreditBtn.addEventListener('click', showCreditModal);
        
        // Team Manager Button
        const teamManagerBtn = document.getElementById('teamManagerBtn');
        teamManagerBtn.addEventListener('click', showTeamManager);
        
        function showTeamManager() {
            const me = gameData.players.find(p => p.id === localPlayer.id);
            const myTeam = me.team || '';
            
            const teamPlayers = {
                red: gameData.players.filter(p => p.team === 'red'),
                blue: gameData.players.filter(p => p.team === 'blue'),
                green: gameData.players.filter(p => p.team === 'green'),
                yellow: gameData.players.filter(p => p.team === 'yellow')
            };
            
            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">Your Current Status:</h4>
                        <p>${myTeam ? `You are in <strong>${myTeam.toUpperCase()} TEAM</strong>` : 'You are playing SOLO (no team)'}</p>
                    </div>
                    
                    <div class="space-y-2">
                        <h4 class="font-bold">Available Teams:</h4>
                        ${['red', 'blue', 'green', 'yellow'].map(team => {
                            const badge = {'red': 'üî¥', 'blue': 'üîµ', 'green': 'üü¢', 'yellow': 'üü°'}[team];
                            const players = teamPlayers[team];
                            const isMemberOfThisTeam = myTeam === team;
                            
                            return `
                                <div class="border-2 border-gray-300 rounded-lg p-3 ${isMemberOfThisTeam ? 'bg-green-50 border-green-500' : ''}">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold">${badge} ${team.toUpperCase()} Team (${players.length} members)</span>
                                        ${!isMemberOfThisTeam ? 
                                            `<button onclick="window.joinTeam('${team}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Join</button>` :
                                            `<button onclick="window.leaveTeam()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Leave</button>`
                                        }
                                    </div>
                                    ${players.length > 0 ? `<div class="text-sm text-gray-600">Members: ${players.map(p => p.name).join(', ')}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded-lg text-sm">
                        <strong>üí° Team Benefits:</strong>
                        <ul class="list-disc ml-5 mt-1">
                            <li>Shared money pool - all team members share funds</li>
                            <li>Shared properties - all properties owned by team</li>
                            <li>Can't trade with teammates</li>
                            <li>Team wins together!</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('ü§ù Team Manager', body, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }
        
        function showGameManagementModal(playerId) {
            console.log('playerId:', playerId);
            const player = gameData.players.find(p => p.id === playerId);
            console.log('player:', player);
            if (!player) {
                console.error('Player not found for id:', playerId);
                return;
            }
            document.getElementById('managementPlayerName').textContent = `Manage ${player.name}`;
            document.getElementById('gameManagementModal').classList.remove('hidden');
            
            document.getElementById('kickPlayerBtn').onclick = () => {
                socket.emit('kickPlayer', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('forceEndTurnBtn').onclick = () => {
                socket.emit('forceEndTurn', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('forceRollDiceBtn').onclick = () => {
                socket.emit('forceRollDice', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('closeManagementModal').onclick = () => {
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
        }
        
        // ü§ñ Bot Mortgage/Sell Decision (when in financial trouble)
        async function botDecideMortgageOrSell(playerIndex) {
            const player = gameData.players[playerIndex];
            if (!player.isBot) return false; // Sadece botlar i√ßin
            
            // Botun sahip olduƒüu m√ºlkleri bul
            const ownedProperties = gameData.properties
                .map((prop, idx) => ({...prop, spaceIndex: idx}))
                .filter(prop => {
                    const space = gameData.settings.board[prop.spaceIndex];
                    return (space.type === 'property' || space.type === 'railroad' || space.type === 'utility') &&
                           (prop.ownerId === player.id || (prop.owners && prop.owners[player.id] > 0));
                });
            
            if (ownedProperties.length === 0) {
                // Hi√ß m√ºlk√º yok, iflas edecek
                return false;
            }
            
            // Ne kadar paraya ihtiya√ß var?
            const moneyNeeded = Math.abs(player.money) + 100; // Negatif paranƒ±n √ºst√ºne 100 ekstra g√ºvenlik
            
            // Mevcut se√ßenekleri deƒüerlendir
            const options = [];
            
            ownedProperties.forEach(propData => {
                const space = gameData.settings.board[propData.spaceIndex];
                const share = propData.owners ? (propData.owners[player.id] || 0) : 100;
                
                if (space.type === 'property') {
                    // Evleri satabilir
                    if (propData.houses > 0 && !propData.mortgaged) {
                        const sellValue = Math.floor((space.houseCost || 50) * 0.75 * propData.houses * (share / 100));
                        options.push({
                            type: 'sell_house',
                            spaceIndex: propData.spaceIndex,
                            value: sellValue,
                            priority: 3, // Ev satmak daha d√º≈ü√ºk √∂ncelik (√∂nemli gelir kaynaƒüƒ±)
                            spaceName: space.name
                        });
                    }
                    
                    // ƒ∞potekleyebilir (ev yoksa)
                    if (propData.houses === 0 && !propData.mortgaged) {
                        const mortgageValue = Math.floor(space.price * (share / 100));
                        options.push({
                            type: 'mortgage',
                            spaceIndex: propData.spaceIndex,
                            value: mortgageValue,
                            priority: 2, // ƒ∞potek orta √∂ncelik (m√ºlk√º koruyor ama gelir kaybediyor)
                            spaceName: space.name
                        });
                    }
                } else if (space.type === 'railroad' || space.type === 'utility') {
                    // ƒ∞potekleyebilir
                    if (!propData.mortgaged) {
                        const mortgageValue = Math.floor(space.price * (share / 100));
                        options.push({
                            type: 'mortgage',
                            spaceIndex: propData.spaceIndex,
                            value: mortgageValue,
                            priority: 1, // Railroad/Utility ipotekleme y√ºksek √∂ncelik (daha az kritik)
                            spaceName: space.name
                        });
                    }
                }
            });
            
            if (options.length === 0) return false;
            
            // Strateji: √ñnce az deƒüerli olanlarƒ± ipotekle/sat, sonra daha deƒüerli olanlara ge√ß
            // Priority'ye g√∂re sƒ±rala (d√º≈ü√ºk √∂ncelik = daha az kritik)
            options.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return a.value - b.value; // Aynƒ± √∂ncelikte k√º√ß√ºk deƒüerli olanlarƒ± √∂nce
            });
            
            let totalRaised = 0;
            const actions = [];
            
            for (const option of options) {
                if (totalRaised >= moneyNeeded) break;
                
                if (option.type === 'mortgage') {
                    actions.push(option);
                    totalRaised += option.value;
                } else if (option.type === 'sell_house') {
                    actions.push(option);
                    totalRaised += option.value;
                }
            }
            
            // Eƒüer yeterli para toplanamadƒ±ysa ve hala se√ßenekler varsa, daha fazlasƒ±nƒ± ekle
            if (totalRaised < moneyNeeded) {
                for (const option of options) {
                    if (actions.includes(option)) continue;
                    if (totalRaised >= moneyNeeded) break;
                    
                    if (option.type === 'mortgage') {
                        actions.push(option);
                        totalRaised += option.value;
                    } else if (option.type === 'sell_house') {
                        actions.push(option);
                        totalRaised += option.value;
                    }
                }
            }
            
            // Kararlarƒ± uygula
            for (const action of actions) {
                if (action.type === 'mortgage') {
                    // ƒ∞potekle
                    await botMortgageProperty(playerIndex, action.spaceIndex);
                    addLog(`ü§ñ ${player.name} mortgaged ${action.spaceName} to raise $${action.value}.`);
                } else if (action.type === 'sell_house') {
                    // Ev sat
                    await botSellHouse(playerIndex, action.spaceIndex);
                    addLog(`ü§ñ ${player.name} sold houses on ${action.spaceName} to raise $${action.value}.`);
                }
            }
            
            return actions.length > 0;
        }
        
        // ü§ñ Bot Mortgage Property Helper
        async function botMortgageProperty(playerIndex, spaceIndex) {
            const player = gameData.players[playerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (!property || property.mortgaged) return;
            
            // Ev kontrol√º (property i√ßin)
            if (space.type === 'property' && property.houses > 0) {
                return; // Ev varsa ipoteklenemez
            }
            
            const share = property.owners ? (property.owners[player.id] || 0) : 100;
            const mortgageValue = Math.floor(space.price * (share / 100));
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].mortgaged = true;
            playersCopy[playerIndex].money += mortgageValue;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
        }
        
        // ü§ñ Bot Sell House Helper
        async function botSellHouse(playerIndex, spaceIndex) {
            const player = gameData.players[playerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (!property || property.houses === 0) return;
            
            const share = property.owners ? (property.owners[player.id] || 0) : 100;
            const houseSellPrice = Math.floor((space.houseCost || 50) * 0.75 * (share / 100));
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // Bir ev sat (otel varsa √∂nce otel sat)
            if (property.houses === 5) {
                propertiesCopy[spaceIndex].houses = 4; // Otel -> 4 ev
            } else {
                propertiesCopy[spaceIndex].houses -= 1;
            }
            
            playersCopy[playerIndex].money += houseSellPrice;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
        }
        
        // ü§ñ Bot Property Purchase Decision
        async function botDecidePropertyPurchase(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Calculate property value score (0-100)
            let valueScore = 0;
            
            // Base value by type
            switch(space.type) {
                case 'railroad':
                    valueScore = 80; // Railroads are very valuable for monopolies
                    break;
                case 'utility':
                    valueScore = 70; // Utilities are valuable but expensive
                    break;
                case 'property':
                    // Value based on color group and position
                    const colorGroups = {
                        'brown': 40, 'lightblue': 45, 'pink': 50, 'orange': 55,
                        'red': 60, 'yellow': 65, 'green': 70, 'darkblue': 75
                    };
                    valueScore = colorGroups[space.color] || 50;
                    break;
            }
            
            // Adjust for current money situation
            const moneyRatio = currentPlayer.money / space.price;
            let affordabilityScore = 0;
            
            if (moneyRatio >= 2) affordabilityScore = 100; // Very affordable
            else if (moneyRatio >= 1.5) affordabilityScore = 80; // Affordable
            else if (moneyRatio >= 1) affordabilityScore = 60; // Just affordable
            else if (moneyRatio >= 0.8) affordabilityScore = 40; // Tight but possible
            else affordabilityScore = 0; // Can't afford
            
            // Strategic consideration: Check if bot already owns properties in this color group
            let monopolyBonus = 0;
            if (space.type === 'property') {
                const sameColorProperties = gameData.settings.board.filter(p => 
                    p.type === 'property' && p.color === space.color
                );
                const ownedSameColor = sameColorProperties.filter(p => 
                    gameData.properties[p.position] && 
                    (gameData.properties[p.position].ownerId === currentPlayer.id ||
                     (gameData.properties[p.position].owners && gameData.properties[p.position].owners[currentPlayer.id]))
                ).length;
                
                if (ownedSameColor > 0) {
                    monopolyBonus = 20; // Bonus for completing color groups
                }
            }
            
            // Calculate final decision score
            const finalScore = (valueScore * 0.4) + (affordabilityScore * 0.5) + (monopolyBonus * 0.1);
            
            // Special rule: If bot has 3x the property price, buy immediately
            if (moneyRatio >= 3) {
                addLog(`ü§ñ ${currentPlayer.name} has plenty of money ($${currentPlayer.money}) and decided to buy ${space.name} for $${space.price}.`);
                await buyPropertyWithShare(position, 100);
                return;
            }
            
            // Decision thresholds
            if (finalScore >= 70) {
                // Buy 100% if very valuable and affordable
                addLog(`ü§ñ ${currentPlayer.name} decided to buy ${space.name} for $${space.price}.`);
                await buyPropertyWithShare(position, 100);
            } else if (finalScore >= 50) {
                // Buy 75% if moderately valuable
                const cost75 = Math.floor(space.price * 0.75);
                if (currentPlayer.money >= cost75) {
                    addLog(`ü§ñ ${currentPlayer.name} decided to buy 75% of ${space.name} for $${cost75}.`);
                    await buyPropertyWithShare(position, 75);
                } else {
                    // Can't afford 75%, try 50%
                    const cost50 = Math.floor(space.price * 0.5);
                    if (currentPlayer.money >= cost50) {
                        addLog(`ü§ñ ${currentPlayer.name} decided to buy 50% of ${space.name} for $${cost50}.`);
                        await buyPropertyWithShare(position, 50);
                    } else {
                        addLog(`ü§ñ ${currentPlayer.name} decided not to buy ${space.name} (can't afford).`);
                        await startAuction(position);
                    }
                }
            } else if (finalScore >= 30) {
                // Buy 50% if borderline
                const cost50 = Math.floor(space.price * 0.5);
                if (currentPlayer.money >= cost50) {
                    addLog(`ü§ñ ${currentPlayer.name} decided to buy 50% of ${space.name} for $${cost50}.`);
                    await buyPropertyWithShare(position, 50);
                } else {
                    addLog(`ü§ñ ${currentPlayer.name} decided not to buy ${space.name} (can't afford).`);
                    await startAuction(position);
                }
            } else {
                // Don't buy, start auction
                addLog(`ü§ñ ${currentPlayer.name} decided not to buy ${space.name} (not valuable enough).`);
                await startAuction(position);
            }
        }
        
        async function handleLanding(position) {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const space = gameData.board[position];
            
            let logMessages = [];
            
            // Log landing
            logMessages.push(`üè† ${currentPlayer.name} landed on ${space.name}`);
            
            // Handle different space types
            if (space.type === 'property') {
                // Property logic - rent, buy, etc.
                // For now, just log
                logMessages.push(`This is a property: ${space.name}`);
            } else if (space.type === 'special') {
                // Special spaces like GO, Jail, etc.
                if (space.name === 'Go') {
                    // Pass GO logic
                    logMessages.push(`Passed GO! Collect $200`);
                } else if (space.name === 'Jail') {
                    // Jail logic
                    logMessages.push(`Just visiting Jail`);
                }
            }
            
            // Update turn state to landed
            await updateGame({
                turnState: 'landed',
                gameLog: [...gameData.gameLog, ...logMessages]
            });
        }
        
        window.joinTeam = async function(teamName) {
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            playersCopy[myIndex].team = teamName;
            
            await updateGame({
                players: playersCopy,
                gameLog: [...gameData.gameLog, `ü§ù ${localPlayer.name} joined ${teamName.toUpperCase()} team!`]
            });
            
            hideModal();
            setTimeout(() => showTeamManager(), 200);
        };
        
        window.leaveTeam = async function() {
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const oldTeam = playersCopy[myIndex].team;
            playersCopy[myIndex].team = '';
            
            await updateGame({
                players: playersCopy,
                gameLog: [...gameData.gameLog, `üëã ${localPlayer.name} left ${oldTeam.toUpperCase()} team.`]
            });
            
            hideModal();
            setTimeout(() => showTeamManager(), 200);
        };
        
        endTurnBtn.addEventListener('click', async () => {
            // Sadece kendi turunsa ve action_complete durumundaysa √ßalƒ±≈üsƒ±n
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.id === localPlayer.id;
            
            if (!isMyTurn || gameData.turnState !== 'action_complete') {
                console.log('Not your turn or turn not complete yet!');
                return;
            }
            
            let nextPlayerIndex = (gameData.currentPlayerIndex + 1) % gameData.players.length;
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // Check for extra turn from doubles (only if doubles rule is enabled)
            if (gameData.allowDoubles && gameData.players[gameData.currentPlayerIndex].doublesCount > 0) {
                nextPlayerIndex = gameData.currentPlayerIndex;
                playersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            } else {
                // Skip bankrupt players
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
            }
            
            // Reset doubles count when moving to next player
            if (nextPlayerIndex !== gameData.currentPlayerIndex) {
                playersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            }
            
            // ‚è≠Ô∏è Check if next player should skip their turn (from Skip Joker Card)
            if (playersCopy[nextPlayerIndex].skipNextTurn) {
                playersCopy[nextPlayerIndex].skipNextTurn = false;
                const skippedPlayerName = playersCopy[nextPlayerIndex].name;
                
                // Move to the player after the skipped one
                nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                
                // Skip bankrupt players again
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
                
                await updateGame({
                    currentPlayerIndex: nextPlayerIndex,
                    players: playersCopy,
                    turnState: 'start',
                    lastDiceRoll: [0, 0],
                    gameLog: [...gameData.gameLog, `‚è≠Ô∏è ${skippedPlayerName}'s turn was skipped!`, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                });
                return;
            }
            
            // üîí Check jail turns - auto-release after 3 turns (4th turn start)
            if (playersCopy[gameData.currentPlayerIndex].inJail) {
                playersCopy[gameData.currentPlayerIndex].jailTurns = (playersCopy[gameData.currentPlayerIndex].jailTurns || 0) + 1;
                if (playersCopy[gameData.currentPlayerIndex].jailTurns >= 4) {
                    playersCopy[gameData.currentPlayerIndex].inJail = false;
                    playersCopy[gameData.currentPlayerIndex].jailTurns = 0;
                    const logMessage = `‚è∞ ${playersCopy[gameData.currentPlayerIndex].name} automatically released from jail after 3 failed attempts.`;
                    await updateGame({
                        currentPlayerIndex: nextPlayerIndex,
                        players: playersCopy,
                        turnState: 'start',
                        lastDiceRoll: [0, 0],
                        gameLog: [...gameData.gameLog, logMessage, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                    });
                    return;
                }
            }
            
            await updateGame({
                currentPlayerIndex: nextPlayerIndex,
                players: playersCopy,
                turnState: 'start',
                lastDiceRoll: [0, 0],
                gameLog: [...gameData.gameLog, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
            });
        });
        
        async function handleLanding(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const propertyState = gameData.properties[position];
            
            addLog(`${currentPlayer.name} landed on ${space.name}.`);

            switch(space.type) {
                case 'property':
                case 'railroad':
                case 'utility':
                    if (propertyState.ownerId === null || (propertyState.owners && Object.keys(propertyState.owners).length === 0)) {
                        // Check if current player is a bot
                        if (currentPlayer.isBot) {
                            // Bot automatically decides whether to buy
                            await botDecidePropertyPurchase(position);
                        } else {
                            // Show property buy panel for human players
                            showPropertyBuyPanel(position);
                        }
                    } else if (propertyState.ownerId !== currentPlayer.id && !(propertyState.owners && propertyState.owners[currentPlayer.id])) {
                        // Kart ba≈üka birine ait ve bende hissem yok
                        payRent(position);
                    } else {
                        // Kartƒ±n sahibiyim veya hissem var - otomatik turn end
                        addLog('You own a share of this property. No rent to pay.');
                        // Kendi yerine gelince turn otomatik end olsun
                        setTimeout(() => {
                            updateGame({ turnState: 'action_complete' });
                            endTurn();
                        }, 1000);
                    }
                    break;
                case 'go_to_jail':
                    goToJail();
                    break;
                case 'chance':
                case 'community_chest':
                    drawCard(space.type);
                    break;
                case 'tax':
                    payTax(space.amount);
                    break;
                case 'free_parking':
                    addLog('üÖøÔ∏è Resting at Free Parking - nothing happens!');
                    // Free parking does nothing, so automatically end turn
                    setTimeout(() => endTurn(), 1000);
                    break;
                default:
                    handleAfterLanding();
            }
        }
        
        // üé≤ Handle actions after landing (rent payment, property actions, etc.)
        async function handleAfterLanding() {
            // Turn does not end automatically, player must click End Turn manually
        }
        
        async function botTurn() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Wait a bit for realism
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Roll dice - Geli≈ümi≈ü zar sistemi kullan
            const diceResult = rollDiceImproved(currentPlayer.position);
            const die1 = diceResult.die1;
            const die2 = diceResult.die2;
            const total = diceResult.total;
            const oldPosition = currentPlayer.position;
            const newPosition = (currentPlayer.position + total) % gameData.settings.board.length;
            const newMoney = currentPlayer.money;
            
            // üé≤ Bot zar animasyonu - insan oyuncular gibi g√∂r√ºns√ºn
            animate3DDiceRoll(die1, die2);
            
            // üìä Kare ziyaret istatistiklerini g√ºncelle
            if (!gameData.spaceVisits) {
                gameData.spaceVisits = new Array(gameData.settings.board.length).fill(0);
            }
            gameData.spaceVisits[newPosition] = (gameData.spaceVisits[newPosition] || 0) + 1;
            
            const isDouble = (die1 === die2);
            const rollPlayersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            let logMessages = [];
            logMessages.push(`üé≤ ${currentPlayer.name} rolled ${die1} + ${die2} = ${total}`);
            
            if (isDouble) {
                rollPlayersCopy[gameData.currentPlayerIndex].doublesCount = (currentPlayer.doublesCount || 0) + 1;
                logMessages.push(`üé≤ ${currentPlayer.name} rolled DOUBLES!`);
            }
            
            // Zar animasyonunun bitmesini bekle (1.5 saniye)
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // üé¨ Bot i√ßin karakter animasyonu
            await animatePlayerMovement(currentPlayer.id, oldPosition, newPosition, total);
            
            // Final pozisyonu ayarla
            rollPlayersCopy[gameData.currentPlayerIndex].position = newPosition;
            rollPlayersCopy[gameData.currentPlayerIndex].money = newMoney;
            
            await updateGame({
                lastDiceRoll: [die1, die2],
                players: rollPlayersCopy,
                turnState: 'rolled',
                spaceVisits: gameData.spaceVisits,
                gameLog: [...gameData.gameLog, ...logMessages]
            });
            
            // Wait for landing animation
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Handle landing
            await handleLanding(newPosition);
            
            // Bot automatically ends turn after landing
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // End turn logic for bot
            let nextPlayerIndex = (gameData.currentPlayerIndex + 1) % gameData.players.length;
            
            const botPlayersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // Check for extra turn from doubles (only if doubles rule is enabled)
            if (gameData.allowDoubles && gameData.players[gameData.currentPlayerIndex].doublesCount > 0) {
                nextPlayerIndex = gameData.currentPlayerIndex;
                botPlayersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            } else {
                // Skip bankrupt players
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
            }
            
            // Reset doubles count when moving to next player
            if (nextPlayerIndex !== gameData.currentPlayerIndex) {
                botPlayersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            }
            
            // ‚è≠Ô∏è Check if next player should skip their turn (from Skip Joker Card)
            if (botPlayersCopy[nextPlayerIndex].skipNextTurn) {
                botPlayersCopy[nextPlayerIndex].skipNextTurn = false;
                const skippedPlayerName = botPlayersCopy[nextPlayerIndex].name;
                
                // Move to the player after the skipped one
                nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                
                // Skip bankrupt players again
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
                
                await updateGame({
                    currentPlayerIndex: nextPlayerIndex,
                    players: botPlayersCopy,
                    turnState: 'start',
                    lastDiceRoll: [0, 0],
                    gameLog: [...gameData.gameLog, `‚è≠Ô∏è ${skippedPlayerName}'s turn was skipped!`, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                });
                
                window.isBotTurnInProgress = false;
                return;
            }
            
            // üîí Check jail turns - auto-release after 3 turns (4th turn start)
            if (botPlayersCopy[gameData.currentPlayerIndex].inJail) {
                botPlayersCopy[gameData.currentPlayerIndex].jailTurns = (botPlayersCopy[gameData.currentPlayerIndex].jailTurns || 0) + 1;
                if (botPlayersCopy[gameData.currentPlayerIndex].jailTurns >= 4) {
                    botPlayersCopy[gameData.currentPlayerIndex].inJail = false;
                    botPlayersCopy[gameData.currentPlayerIndex].jailTurns = 0;
                    const logMessage = `‚è∞ ${botPlayersCopy[gameData.currentPlayerIndex].name} automatically released from jail after 3 failed attempts.`;
                    await updateGame({
                        currentPlayerIndex: nextPlayerIndex,
                        players: botPlayersCopy,
                        turnState: 'start',
                        lastDiceRoll: [0, 0],
                        gameLog: [...gameData.gameLog, logMessage, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                    });
                    window.isBotTurnInProgress = false;
                    return;
                }
            }
            
            await updateGame({
                currentPlayerIndex: nextPlayerIndex,
                players: botPlayersCopy,
                turnState: 'start',
                lastDiceRoll: [0, 0],
                gameLog: [...gameData.gameLog, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
            });
            
            window.isBotTurnInProgress = false;
        }
        
        async function buyProperty(position) {
            // Eski buyProperty fonksiyonu - geriye d√∂n√ºk uyumluluk i√ßin
            return buyPropertyWithShare(position, 100);
        }
        
        async function buyPropertyWithShare(position, sharePercentage) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const cost = Math.floor(space.price * (sharePercentage / 100));
            
            // ü§ñ Bot kontrol√º - Bot ise direkt %100 alsƒ±n, modal g√∂sterme!
            if (currentPlayer.isBot) {
                sharePercentage = 100; // Botlar her zaman %100 alƒ±r
            }
            
            // Eƒüer %100 deƒüilse VE oyuncu bot deƒüilse, ortak se√ßmesi gerekiyor
            if (sharePercentage < 100 && !currentPlayer.isBot) {
                // Ortak se√ßme modalƒ±nƒ± g√∂ster (sadece ger√ßek oyuncular i√ßin)
                showPartnerSelectionModal(position, sharePercentage, cost);
                return;
            }
            
            // %100 ise veya bot ise direkt satƒ±n al
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const currentPlayerIndex = gameData.currentPlayerIndex;
            playersCopy[currentPlayerIndex].money -= cost;
            
            // Hisse sistemini ayarla
            if (!propertiesCopy[position].owners) {
                propertiesCopy[position].owners = {};
            }
            propertiesCopy[position].owners[playersCopy[currentPlayerIndex].id] = sharePercentage;
            propertiesCopy[position].ownerId = playersCopy[currentPlayerIndex].id;
            
            // üéµ Play purchase sound
            playSound('purchase');
            
            // üí´ Animate property purchase
            animatePropertyPurchase(position, currentPlayer.color);
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                turnState: 'action_complete',
                gameLog: [...gameData.gameLog, `${playersCopy[currentPlayerIndex].name} bought ${sharePercentage}% of ${space.name} for $${cost}.`] 
            });
        }
        
        // ü§ù Partner Selection Modal for Shared Property
        function showPartnerSelectionModal(position, sharePercentage, cost) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // ü§ñ Bot kontrol√º - Bot ise modal g√∂sterme!
            if (currentPlayer.isBot) {
                console.warn('‚ö†Ô∏è Bot cannot show partner selection modal!');
                // Bot i√ßin direkt %100 al
                buyPropertyWithShare(position, 100);
                return;
            }
            
            // Get other players who can afford the remaining share
            const remainingShare = 100 - sharePercentage;
            const remainingCost = Math.floor(space.price * (remainingShare / 100));
            
            const availablePartners = gameData.players.filter(p => 
                p.id !== currentPlayer.id && 
                !p.isBankrupt && 
                !p.isBot &&
                p.money >= remainingCost
            );
            
            if (availablePartners.length === 0) {
                showModal('No Partners Available', 
                    `<p>No other players can afford the remaining ${remainingShare}% share ($${remainingCost}).</p>
                     <p class="mt-2 text-sm text-gray-600">You can only buy 100% or start an auction.</p>`, 
                    [
                        {text: 'Buy 100% Instead', class: 'bg-green-600', action: () => {
                            hideModal();
                            buyPropertyWithShare(position, 100);
                        }},
                        {text: 'Start Auction', class: 'bg-yellow-500', action: () => {
                            hideModal();
                            startAuction(position);
                        }},
                        {text: 'Cancel', class: 'bg-gray-500', action: hideModal}
                    ]
                );
                return;
            }
            
            let partnerHTML = `
                <div class="text-left space-y-3">
                    <p class="text-center font-semibold text-gray-700">
                        You want to buy <span class="text-green-600">${sharePercentage}%</span> for <span class="text-green-600">$${cost}</span>
                    </p>
                    <p class="text-center text-sm text-gray-600">
                        Choose a partner to buy the remaining <span class="font-semibold">${remainingShare}%</span> for <span class="font-semibold">$${remainingCost}</span>
                    </p>
                    <div class="space-y-2 mt-4">
            `;
            
            availablePartners.forEach(partner => {
                partnerHTML += `
                    <button onclick="window.sendPartnershipRequest('${position}', ${sharePercentage}, '${partner.id}')" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-between transition duration-200">
                        <span>${partner.name}</span>
                        <span class="text-sm">üí∞ $${partner.money}</span>
                    </button>
                `;
            });
            
            partnerHTML += `
                    </div>
                    <p class="text-xs text-gray-500 text-center mt-4">
                        üí° Your partner will receive a notification to accept or decline the partnership.
                    </p>
                </div>
            `;
            
            showModal(`ü§ù Choose Your Partner`, partnerHTML, [
                {text: 'Cancel', class: 'bg-gray-500', action: () => {
                    hideModal();
                    showPropertyBuyPanel(position); // Go back to buy panel
                }}
            ]);
        }
        
        // üì§ Send Partnership Request
        window.sendPartnershipRequest = async function(position, mySharePercentage, partnerId) {
            hideModal();
            
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const partner = gameData.players.find(p => p.id === partnerId);
            
            // Don't send partnership requests to bots
            if (partner && partner.isBot) {
                showModal('Cannot Send Partnership', 'You cannot send partnership requests to bot players.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            const partnerSharePercentage = 100 - mySharePercentage;
            const myCost = Math.floor(space.price * (mySharePercentage / 100));
            const partnerCost = Math.floor(space.price * (partnerSharePercentage / 100));
            
            // Create partnership request
            const partnershipRequest = {
                id: `partnership_${Date.now()}`,
                propertyPosition: position,
                propertyName: space.name,
                requesterId: currentPlayer.id,
                requesterName: currentPlayer.name,
                requesterShare: mySharePercentage,
                requesterCost: myCost,
                partnerId: partnerId,
                partnerName: partner.name,
                partnerShare: partnerSharePercentage,
                partnerCost: partnerCost,
                status: 'pending',
                timestamp: Date.now()
            };
            
            // Add to game data
            const partnershipRequests = gameData.partnershipRequests || [];
            partnershipRequests.push(partnershipRequest);
            
            await updateGame({
                partnershipRequests: partnershipRequests,
                gameLog: [...gameData.gameLog, `ü§ù ${currentPlayer.name} sent a partnership request to ${partner.name} for ${space.name}`]
            });
            
            showModal('Partnership Request Sent', 
                `<p>Your partnership request has been sent to <span class="font-bold">${partner.name}</span>.</p>
                 <p class="text-sm text-gray-600 mt-2">Waiting for their response...</p>`, 
                [{text: 'OK', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        // üì¨ Check for Partnership Requests
        function checkPartnershipRequests() {
            if (!gameData || !gameData.partnershipRequests) return;
            
            const myRequests = gameData.partnershipRequests.filter(req => 
                req.partnerId === localPlayer.id && req.status === 'pending'
            );
            
            if (myRequests.length > 0) {
                const latestRequest = myRequests[myRequests.length - 1];
                
                // Check if the current player (who might be receiving this request) is a bot
                const currentPlayer = gameData.players[gameData.currentPlayerIndex];
                if (currentPlayer && currentPlayer.id === localPlayer.id && currentPlayer.isBot) {
                    // Bot automatically decides on partnership
                    botDecidePartnership(latestRequest);
                } else {
                    // Show modal for human players
                    showPartnershipRequestModal(latestRequest);
                }
            }
        }
        
        // ü§ñ Bot Partnership Decision
        async function botDecidePartnership(request) {
            // Bot thinks for 2 seconds before deciding
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const requester = gameData.players.find(p => p.id === request.requesterId);
            const partner = gameData.players.find(p => p.id === request.partnerId);
            const space = gameData.settings.board[request.propertyPosition];
            
            if (!requester || !partner) {
                declinePartnership(request.id);
                return;
            }
            
            // Check if bot can afford
            if (partner.money < request.partnerCost) {
                addLog(`ü§ñ ${partner.name} declined partnership with ${requester.name} for ${space.name} (can't afford $${request.partnerCost}).`);
                declinePartnership(request.id);
                return;
            }
            
            // Calculate property value score (same as in property purchase)
            let propertyValueScore = 0;
            switch(space.type) {
                case 'railroad': propertyValueScore = 80; break;
                case 'utility': propertyValueScore = 70; break;
                case 'property':
                    const colorGroups = {
                        'brown': 40, 'lightblue': 45, 'pink': 50, 'orange': 55,
                        'red': 60, 'yellow': 65, 'green': 70, 'darkblue': 75
                    };
                    propertyValueScore = colorGroups[space.color] || 50;
                    break;
            }
            
            // Partner trust score (based on existing partnerships)
            let trustScore = 50; // Base trust
            let existingPartnerships = 0;
            
            // Count existing partnerships between these players
            Object.values(gameData.properties).forEach(property => {
                if (property.owners && property.owners[requester.id] && property.owners[partner.id]) {
                    existingPartnerships++;
                    trustScore += 10; // Bonus for existing partnerships
                }
            });
            
            // Adjust trust based on requester's financial situation
            const requesterMoneyRatio = requester.money / (requester.money + partner.money);
            if (requesterMoneyRatio > 0.6) trustScore += 10; // Requester is wealthier
            else if (requesterMoneyRatio < 0.4) trustScore -= 10; // Requester is poorer
            
            // Cost fairness score
            const myShareRatio = request.partnerShare / 100;
            const costFairness = Math.abs(myShareRatio - (request.partnerCost / space.price));
            const fairnessScore = Math.max(0, 100 - (costFairness * 200)); // Penalize unfair deals
            
            // Strategic value: Check if this completes a color group
            let strategicBonus = 0;
            if (space.type === 'property') {
                const sameColorProperties = gameData.settings.board.filter(p => 
                    p.type === 'property' && p.color === space.color
                );
                const partnerOwnedSameColor = sameColorProperties.filter(p => 
                    gameData.properties[p.position] && 
                    (gameData.properties[p.position].ownerId === partner.id ||
                     (gameData.properties[p.position].owners && gameData.properties[p.position].owners[partner.id]))
                ).length;
                
                if (partnerOwnedSameColor > 0) {
                    strategicBonus = 15; // Bonus for completing color groups
                }
            }
            
            // Calculate final decision score
            const finalScore = (propertyValueScore * 0.3) + (trustScore * 0.25) + (fairnessScore * 0.25) + (strategicBonus * 0.2);
            
            if (finalScore >= 65) {
                // Accept partnership
                addLog(`ü§ñ ${partner.name} accepted partnership with ${requester.name} for ${request.partnerShare}% of ${space.name} (cost: $${request.partnerCost}).`);
                
                // Accept partnership - implement bot logic inline
                const requests = [...(gameData.partnershipRequests || [])];
                const partnershipRequest = requests.find(r => r.id === request.id);
                
                if (partnershipRequest) {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
                    
                    const requesterIndex = playersCopy.findIndex(p => p.id === partnershipRequest.requesterId);
                    const partnerIndex = playersCopy.findIndex(p => p.id === partnershipRequest.partnerId);
                    
                    // Deduct money
                    playersCopy[requesterIndex].money -= partnershipRequest.requesterCost;
                    playersCopy[partnerIndex].money -= partnershipRequest.partnerCost;
                    
                    // Set up ownership
                    if (!propertiesCopy[partnershipRequest.propertyPosition].owners) {
                        propertiesCopy[partnershipRequest.propertyPosition].owners = {};
                    }
                    propertiesCopy[partnershipRequest.propertyPosition].owners[partnershipRequest.requesterId] = partnershipRequest.requesterShare;
                    propertiesCopy[partnershipRequest.propertyPosition].owners[partnershipRequest.partnerId] = partnershipRequest.partnerShare;
                    
                    // Determine main owner (highest share)
                    const mainOwner = partnershipRequest.requesterShare > partnershipRequest.partnerShare ? partnershipRequest.requesterId : partnershipRequest.partnerId;
                    propertiesCopy[partnershipRequest.propertyPosition].ownerId = mainOwner;
                    
                    // Remove request
                    const updatedRequests = requests.filter(r => r.id !== partnershipRequest.id);
                    
                    await updateGame({
                        players: playersCopy,
                        properties: propertiesCopy,
                        partnershipRequests: updatedRequests,
                        turnState: 'action_complete',
                        gameLog: [...gameData.gameLog, `ü§ù ${partnershipRequest.requesterName} and ${partnershipRequest.partnerName} became partners on ${partnershipRequest.propertyName}!`]
                    });
                }
            } else {
                // Decline partnership
                addLog(`ü§ñ ${partner.name} declined partnership with ${requester.name} for ${space.name} (score: ${Math.round(finalScore)}).`);
                
                // Decline partnership - implement bot logic inline
                const requests = [...(gameData.partnershipRequests || [])];
                const partnershipRequest = requests.find(r => r.id === request.id);
                
                if (partnershipRequest) {
                    // Remove request
                    const updatedRequests = requests.filter(r => r.id !== partnershipRequest.id);
                    
                    // Add to declined list so requester knows
                    const declinedRequests = gameData.declinedPartnershipRequests || [];
                    declinedRequests.push({
                        ...partnershipRequest,
                        declinedAt: Date.now()
                    });
                    
                    await updateGame({
                        partnershipRequests: updatedRequests,
                        declinedPartnershipRequests: declinedRequests,
                        gameLog: [...gameData.gameLog, `‚ùå ${partnershipRequest.partnerName} declined partnership with ${partnershipRequest.requesterName} for ${partnershipRequest.propertyName}`]
                    });
                }
            }
        }
        
        // ü§ñ Bot Trade Decision
        async function botDecideTrade(trade) {
            // Bot thinks for 2 seconds before deciding
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
            const toPlayer = gameData.players.find(p => p.id === trade.toId);
            
            if (!fromPlayer || !toPlayer) {
                rejectTrade(trade.id);
                return;
            }
            
            // Bot is the receiver (toPlayer), so calculate what bot is giving vs receiving
            const botGivingValue = (trade.request.money || 0) + 
                ((trade.request.properties || []).reduce((sum, propIndex) => {
                    const space = gameData.settings.board[propIndex];
                    return sum + (space ? space.price : 0);
                }, 0));
            
            const botReceivingValue = (trade.offer.money || 0) + 
                ((trade.offer.properties || []).reduce((sum, propIndex) => {
                    const space = gameData.settings.board[propIndex];
                    return sum + (space ? space.price : 0);
                }, 0));
            
            // Value difference (positive if bot gains value)
            const valueDiff = botReceivingValue - botGivingValue;
            
            // Bot decision logic:
            // 1. If bot is getting significantly more value (at least 20% more), likely accept
            // 2. If trade is roughly equal (within 10%), 50% chance to accept
            // 3. If bot is losing value, mostly decline but small chance to accept (10%)
            
            let acceptChance = 0;
            
            if (valueDiff >= botGivingValue * 0.2) {
                // Getting 20%+ more value - 80% chance to accept
                acceptChance = 0.8;
            } else if (Math.abs(valueDiff) <= botGivingValue * 0.1) {
                // Roughly equal trade - 50% chance to accept
                acceptChance = 0.5;
            } else if (valueDiff > 0) {
                // Getting some value but less than 20% - 60% chance to accept
                acceptChance = 0.6;
            } else {
                // Losing value - 10% chance to accept (bot might make mistakes)
                acceptChance = 0.1;
            }
            
            const shouldAccept = Math.random() < acceptChance;
            
            if (shouldAccept) {
                console.log(`ü§ñ ${toPlayer.name} accepted trade (value diff: $${valueDiff})`);
                acceptTrade(trade.id);
            } else {
                console.log(`ü§ñ ${toPlayer.name} rejected trade (value diff: $${valueDiff})`);
                rejectTrade(trade.id);
            }
        }
        
        // ‚ùå Check for Declined Partnerships
        let lastCheckedDeclinedTime = 0;
        function checkDeclinedPartnerships(oldGameData) {
            if (!gameData || !gameData.declinedPartnershipRequests) return;
            
            const oldDeclined = (oldGameData && oldGameData.declinedPartnershipRequests) || [];
            const newDeclined = gameData.declinedPartnershipRequests || [];
            
            // Find newly declined requests for current player
            const myNewDeclinedRequests = newDeclined.filter(declined => {
                const isNew = !oldDeclined.find(old => old.id === declined.id);
                const isMine = declined.requesterId === localPlayer.id;
                const isRecent = declined.declinedAt > lastCheckedDeclinedTime;
                return isNew && isMine && isRecent;
            });
            
            if (myNewDeclinedRequests.length > 0) {
                const declined = myNewDeclinedRequests[0];
                lastCheckedDeclinedTime = declined.declinedAt;
                
                // Check if I'm current player and property is still available
                const currentPlayer = gameData.players[gameData.currentPlayerIndex];
                if (currentPlayer && currentPlayer.id === localPlayer.id) {
                    const propertyState = gameData.properties[declined.propertyPosition];
                    if (propertyState && (propertyState.ownerId === null || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                        // Show notification and then buy panel
                        showModal('‚ùå Partnership Declined', 
                            `<p><span class="font-bold">${declined.partnerName}</span> declined your partnership offer for <span class="font-bold">${declined.propertyName}</span>.</p>
                             <p class="text-sm text-gray-600 mt-2">You must now buy it fully or start an auction.</p>`, 
                            [{text: 'OK', class: 'bg-blue-500', action: () => {
                                hideModal();
                                showPropertyBuyPanel(declined.propertyPosition);
                            }}]
                        );
                    }
                }
            }
        }
        
        // üì® Show Partnership Request Modal
        function showPartnershipRequestModal(request) {
            const requester = gameData.players.find(p => p.id === request.requesterId);
            const me = gameData.players.find(p => p.id === localPlayer.id);
            
            if (!requester || !me) return;
            
            const canAfford = me.money >= request.partnerCost;
            
            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">ü§ù Partnership Offer</h4>
                        <p class="text-sm"><span class="font-semibold">${requester.name}</span> wants to partner with you on:</p>
                        <p class="text-lg font-bold text-gray-800 mt-2">${request.propertyName}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Their Share</p>
                            <p class="text-xl font-bold text-green-700">${request.requesterShare}%</p>
                            <p class="text-sm text-gray-700">$${request.requesterCost}</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Your Share</p>
                            <p class="text-xl font-bold text-purple-700">${request.partnerShare}%</p>
                            <p class="text-sm ${canAfford ? 'text-gray-700' : 'text-red-600'}">$${request.partnerCost}</p>
                        </div>
                    </div>
                    
                    ${!canAfford ? '<p class="text-red-600 text-sm text-center">‚ö†Ô∏è You don\'t have enough money!</p>' : ''}
                    
                    <p class="text-xs text-gray-500 text-center">
                        üí° You'll share rental income and building rights based on ownership percentage.
                    </p>
                </div>
            `;
            
            showModal(`ü§ù Partnership Request`, body, [
                {text: '‚úÖ Accept Partnership', class: 'bg-green-600 hover:bg-green-700', 
                 action: () => acceptPartnership(request.id), disabled: !canAfford},
                {text: '‚ùå Decline', class: 'bg-red-600 hover:bg-red-700', 
                 action: () => declinePartnership(request.id)}
            ]);
        }
        
        // ‚úÖ Accept Partnership
        async function acceptPartnership(requestId) {
            const requests = [...(gameData.partnershipRequests || [])];
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                hideModal();
                return;
            }
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const requesterIndex = playersCopy.findIndex(p => p.id === request.requesterId);
            const partnerIndex = playersCopy.findIndex(p => p.id === request.partnerId);
            
            // Deduct money
            playersCopy[requesterIndex].money -= request.requesterCost;
            playersCopy[partnerIndex].money -= request.partnerCost;
            
            // Set up ownership
            if (!propertiesCopy[request.propertyPosition].owners) {
                propertiesCopy[request.propertyPosition].owners = {};
            }
            propertiesCopy[request.propertyPosition].owners[request.requesterId] = request.requesterShare;
            propertiesCopy[request.propertyPosition].owners[request.partnerId] = request.partnerShare;
            
            // Determine main owner (highest share)
            const mainOwner = request.requesterShare > request.partnerShare ? request.requesterId : request.partnerId;
            propertiesCopy[request.propertyPosition].ownerId = mainOwner;
            
            // Remove request
            const updatedRequests = requests.filter(r => r.id !== requestId);
            
            // üéµ Play purchase sound
            playSound('purchase');
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                partnershipRequests: updatedRequests,
                turnState: 'action_complete',
                gameLog: [...gameData.gameLog, `ü§ù ${request.requesterName} and ${request.partnerName} became partners on ${request.propertyName}!`]
            });
            
            hideModal();
            showModal('üéâ Partnership Accepted!', 
                `<p>You are now partners with <span class="font-bold">${request.requesterName}</span> on <span class="font-bold">${request.propertyName}</span>!</p>
                 <p class="text-sm text-gray-600 mt-2">You own ${request.partnerShare}% and they own ${request.requesterShare}%.</p>`, 
                [{text: 'Great!', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        // ‚ùå Decline Partnership
        async function declinePartnership(requestId) {
            const requests = [...(gameData.partnershipRequests || [])];
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                hideModal();
                return;
            }
            
            // Remove request
            const updatedRequests = requests.filter(r => r.id !== requestId);
            
            // Add to declined list so requester knows
            const declinedRequests = gameData.declinedPartnershipRequests || [];
            declinedRequests.push({
                ...request,
                declinedAt: Date.now()
            });
            
            await updateGame({
                partnershipRequests: updatedRequests,
                declinedPartnershipRequests: declinedRequests,
                gameLog: [...gameData.gameLog, `‚ùå ${request.partnerName} declined partnership with ${request.requesterName} for ${request.propertyName}`]
            });
            
            hideModal();
            showModal('Partnership Declined', 
                `<p>You declined the partnership offer for <span class="font-bold">${request.propertyName}</span>.</p>`, 
                [{text: 'OK', class: 'bg-gray-500', action: hideModal}]
            );
        }
        
        // Auction system with timer - everyone can bid but not twice in a row
        let auctionTimerInterval = null;
        
        function startAuction(position) {
            // Close both modal and property buy panel
            hideModal();
            hidePropertyBuyPanel();
            
            const space = gameData.settings.board[position];
            const auctionTimer = gameData.settings.auctionTimer || 10;
            
            // Get all non-bankrupt players
            const activePlayers = gameData.players.filter(p => !p.isBankrupt).map(p => p.id);
            
            const auction = {
                position: position,
                propertyName: space.name,
                currentBid: 10, // Start at $10
                currentBidder: null,
                lastBidder: null, // Track who bid last (can't bid twice in a row)
                playersInAuction: activePlayers,
                timeRemaining: auctionTimer,
                timerDuration: auctionTimer,
                active: true,
                roundsWithoutBid: 0 // Track if everyone passed
            };
            
            updateGame({
                auction: auction,
                gameLog: [...gameData.gameLog, `üî® Auction started for ${space.name}! Starting bid: $10`]
            });
        }
        
        function showAuctionModal() {
            if (!gameData.auction || !gameData.auction.active) return;
            
            const space = gameData.settings.board[gameData.auction.position];
            const currentPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const amIInAuction = gameData.auction.playersInAuction.includes(localPlayer.id);
            
            // Can bid if: in auction, not bankrupt, not the last bidder, and can afford
            const iAmLastBidder = gameData.auction.lastBidder === localPlayer.id;
            const canBidAtAll = currentPlayer && !currentPlayer.isBankrupt && 
                               amIInAuction && !iAmLastBidder;
            
            const bidderName = gameData.auction.currentBidder 
                ? gameData.players.find(p => p.id === gameData.auction.currentBidder)?.name 
                : 'None';
            
            // Calculate bid amounts that player can afford
            const canAfford10 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 10);
            const canAfford50 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 50);
            const canAfford100 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 100);
            
            let statusMessage = '';
            if (iAmLastBidder) {
                statusMessage = '‚è≥ Waiting for others to bid...';
            } else if (canBidAtAll) {
                statusMessage = '‚úÖ You can bid now!';
            } else if (!amIInAuction) {
                statusMessage = '‚ùå You passed';
            } else {
                statusMessage = '‚è≥ Waiting...';
            }
            
            showModal(
                `üî® Auction: ${gameData.auction.propertyName}`,
                `
                    <div class="text-center">
                        <p class="text-lg mb-2">Current Bid: <span class="font-bold text-green-600">$${gameData.auction.currentBid}</span></p>
                        <p class="text-sm mb-2">Highest Bidder: <span class="font-bold">${bidderName}</span></p>
                        <p class="text-sm text-gray-600">Your Money: $${currentPlayer?.money || 0}</p>
                        <div class="mt-3 p-2 ${iAmLastBidder ? 'bg-yellow-50' : 'bg-blue-50'} rounded">
                            <p class="text-sm font-bold ${iAmLastBidder ? 'text-yellow-600' : 'text-blue-600'}">
                                ${statusMessage}
                            </p>
                            <p class="text-xl font-bold ${gameData.auction.timeRemaining <= 3 ? 'text-red-600' : 'text-blue-600'} mt-1">
                                ‚è±Ô∏è ${gameData.auction.timeRemaining}s
                            </p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Players remaining: ${gameData.auction.playersInAuction.length}</p>
                        ${iAmLastBidder ? '<p class="text-xs text-yellow-600 mt-1">You must wait for someone else to bid before bidding again</p>' : ''}
                    </div>
                `,
                [
                    { 
                        text: `+$10 (Total: $${gameData.auction.currentBid + 10})`, 
                        class: 'bg-green-500', 
                        action: () => placeBid(gameData.auction.currentBid + 10),
                        disabled: !canBidAtAll || !canAfford10
                    },
                    { 
                        text: `+$50 (Total: $${gameData.auction.currentBid + 50})`, 
                        class: 'bg-green-600', 
                        action: () => placeBid(gameData.auction.currentBid + 50),
                        disabled: !canBidAtAll || !canAfford50
                    },
                    { 
                        text: `+$100 (Total: $${gameData.auction.currentBid + 100})`, 
                        class: 'bg-green-700', 
                        action: () => placeBid(gameData.auction.currentBid + 100),
                        disabled: !canBidAtAll || !canAfford100
                    },
                    { 
                        text: 'Pass', 
                        class: 'bg-red-500', 
                        action: () => passAuction(),
                        disabled: !amIInAuction
                    }
                ]
            );
        }
        
        function placeBid(amount, playerId = null) {
            // Eƒüer playerId verilmediyse localPlayer.id kullan (oyuncu bid veriyor)
            // Eƒüer playerId verildiyse o ID'yi kullan (bot bid veriyor)
            const bidderId = playerId || localPlayer.id;
            const currentPlayer = gameData.players.find(p => p.id === bidderId);
            
            if (!currentPlayer) {
                console.error('Cannot place bid: Player not found');
                return;
            }
            
            // Bot kontrol√º sadece oyuncular i√ßin - botlar kendi ID'leri ile bid verebilir
            if (!playerId && currentPlayer.isBot) {
                console.warn('‚ö†Ô∏è Bots must use placeBid with their own playerId!');
                return;
            }
            
            if (amount > currentPlayer.money) {
                if (!playerId) {
                    // Sadece oyuncular i√ßin alert g√∂ster
                alert('You don\'t have enough money!');
                }
                return;
            }
            
            if (gameData.auction.lastBidder === bidderId) {
                if (!playerId) {
                    // Sadece oyuncular i√ßin alert g√∂ster
                alert('You must wait for someone else to bid!');
                }
                return;
            }
            
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            auctionCopy.currentBid = amount;
            auctionCopy.currentBidder = bidderId;
            auctionCopy.lastBidder = bidderId;
            auctionCopy.roundsWithoutBid = 0; // Reset because someone bid
            
            // Reset timer when someone bids
            auctionCopy.timeRemaining = auctionCopy.timerDuration;
            
            updateGame({
                auction: auctionCopy,
                gameLog: [...gameData.gameLog, `${currentPlayer.name} bids $${amount}!`]
            });
        }
        
        function passAuction() {
            if (!gameData.auction.playersInAuction.includes(localPlayer.id)) {
                alert('You already passed!');
                return;
            }
            
            hideModal();
            
            const currentPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            
            // Remove current player from auction
            auctionCopy.playersInAuction = auctionCopy.playersInAuction.filter(id => id !== localPlayer.id);
            
            // Check if this player was the only one left
            if (auctionCopy.playersInAuction.length === 0) {
                updateGame({
                    auction: auctionCopy,
                    gameLog: [...gameData.gameLog, `${currentPlayer.name} passed. Everyone passed!`]
                });
                setTimeout(() => endAuction(), 500);
                return;
            }
            
            // Check if only the current bidder is left
            if (auctionCopy.playersInAuction.length === 1 && auctionCopy.currentBidder && 
                auctionCopy.playersInAuction[0] === auctionCopy.currentBidder) {
                updateGame({
                    auction: auctionCopy,
                    gameLog: [...gameData.gameLog, `${currentPlayer.name} passed. Only bidder remains!`]
                });
                setTimeout(() => endAuction(), 500);
                return;
            }
            
            // Reset timer
            auctionCopy.timeRemaining = auctionCopy.timerDuration;
            
            updateGame({
                auction: auctionCopy,
                gameLog: [...gameData.gameLog, `${currentPlayer.name} passed.`]
            });
        }
        
        // Timer countdown function
        function updateAuctionTimer() {
            if (!gameData.auction || !gameData.auction.active) {
                if (auctionTimerInterval) {
                    clearInterval(auctionTimerInterval);
                    auctionTimerInterval = null;
                }
                return;
            }
            
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            auctionCopy.timeRemaining--;
            
            if (auctionCopy.timeRemaining <= 0) {
                // Time's up! Check if there was a bidder
                if (auctionCopy.currentBidder) {
                    // Someone bid, they win!
                    updateGame({
                        auction: auctionCopy,
                        gameLog: [...gameData.gameLog, `‚è∞ Time's up! Auction ending...`]
                    });
                    setTimeout(() => endAuction(), 500);
                } else {
                    // No one bid, auction fails
                    auctionCopy.playersInAuction = [];
                    updateGame({
                        auction: auctionCopy,
                        gameLog: [...gameData.gameLog, `‚è∞ Time's up! No bids received.`]
                    });
                    setTimeout(() => endAuction(), 500);
                }
            } else {
                // Just update timer
                updateGame({
                    auction: auctionCopy
                });
            }
        }
        
        async function endAuction() {
            if (!gameData.auction) return;
            
            // Clear timer
            if (auctionTimerInterval) {
                clearInterval(auctionTimerInterval);
                auctionTimerInterval = null;
            }
            
            // Close auction modal for everyone
            hideModal();
            
            if (gameData.auction.currentBidder) {
                // Winner buys the property
                const winner = gameData.players.find(p => p.id === gameData.auction.currentBidder);
                const winnerIndex = gameData.players.findIndex(p => p.id === gameData.auction.currentBidder);
                
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
                
                playersCopy[winnerIndex].money -= gameData.auction.currentBid;
                propertiesCopy[gameData.auction.position].ownerId = gameData.auction.currentBidder;
                
                await updateGame({
                    players: playersCopy,
                    properties: propertiesCopy,
                    auction: { active: false },
                    gameLog: [...gameData.gameLog, `üî® ${winner.name} won the auction for ${gameData.auction.propertyName} at $${gameData.auction.currentBid}!`]
                });
                
                // Show brief notification (auto-closes)
                showModal('üéâ Auction Won!', `${winner.name} won ${gameData.auction.propertyName} for $${gameData.auction.currentBid}!`, [
                    { text: 'Continue', class: 'bg-blue-500', action: hideModal }
                ]);
                
                // Auto-close after 2 seconds
                setTimeout(() => {
                    hideModal();
                }, 2000);
            } else {
                await updateGame({
                    auction: { active: false },
                    gameLog: [...gameData.gameLog, `üî® Auction ended with no bids for ${gameData.auction.propertyName}.`]
                });
                hideModal();
            }
            
            endTurn();
        }

        
        async function payRent(position) {
            const space = gameData.settings.board[position];
            const propertyState = gameData.properties[position];
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            
            // Check if property is mortgaged
            if (propertyState.mortgaged) {
                addLog(`${currentPlayer.name} landed on ${space.name}, but it's mortgaged. No rent to pay.`);
                endTurn();
                return;
            }

            let baseRent = 0;
            if (space.type === 'property') {
                baseRent = space.rent[propertyState.houses];
            } else if (space.type === 'railroad') {
                const owner = gameData.players.find(p => p.id === propertyState.ownerId);
                const railCount = gameData.properties.filter(p => p.ownerId === owner.id && gameData.settings.board[p.spaceIndex].type === 'railroad').length;
                baseRent = 25 * Math.pow(2, railCount - 1);
            } else if (space.type === 'utility') {
                const owner = gameData.players.find(p => p.id === propertyState.ownerId);
                const utilityCount = gameData.properties.filter(p => p.ownerId === owner.id && gameData.settings.board[p.spaceIndex].type === 'utility').length;
                const diceTotal = gameData.lastDiceRoll && gameData.lastDiceRoll.length === 2 
                    ? gameData.lastDiceRoll[0] + gameData.lastDiceRoll[1] 
                    : 7; // Default to 7 if dice roll not available
                // 1 utility = 4x dice, 2 utilities = 10x dice
                baseRent = utilityCount === 1 ? diceTotal * 4 : diceTotal * 10;
            }
            
            // Hisse sahiplerine g√∂re kira daƒüƒ±tƒ±mƒ±
            const owners = propertyState.owners || { [propertyState.ownerId]: 100 };
            
            // Check if current player owns shares
            const playerShare = owners[currentPlayer.id] || 0;
            
            // Player pays only the portion they don't own
            const rentToPay = Math.floor(baseRent * ((100 - playerShare) / 100));
            
            if (rentToPay === 0) {
                addLog(`${currentPlayer.name} landed on their own property and pays no rent.`);
                endTurn();
                return;
            }
            
            // Bot ise direkt √∂de, modal g√∂sterme
            if (currentPlayer.isBot) {
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                
                // Kiradan payƒ±nƒ± √ßƒ±kar
                playersCopy[currentPlayerIndex].money -= rentToPay;
                
                // Kira hisse sahiplerine daƒüƒ±tƒ±lƒ±r (kendisi hari√ß)
                for (const [ownerId, sharePercentage] of Object.entries(owners)) {
                    if (ownerId === currentPlayer.id) continue; // Skip self
                    
                    const ownerShare = Math.floor(baseRent * (sharePercentage / 100));
                    const ownerIndex = playersCopy.findIndex(p => p.id === ownerId);
                    if (ownerIndex !== -1) {
                        playersCopy[ownerIndex].money += ownerShare;
                        const ownerName = playersCopy[ownerIndex].name;
                        addLog(`ü§ñ ${currentPlayer.name} paid $${ownerShare} (${sharePercentage}% of $${baseRent}) to ${ownerName}.`);
                    }
                }
                
                await updateGame({ players: playersCopy });
                
                // Check for bankruptcy after rent payment
                const isBankrupt = await checkBankruptcy(currentPlayerIndex);
                if (!isBankrupt) {
                    endTurn();
                }
                return;
            }
            
            // Human player i√ßin modal g√∂ster
            showModal(
                'Pay Rent',
                `<p>You landed on ${space.name}. You must pay $${rentToPay} in rent.</p>
                 <p class="text-xs text-gray-600 mt-2">You own ${playerShare}% of this property.</p>`,
                [{ text: 'Pay Rent', class: 'bg-red-500', action: async () => {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    
                    // Kiradan payƒ±nƒ± √ßƒ±kar
                    playersCopy[currentPlayerIndex].money -= rentToPay;
                    
                    // Kira hisse sahiplerine daƒüƒ±tƒ±lƒ±r (kendisi hari√ß)
                    for (const [ownerId, sharePercentage] of Object.entries(owners)) {
                        if (ownerId === currentPlayer.id) continue; // Skip self
                        
                        const ownerShare = Math.floor(baseRent * (sharePercentage / 100));
                        const ownerIndex = playersCopy.findIndex(p => p.id === ownerId);
                        if (ownerIndex !== -1) {
                            playersCopy[ownerIndex].money += ownerShare;
                            const ownerName = playersCopy[ownerIndex].name;
                            addLog(`${currentPlayer.name} paid $${ownerShare} (${sharePercentage}% of $${baseRent}) to ${ownerName}.`);
                        }
                    }
                    
                    await updateGame({ players: playersCopy });
                    hideModal();
                    
                    // Check for bankruptcy after rent payment
                    const isBankrupt = await checkBankruptcy(currentPlayerIndex);
                    if (!isBankrupt) {
                        endTurn();
                    }
                }}]
            );
        }

        async function goToJail() {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const jailPosition = gameData.settings.board.findIndex(s => s.type === 'jail');
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            playersCopy[currentPlayerIndex].position = jailPosition;
            playersCopy[currentPlayerIndex].inJail = true;
            playersCopy[currentPlayerIndex].jailTurns = 0;
            
            addLog(`${playersCopy[currentPlayerIndex].name} was sent to jail!`);
            await updateGame({ players: playersCopy });
            endTurn();
        }

        async function drawCard(type) {
            const cards = type === 'chance' ? gameData.settings.chanceCards : gameData.settings.communityChestCards;
            
            if (!cards || cards.length === 0) {
                addLog('No cards available in this game mode.');
                endTurn();
                return;
            }
            
            const card = cards[Math.floor(Math.random() * cards.length)];
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            addLog(`${playersCopy[currentPlayerIndex].name} drew: "${card.text}"`);
            
            let actionText = card.text;
            let autoClose = false;
            
            switch(card.action) {
                case 'add_money':
                    playersCopy[currentPlayerIndex].money += card.amount;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
                case 'remove_money':
                    playersCopy[currentPlayerIndex].money -= card.amount;
                    await updateGame({ players: playersCopy });
                    // Check bankruptcy after money removal
                    const bankruptAfterCard = await checkBankruptcy(currentPlayerIndex);
                    if (bankruptAfterCard) return; // Don't continue if bankrupt
                    autoClose = true;
                    break;
                case 'move_to':
                    playersCopy[currentPlayerIndex].position = card.space;
                    if (card.collect) {
                        playersCopy[currentPlayerIndex].money += gameData.settings.passGoAmount;
                    }
                    await updateGame({ players: playersCopy });
                    setTimeout(() => { 
                        hideModal(); 
                        handleLanding(card.space);
                        // Eƒüer property ise ve alƒ±nabilir durumdaysa, paneli g√∂ster
                        const space = gameData.settings.board[card.space];
                        const propertyState = gameData.properties[card.space];
                        if (space.type === 'property' && (!propertyState.ownerId || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                            showPropertyBuyPanel(card.space);
                        } else {
                            updateGame({ turnState: 'action_complete' });
                        }
                    }, 1000);
                    break;
                case 'move_back':
                    // Go back N spaces
                    const oldPos = playersCopy[currentPlayerIndex].position;
                    const newPos = (oldPos - card.amount + gameData.settings.board.length) % gameData.settings.board.length;
                    playersCopy[currentPlayerIndex].position = newPos;
                    await updateGame({ players: playersCopy });
                    setTimeout(() => {
                        hideModal();
                        handleLanding(newPos);
                        // Eƒüer property ise ve alƒ±nabilir durumdaysa, paneli g√∂ster
                        const space = gameData.settings.board[newPos];
                        const propertyState = gameData.properties[newPos];
                        if (space.type === 'property' && (!propertyState.ownerId || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                            showPropertyBuyPanel(newPos);
                        } else {
                            updateGame({ turnState: 'action_complete' });
                        }
                    }, 1000);
                    break;
                case 'go_to_jail':
                    hideModal();
                    await goToJail();
                    return;
                case 'get_out_of_jail':
                    playersCopy[currentPlayerIndex].getOutOfJailCards++;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
                case 'repair':
                    const houseCount = gameData.properties.filter(p => p.ownerId === playersCopy[currentPlayerIndex].id && p.houses > 0 && p.houses < 5).reduce((sum, p) => sum + p.houses, 0);
                    const hotelCount = gameData.properties.filter(p => p.ownerId === playersCopy[currentPlayerIndex].id && p.houses === 5).length;
                    const repairCost = (houseCount * card.house) + (hotelCount * card.hotel);
                    playersCopy[currentPlayerIndex].money -= repairCost;
                    actionText += `\n\nTotal cost: $${repairCost}`;
                    await updateGame({ players: playersCopy });
                    // Check bankruptcy after repair costs
                    const bankruptAfterRepair = await checkBankruptcy(currentPlayerIndex);
                    if (bankruptAfterRepair) return; // Don't continue if bankrupt
                    autoClose = true;
                    break;
            }
            
            // Bot ise modal g√∂sterme, direkt i≈ülemi yap
            if (currentPlayer.isBot) {
                if (autoClose) {
                    endTurn();
                }
                return;
            }
            
            // Human player i√ßin modal g√∂ster
            showModal(
                type === 'chance' ? '‚ùì Chance Card' : 'üéÅ Community Chest', 
                `<p class="text-lg">${actionText}</p>`, 
                [{ text: 'OK', class: 'bg-blue-500', action: () => { hideModal(); if (autoClose) endTurn(); }}]
            );
        }
        
         async function payTax(amount) {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            
            // Bot ise direkt √∂de, modal g√∂sterme
            if (currentPlayer.isBot) {
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                playersCopy[currentPlayerIndex].money -= amount;
                addLog(`ü§ñ ${playersCopy[currentPlayerIndex].name} paid $${amount} in taxes.`);
                await updateGame({ players: playersCopy });
                
                // Check bankruptcy after tax payment
                const isBankrupt = await checkBankruptcy(currentPlayerIndex);
                if (!isBankrupt) {
                    endTurn();
                }
                return;
            }
            
            // Human player i√ßin modal g√∂ster
            showModal(
                'Income Tax',
                `<p>You must pay $${amount} in taxes.</p>`,
                [{ text: `Pay $${amount}`, class: 'bg-red-500', action: async () => {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    playersCopy[currentPlayerIndex].money -= amount;
                    addLog(`${playersCopy[currentPlayerIndex].name} paid $${amount} in taxes.`);
                    await updateGame({ players: playersCopy });
                    hideModal();
                    
                    // Check for bankruptcy after tax payment
                    const isBankrupt = await checkBankruptcy(currentPlayerIndex);
                    if (!isBankrupt) {
                        endTurn();
                    }
                }}]
            );
        }
        
        async function endTurn() {
            // üé≤ End turn yapƒ±ldƒ±ƒüƒ±nda zarlarƒ± gizle
            const animationContainer = document.getElementById('dice-animation-container');
            if (animationContainer) {
                animationContainer.classList.remove('show');
            }
            
            // El elementlerini de temizle
            const hand1 = document.getElementById('dice-hand-1');
            const hand2 = document.getElementById('dice-hand-2');
            if (hand1) {
                hand1.classList.remove('show');
                hand1.style.opacity = '0';
            }
            if (hand2) {
                hand2.classList.remove('show');
                hand2.style.opacity = '0';
            }
            
            // ‚è∞ Aktivite ping g√∂nder
            sendActivityPing();
            
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isDouble = gameData.lastDiceRoll && gameData.lastDiceRoll[0] === gameData.lastDiceRoll[1];
            const doublesCount = currentPlayer.doublesCount || 0;
            
            // üí≥ Kredi kontrol√º yap (tur bitmeden √∂nce)
            await checkCreditPayment(gameData.currentPlayerIndex);
            
            // 3 doubles in a row = go to jail
            if (isDouble && doublesCount >= 3) {
                showModal('‚ö†Ô∏è Too Many Doubles!', 'You rolled doubles 3 times in a row! Go directly to jail!', [
                    {text: 'Secimi kazandin, hapse gir', class: 'bg-red-600', action: () => {
                        hideModal();
                        goToJail();
                    }}
                ]);
                return;
            }
            
            // üé≤ Check for doubles rule - allow another roll
            if (isDouble && doublesCount > 0 && doublesCount < 3 && gameData.settings.allowDoubles) {
                // Allow another roll!
                await updateGame({ 
                    turnState: 'start',
                    gameLog: [...gameData.gameLog, `üé≤ ${currentPlayer.name} rolled DOUBLES! Rolling again...`]
                });
                
                setTimeout(() => {
                    showModal('üé≤ DOUBLES!', `You rolled doubles (${gameData.lastDiceRoll[0]} + ${gameData.lastDiceRoll[1]})! You get to roll again!`, [
                        {text: 'üé≤ OK', class: 'bg-green-600 hover:bg-green-700', action: hideModal}
                    ]);
                }, 500);
                return;
            }
            
            await updateGame({ turnState: 'action_complete' });
        }
        
        async function addLog(message) {
            await updateGame({ gameLog: [...gameData.gameLog, message] });
        }

        function handleJailTurn() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            showModal('In Jail', `<p>You are in jail. What would you like to do?</p>`, [
                { text: 'Roll for Doubles', class: 'bg-blue-500', action: rollForJail },
                { text: 'Pay $50 Fine', class: 'bg-green-500', action: payJailFine, disabled: currentPlayer.money < 50 },
                // { text: 'Use Card', class: 'bg-yellow-500', action: useJailCard, disabled: currentPlayer.getOutOfJailCards < 1 }
            ]);
        }
        
        async function rollForJail() {
            hideModal();
            const die1 = secureRandomInt(1, 6);
            const die2 = secureRandomInt(1, 6);

            if (die1 === die2) {
                addLog(`${gameData.players[gameData.currentPlayerIndex].name} rolled doubles and got out of jail!`);
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                playersCopy[gameData.currentPlayerIndex].inJail = false;
                playersCopy[gameData.currentPlayerIndex].jailTurns = 0;
                await updateGame({ players: playersCopy });
                endTurn(); // Allows normal turn to proceed
            } else {
                addLog(`${gameData.players[gameData.currentPlayerIndex].name} failed to roll doubles.`);
                // In a full game, track jail turns and force payment after 3 turns.
                endTurn(); // Forfeit rest of turn
            }
        }
        
        async function payJailFine() {
            hideModal();
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            playersCopy[gameData.currentPlayerIndex].money -= 50;
            playersCopy[gameData.currentPlayerIndex].inJail = false;
            playersCopy[gameData.currentPlayerIndex].jailTurns = 0;
            addLog(`${playersCopy[gameData.currentPlayerIndex].name} paid $50 to get out of jail.`);
            await updateGame({ players: playersCopy });
            endTurn();
        }

        managePropertiesBtn.addEventListener('click', () => {
             // üîß D√úZELTƒ∞LDƒ∞: Sƒ±radaki oyuncu yerine kendi m√ºlklerini g√∂ster
             const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
             if (!myPlayer) {
                 showModal('Error', 'Oyuncu bulunamadƒ±.', [{text: 'Tamam', class: 'bg-red-500', action: hideModal}]);
                 return;
             }
             
             const ownedProperties = gameData.properties.filter(p => p.ownerId === myPlayer.id);
             
             let modalHTML = '<div class="text-left max-h-96 overflow-y-auto">';
             if (ownedProperties.length === 0) {
                 modalHTML += '<p>You do not own any properties.</p>';
             } else {
                ownedProperties.forEach(prop => {
                    const space = gameData.settings.board[prop.spaceIndex];
                    if (space.type === 'property' || space.type === 'railroad' || space.type === 'utility') {
                       const isProperty = space.type === 'property';
                       const isRailroad = space.type === 'railroad';
                       const isUtility = space.type === 'utility';
                       const hasMonopoly = isProperty ? checkMonopoly(myPlayer.id, space.color) : false;
                       const canBuyHouse = isProperty && hasMonopoly && myPlayer.money >= space.houseCost && prop.houses < 5 && !prop.mortgaged;
                       const canSellHouse = isProperty && prop.houses > 0;
                       const canMortgage = !prop.mortgaged && (isRailroad || isUtility || prop.houses === 0);
                       const canUnmortgage = prop.mortgaged && myPlayer.money >= space.price;
                       
                       const mortgageValue = space.price;
                       const houseSellPrice = isProperty ? Math.floor(space.houseCost * 0.75) : 0;
                       
                       modalHTML += `
                         <div class="p-3 border-b ${hasMonopoly ? 'bg-green-50' : 'bg-gray-50'} ${prop.mortgaged ? 'opacity-60 bg-red-50' : ''}">
                            <div class="mb-2">
                               <p class="font-bold" style="color:${space.color || '#000000'}">${space.name} ${prop.mortgaged ? 'üîí MORTGAGED' : ''} ${isRailroad ? 'üöÇ' : ''} ${isUtility ? '‚ö°' : ''}</p>
                               <p class="text-sm">${isProperty ? 'Houses: ' + (prop.houses < 5 ? prop.houses : 'üè® Hotel') + ' | ' : ''}Value: $${space.price}</p>
                               ${!isProperty && isRailroad ? '<p class="text-xs text-blue-500">üöÇ Railroad</p>' : ''}
                               ${isUtility ? '<p class="text-xs text-purple-500">‚ö° Utility</p>' : ''}
                               ${isProperty && !hasMonopoly ? '<p class="text-xs text-red-500">‚ö†Ô∏è Need all ' + space.color + ' properties</p>' : ''}
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                ${isProperty ? `
                                <!-- Buy House/Hotel -->
                                <button onclick="event.stopPropagation(); window.buyHouse(${prop.spaceIndex})" 
                                    class="text-xs px-3 py-2 rounded ${canBuyHouse ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 cursor-not-allowed'} text-white" 
                                    ${!canBuyHouse ? 'disabled' : ''}>
                                    üè† Buy ${prop.houses === 4 ? 'Hotel' : 'House'} ($${space.houseCost})
                                </button>
                                
                                <!-- Sell House -->
                                ${canSellHouse ? `
                                    <button onclick="event.stopPropagation(); window.sellHouse(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-orange-500 hover:bg-orange-600 text-white">
                                        üî® Sell ${prop.houses === 5 ? 'Hotel' : 'House'} ($${houseSellPrice})
                                    </button>
                                ` : ''}
                                ` : ''}
                                
                                <!-- Mortgage -->
                                ${canMortgage ? `
                                    <button onclick="event.stopPropagation(); window.mortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-red-500 hover:bg-red-600 text-white">
                                        üîí Mortgage ($${mortgageValue})
                                    </button>
                                ` : ''}
                                
                                <!-- Unmortgage -->
                                ${canUnmortgage ? `
                                    <button onclick="event.stopPropagation(); window.unmortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">
                                        üîì Unmortgage ($${mortgageValue})
                                    </button>
                                ` : prop.mortgaged ? `
                                    <span class="text-xs text-gray-500">Need $${mortgageValue} to unmortgage</span>
                                ` : ''}
                            </div>
                         </div>`;
                    }
                });
             }
             modalHTML += '</div>';

             showModal('üè† Manage Properties', modalHTML, [{text: 'Close', class: 'bg-gray-500', action: hideModal}]);
        });
        
        // üìä View All Trades - T√ºm tradeleri g√∂r (kendi gizli tradelerini de)
        // üÉè Joker Cards - Joker kartlarƒ±nƒ± g√∂ster ve kullan
        jokerCardsBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click from bubbling to modal
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer || !myPlayer.jokerCards) {
                showModal('üÉè Joker Cards', '<p class="text-gray-600">You don\'t have any joker cards.</p>', [
                    {text: 'Close', class: 'bg-gray-500', action: hideModal}
                ]);
                return;
            }
            
            const jokers = myPlayer.jokerCards;
            let modalHTML = `
                <div class="text-left space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Use your joker cards strategically to gain an advantage!</p>
                    
                    <!-- Kart √áalma Joker'i -->
                    <div class="border border-purple-300 rounded-lg p-4 bg-purple-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">üíé Steal Property</span>
                            <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">${jokers.steal || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Pay 3x the property's price to steal it from another player. The money goes to them.</p>
                        <button onclick="window.useJokerSteal()" ${jokers.steal > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.steal > 0 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.steal > 0 ? 'Use Steal Card' : 'No Cards Left'}
                        </button>
                    </div>
                    
                    <!-- Tur Atlama Joker'i -->
                    <div class="border border-red-300 rounded-lg p-4 bg-red-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">‚è≠Ô∏è Skip Player's Turn</span>
                            <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${jokers.skip || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Make another player skip their next turn.</p>
                        <button onclick="window.useJokerSkip()" ${jokers.skip > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.skip > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.skip > 0 ? 'Use Skip Card' : 'No Cards Left'}
                        </button>
                    </div>
                    
                    <!-- Zar Tekrar Atma Joker'i -->
                    <div class="border border-blue-300 rounded-lg p-4 bg-blue-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">üé≤ Reroll Dice</span>
                            <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${jokers.reroll || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Reroll your dice if you don't like the result. Use immediately after rolling.</p>
                        <button onclick="window.useJokerReroll()" ${jokers.reroll > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.reroll > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.reroll > 0 ? 'Use Reroll Card' : 'No Cards Left'}
                        </button>
                    </div>
                </div>
            `;
            
            showModal('üÉè Your Joker Cards', modalHTML, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        });
        
        // Check if player owns all properties of a color (monopoly)
        function checkMonopoly(playerId, color) {
            const colorProperties = gameData.settings.board
                .map((space, idx) => ({ ...space, idx }))
                .filter(space => space.type === 'property' && space.color === color);
            
            const ownedByPlayer = colorProperties.filter(space => {
                const prop = gameData.properties[space.idx];
                return prop && prop.ownerId === playerId;
            });
            
            return colorProperties.length === ownedByPlayer.length;
        }
        
        window.buyHouse = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            
            // Double check monopoly
            if (!checkMonopoly(currentPlayer.id, space.color)) {
                alert('You must own all properties of this color to build!');
                return;
            }
            
            if (currentPlayer.money < space.houseCost) {
                alert('Not enough money!');
                return;
            }
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].houses++;
            playersCopy[currentPlayerIndex].money -= space.houseCost;
            
            const buildingType = propertiesCopy[spaceIndex].houses === 5 ? 'hotel' : 'house';
            
            // √ñnce gameData'yƒ± lokal olarak g√ºncelle (anƒ±nda g√∂r√ºn√ºr olsun)
            gameData.properties = propertiesCopy;
            gameData.players = playersCopy;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} built a ${buildingType} on ${space.name}.`);
            
            // Modal i√ßeriƒüini g√ºncelle (modal a√ßƒ±k kalacak)
            setTimeout(() => {
                refreshManagePropertiesModal();
            }, 50);
        }
        
        // üî® Sell House/Hotel
        window.sellHouse = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (property.houses === 0) {
                alert('No houses to sell!');
                return;
            }
            
            const sellPrice = Math.floor(space.houseCost * 0.75); // 3/4 of buy price
            const buildingType = property.houses === 5 ? 'hotel' : 'house';
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].houses--;
            playersCopy[currentPlayerIndex].money += sellPrice;
            
            // √ñnce gameData'yƒ± lokal olarak g√ºncelle (anƒ±nda g√∂r√ºn√ºr olsun)
            gameData.properties = propertiesCopy;
            gameData.players = playersCopy;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} sold a ${buildingType} on ${space.name} for $${sellPrice}.`);
            
            // Modal i√ßeriƒüini g√ºncelle (modal a√ßƒ±k kalacak)
            setTimeout(() => {
                refreshManagePropertiesModal();
            }, 50);
        }
        
        // üîí Mortgage Property
        window.mortgageProperty = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            // Only check houses for property types, not railroads
            if (space.type === 'property' && property.houses > 0) {
                alert('You must sell all houses before mortgaging!');
                return;
            }
            
            if (property.mortgaged) {
                alert('This property is already mortgaged!');
                return;
            }
            
            const mortgageValue = space.price; // Full purchase price
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].mortgaged = true;
            playersCopy[currentPlayerIndex].money += mortgageValue;
            
            // √ñnce gameData'yƒ± lokal olarak g√ºncelle (anƒ±nda g√∂r√ºn√ºr olsun)
            gameData.properties = propertiesCopy;
            gameData.players = playersCopy;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} mortgaged ${space.name} for $${mortgageValue}.`);
            
            // Modal i√ßeriƒüini g√ºncelle (modal a√ßƒ±k kalacak)
            setTimeout(() => {
                refreshManagePropertiesModal();
            }, 50);
        }
        
        // üîì Unmortgage Property
        window.unmortgageProperty = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (!property.mortgaged) {
                alert('This property is not mortgaged!');
                return;
            }
            
            const unmortgageValue = space.price; // Full purchase price
            
            if (currentPlayer.money < unmortgageValue) {
                alert(`Not enough money! You need $${unmortgageValue}.`);
                return;
            }
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].mortgaged = false;
            playersCopy[currentPlayerIndex].money -= unmortgageValue;
            
            // √ñnce gameData'yƒ± lokal olarak g√ºncelle (anƒ±nda g√∂r√ºn√ºr olsun)
            gameData.properties = propertiesCopy;
            gameData.players = playersCopy;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} unmortgaged ${space.name} for $${unmortgageValue}.`);
            
            // Modal i√ßeriƒüini g√ºncelle (modal a√ßƒ±k kalacak)
            setTimeout(() => {
                refreshManagePropertiesModal();
            }, 50);
        }
        
        // üîÑ Manage Properties modal i√ßeriƒüini yenile
        function refreshManagePropertiesModal() {
            // Eƒüer modal a√ßƒ±k deƒüilse veya "Manage Properties" modal'ƒ± deƒüilse, hi√ßbir ≈üey yapma
            if (modal.classList.contains('hidden') || !modalTitle.textContent.includes('Manage Properties')) {
                return;
            }
            
            // Modal a√ßƒ±k ve Manage Properties modal'ƒ± ise i√ßeriƒüini g√ºncelle
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer) return;
            
            const ownedProperties = gameData.properties.filter(p => {
                if (p.ownerId === myPlayer.id) return true;
                if (p.owners && p.owners[myPlayer.id] > 0) return true;
                return false;
            });
            
            let modalHTML = '<div class="text-left max-h-96 overflow-y-auto">';
            if (ownedProperties.length === 0) {
                modalHTML += '<p>You do not own any properties.</p>';
            } else {
                ownedProperties.forEach(prop => {
                    const space = gameData.settings.board[prop.spaceIndex];
                    if (space.type === 'property' || space.type === 'railroad' || space.type === 'utility') {
                       const isProperty = space.type === 'property';
                       const isRailroad = space.type === 'railroad';
                       const isUtility = space.type === 'utility';
                       const hasMonopoly = isProperty ? checkMonopoly(myPlayer.id, space.color) : false;
                       const canBuyHouse = isProperty && hasMonopoly && myPlayer.money >= space.houseCost && prop.houses < 5 && !prop.mortgaged;
                       const canSellHouse = isProperty && prop.houses > 0;
                       const canMortgage = !prop.mortgaged && (isRailroad || isUtility || prop.houses === 0);
                       const canUnmortgage = prop.mortgaged && myPlayer.money >= space.price;
                       
                       const mortgageValue = space.price;
                       const houseSellPrice = isProperty ? Math.floor(space.houseCost * 0.75) : 0;
                       
                       modalHTML += `
                         <div class="p-3 border-b ${hasMonopoly ? 'bg-green-50' : 'bg-gray-50'} ${prop.mortgaged ? 'opacity-60 bg-red-50' : ''}">
                            <div class="mb-2">
                               <p class="font-bold" style="color:${space.color || '#000000'}">${space.name} ${prop.mortgaged ? 'üîí MORTGAGED' : ''} ${isRailroad ? 'üöÇ' : ''} ${isUtility ? '‚ö°' : ''}</p>
                               <p class="text-sm">${isProperty ? 'Houses: ' + (prop.houses < 5 ? prop.houses : 'üè® Hotel') + ' | ' : ''}Value: $${space.price}</p>
                               ${!isProperty && isRailroad ? '<p class="text-xs text-blue-500">üöÇ Railroad</p>' : ''}
                               ${isUtility ? '<p class="text-xs text-purple-500">‚ö° Utility</p>' : ''}
                               ${isProperty && !hasMonopoly ? '<p class="text-xs text-red-500">‚ö†Ô∏è Need all ' + space.color + ' properties</p>' : ''}
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                ${isProperty ? `
                                <!-- Buy House/Hotel -->
                                <button onclick="event.stopPropagation(); window.buyHouse(${prop.spaceIndex})" 
                                    class="text-xs px-3 py-2 rounded ${canBuyHouse ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 cursor-not-allowed'} text-white" 
                                    ${!canBuyHouse ? 'disabled' : ''}>
                                    üè† Buy ${prop.houses === 4 ? 'Hotel' : 'House'} ($${space.houseCost})
                                </button>
                                
                                <!-- Sell House -->
                                ${canSellHouse ? `
                                    <button onclick="event.stopPropagation(); window.sellHouse(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-orange-500 hover:bg-orange-600 text-white">
                                        üî® Sell ${prop.houses === 5 ? 'Hotel' : 'House'} ($${houseSellPrice})
                                    </button>
                                ` : ''}
                                ` : ''}
                                
                                <!-- Mortgage -->
                                ${canMortgage ? `
                                    <button onclick="event.stopPropagation(); window.mortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-red-500 hover:bg-red-600 text-white">
                                        üîí Mortgage ($${mortgageValue})
                                    </button>
                                ` : ''}
                                
                                <!-- Unmortgage -->
                                ${canUnmortgage ? `
                                    <button onclick="event.stopPropagation(); window.unmortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">
                                        üîì Unmortgage ($${mortgageValue})
                                    </button>
                                ` : prop.mortgaged ? `
                                    <span class="text-xs text-gray-500">Need $${mortgageValue} to unmortgage</span>
                                ` : ''}
                            </div>
                         </div>`;
                    }
                });
            }
            modalHTML += '</div>';
            
            // Modal i√ßeriƒüini g√ºncelle (butonlarƒ± koru)
            modalBody.innerHTML = modalHTML;
        }

        // --- JOKER CARD FUNCTIONS ---
        // üíé Kart √áalma Joker'i
        window.useJokerSteal = () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.steal <= 0) {
                alert('You don\'t have any steal cards left!');
                return;
            }
            // Instead of closing the modal, re-render the joker modal after use
            // Diƒüer oyuncularƒ±n sahip olduƒüu kartlarƒ± g√∂ster
            const otherPlayers = gameData.players.filter(p => p.id !== localPlayer.id && !p.bankrupt);
            let modalHTML = `
                <div class="text-left space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-sm text-gray-600 mb-3">Select a player and then select a property to steal. You'll pay 3x its price to that player.</p>
            `;
            otherPlayers.forEach(player => {
                const playerProperties = gameData.properties.filter(p => p.ownerId === player.id && !p.mortgaged);
                if (playerProperties.length > 0) {
                    modalHTML += `<div class="border rounded-lg p-3 bg-gray-50">
                        <h4 class="font-bold mb-2">${player.name}'s Properties:</h4>`;
                    playerProperties.forEach(prop => {
                        const space = gameData.settings.board[prop.spaceIndex];
                        const stealCost = space.price * 3;
                        const canAfford = myPlayer.money >= stealCost;
                        modalHTML += `
                            <button onclick=\"window.executeJokerSteal('${player.id}', ${prop.spaceIndex}, ${stealCost})\" 
                                ${canAfford ? '' : 'disabled'}
                                class=\"w-full text-left px-3 py-2 mb-2 rounded ${canAfford ? 'bg-purple-100 hover:bg-purple-200' : 'bg-gray-200'} border border-purple-300\">
                                <div class=\"font-semibold\">${space.name}</div>
                                <div class=\"text-xs text-gray-600\">Cost: $${stealCost} ${!canAfford ? '(Can\'t afford)' : ''}</div>
                            </button>
                        `;
                    });
                    modalHTML += `</div>`;
                }
            });
            modalHTML += `</div>`;
            showModal('üíé Steal Property', modalHTML, [
                {text: 'Back to Jokers', class: 'bg-gray-500', action: showJokerModal},
                {text: 'Cancel', class: 'bg-gray-400', action: hideModal}
            ], true);
        };
        
        window.executeJokerSteal = async (targetPlayerId, spaceIndex, cost) => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const targetPlayer = gameData.players.find(p => p.id === targetPlayerId);
            const space = gameData.settings.board[spaceIndex];
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const targetIndex = playersCopy.findIndex(p => p.id === targetPlayerId);
            
            // Para transferi
            playersCopy[myIndex].money -= cost;
            playersCopy[targetIndex].money += cost;
            
            // Kart √ßalma joker'ini azalt
            playersCopy[myIndex].jokerCards.steal -= 1;
            
            // M√ºlkiyet transferi - HEM ownerId HEM de owners'ƒ± g√ºncelle
            propertiesCopy[spaceIndex].ownerId = localPlayer.id;
            
            // Hisse sistemini g√ºncelle - %100 yeni sahibin olsun
            propertiesCopy[spaceIndex].owners = {
                [localPlayer.id]: 100
            };
            
            // Evleri sƒ±fƒ±rla (√ßalƒ±nan m√ºlkte ev kalmaz)
            propertiesCopy[spaceIndex].houses = 0;
            
            await updateGame({ 
                players: playersCopy, 
                properties: propertiesCopy,
                gameLog: [...gameData.gameLog, `üíé ${myPlayer.name} used a Steal Card to take ${space.name} from ${targetPlayer.name} for $${cost}!`]
            });
            
            playSound('purchase');
            showModal('üíé Property Stolen!', `You successfully stole ${space.name} from ${targetPlayer.name} for $${cost}!`, [
                {text: 'OK', class: 'bg-purple-500', action: showJokerModal},
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ], true);
        };
        
        // ‚è≠Ô∏è Tur Atlama Joker'i
        window.useJokerSkip = () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.skip <= 0) {
                alert('You don\'t have any skip cards left!');
                return;
            }
            
            // Diƒüer oyuncularƒ± g√∂ster
            const otherPlayers = gameData.players.filter(p => p.id !== localPlayer.id && !p.bankrupt);
            let modalHTML = `
                <div class="text-left space-y-2">
                    <p class="text-sm text-gray-600 mb-3">Select a player to skip their next turn:</p>
            `;
            otherPlayers.forEach(player => {
                modalHTML += `
                    <button onclick=\"window.executeJokerSkip('${player.id}')\" 
                        class=\"w-full text-left px-4 py-3 rounded bg-red-100 hover:bg-red-200 border border-red-300\">
                        <div class=\"font-semibold\">${player.name}</div>
                        <div class=\"text-xs text-gray-600\">They will miss their next turn</div>
                    </button>
                `;
            });
            modalHTML += `</div>`;
            showModal('‚è≠Ô∏è Skip Player Turn', modalHTML, [
                {text: 'Back to Jokers', class: 'bg-gray-500', action: showJokerModal},
                {text: 'Cancel', class: 'bg-gray-400', action: hideModal}
            ], true);
        };
        
        window.executeJokerSkip = async (targetPlayerId) => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const targetPlayer = gameData.players.find(p => p.id === targetPlayerId);
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const targetIndex = playersCopy.findIndex(p => p.id === targetPlayerId);
            
            // Skip joker'ini azalt
            playersCopy[myIndex].jokerCards.skip -= 1;
            
            // Hedef oyuncuya "skip" flag'i ekle
            playersCopy[targetIndex].skipNextTurn = true;
            
            await updateGame({ 
                players: playersCopy,
                gameLog: [...gameData.gameLog, `‚è≠Ô∏è ${myPlayer.name} used a Skip Card on ${targetPlayer.name}! They will miss their next turn!`]
            });
            
            showModal('‚è≠Ô∏è Turn Skipped!', `${targetPlayer.name} will miss their next turn!`, [
                {text: 'OK', class: 'bg-red-500', action: showJokerModal},
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ], true);
        };
        
        // üé≤ Zar Tekrar Atma Joker'i
        window.useJokerReroll = async () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.reroll <= 0) {
                alert('You don\'t have any reroll cards left!');
                return;
            }
            
            // Zar hen√ºz atƒ±lmadƒ±ysa uyar
            if (gameData.turnState !== 'action' && gameData.turnState !== 'action_complete') {
                alert('You can only use this card after rolling the dice!');
                return;
            }
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            
            // Reroll joker'ini azalt
            playersCopy[myIndex].jokerCards.reroll -= 1;
            
            // Yeni zar deƒüerleri - Geli≈ümi≈ü zar sistemi kullan
            const diceResult = rollDiceImproved(playersCopy[myIndex].position);
            const dice1 = diceResult.die1;
            const dice2 = diceResult.die2;
            const total = diceResult.total;
            
            // Eski pozisyondan √ßƒ±k, yeni pozisyona git
            const oldPos = playersCopy[myIndex].position;
            let newPos = (oldPos + total) % gameData.settings.board.length;
            
            // üìä Kare ziyaret istatistiklerini g√ºncelle
            if (!gameData.spaceVisits) {
                gameData.spaceVisits = new Array(gameData.settings.board.length).fill(0);
            }
            gameData.spaceVisits[newPos] = (gameData.spaceVisits[newPos] || 0) + 1;
            
            // Check if passed GO
            if (newPos < oldPos) {
                playersCopy[myIndex].money += gameData.settings.passGoBonus;
                await updateGame({ 
                    players: playersCopy,
                    spaceVisits: gameData.spaceVisits,
                    gameLog: [...gameData.gameLog, `üí∞ ${myPlayer.name} passed GO! +$${gameData.settings.passGoBonus}`]
                });
            }
            
            // üé¨ Joker reroll i√ßin karakter animasyonu
            await animatePlayerMovement(myPlayer.id, oldPos, newPos, total);
            
            // Final pozisyonu ayarla
            playersCopy[myIndex].position = newPos;
            
            await updateGame({ 
                players: playersCopy,
                dice: { dice1, dice2 },
                lastDiceRoll: [dice1, dice2],
                spaceVisits: gameData.spaceVisits,
                turnState: 'action',
                gameLog: [...gameData.gameLog, `üé≤ ${myPlayer.name} used a Reroll Card! New roll: ${dice1} + ${dice2} = ${total}`]
            });
            
            playSound('dice');
            hideModal();
            
            // Handle landing on new position
            setTimeout(() => {
            handleLanding(newPos);
            }, 300);
        };
        
        // Helper to re-show the joker modal with updated counts
        function showJokerModal() {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer || !myPlayer.jokerCards) {
                showModal('üÉè Joker Cards', '<p class="text-gray-600">You don\'t have any joker cards.</p>', [
                    {text: 'Close', class: 'bg-gray-500', action: hideModal}
                ]);
                return;
            }
            const jokers = myPlayer.jokerCards;
            let modalHTML = `
                <div class="text-left space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Use your joker cards strategically to gain an advantage!</p>
                    <!-- Kart √áalma Joker'i -->
                    <div class="border border-purple-300 rounded-lg p-4 bg-purple-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">üíé Steal Property</span>
                            <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">${jokers.steal || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Pay 3x the property's price to steal it from another player. The money goes to them.</p>
                        <button onclick=\"window.useJokerSteal()\" ${jokers.steal > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.steal > 0 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.steal > 0 ? 'Use Steal Card' : 'No Cards Left'}
                        </button>
                    </div>
                    <!-- Tur Atlama Joker'i -->
                    <div class="border border-red-300 rounded-lg p-4 bg-red-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">‚è≠Ô∏è Skip Player's Turn</span>
                            <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${jokers.skip || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Make another player skip their next turn.</p>
                        <button onclick=\"window.useJokerSkip()\" ${jokers.skip > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.skip > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.skip > 0 ? 'Use Skip Card' : 'No Cards Left'}
                        </button>
                    </div>
                    <!-- Zar Tekrar Atma Joker'i -->
                    <div class="border border-blue-300 rounded-lg p-4 bg-blue-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">üé≤ Reroll Dice</span>
                            <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${jokers.reroll || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Reroll your dice if you don't like the result. Use immediately after rolling.</p>
                        <button onclick=\"window.useJokerReroll()\" ${jokers.reroll > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.reroll > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.reroll > 0 ? 'Use Reroll Card' : 'No Cards Left'}
                        </button>
                    </div>
                </div>
            `;
            showModal('üÉè Your Joker Cards', modalHTML, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }

        // --- TRADE LOGIC ---
        // ü§ù Enhanced Trade System with Counter Offers and Pending Trades
        window.showTradeModal = (targetPlayerId) => {
            const me = gameData.players.find(p => p.id === localPlayer.id);
            const them = gameData.players.find(p => p.id === targetPlayerId);

            const myProperties = gameData.properties.filter(p => p.ownerId === me.id);
            const theirProperties = gameData.properties.filter(p => p.ownerId === them.id);

            let body = `
                <div id="trade-interface" class="grid grid-cols-2 gap-4 text-left">
                    <!-- My Offer -->
                    <div class="border-r pr-3">
                        <h4 class="font-bold text-center mb-3 text-blue-700">üíº Your Offer</h4>
                        <label class="block mb-2">
                            <span class="text-sm font-medium">Money:</span>
                            <input id="trade-my-money" type="number" min="0" max="${me.money}" value="0" class="w-full border-2 p-2 rounded-lg mt-1">
                            <span class="text-xs text-gray-500">Available: $${me.money}</span>
                        </label>
                        <div class="mt-2">
                            <p class="font-medium text-sm mb-2">Properties:</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto">
                                ${myProperties.map(p => {
                                    const space = gameData.settings.board[p.spaceIndex];
                                    return `
                                        <label class="flex items-center gap-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                                            <input type="checkbox" class="my-prop-checkbox" value="${p.spaceIndex}">
                                            <span class="text-sm">${space.name}</span>
                                            <span class="text-xs text-gray-500 ml-auto">$${space.price}</span>
                                        </label>
                                    `;
                                }).join('') || '<p class="text-sm text-gray-500 italic">No properties owned</p>'}
                            </div>
                        </div>
                    </div>
                    <!-- Their Offer -->
                    <div class="pl-3">
                        <h4 class="font-bold text-center mb-3 text-green-700">üéÅ Request From Them</h4>
                        <label class="block mb-2">
                            <span class="text-sm font-medium">Money:</span>
                            <input id="trade-their-money" type="number" min="0" max="${them.money}" value="0" class="w-full border-2 p-2 rounded-lg mt-1">
                            <span class="text-xs text-gray-500">They have: $${them.money}</span>
                        </label>
                        <div class="mt-2">
                            <p class="font-medium text-sm mb-2">Properties:</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto">
                                ${theirProperties.map(p => {
                                    const space = gameData.settings.board[p.spaceIndex];
                                    return `
                                        <label class="flex items-center gap-2 p-2 hover:bg-green-50 rounded cursor-pointer">
                                            <input type="checkbox" class="their-prop-checkbox" value="${p.spaceIndex}">
                                            <span class="text-sm">${space.name}</span>
                                            <span class="text-xs text-gray-500 ml-auto">$${space.price}</span>
                                        </label>
                                    `;
                                }).join('') || '<p class="text-sm text-gray-500 italic">No properties owned</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Gizli Trade Se√ßeneƒüi -->
                <div class="mt-4 p-3 bg-purple-50 border-2 border-purple-300 rounded-lg">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="trade-secret-checkbox" class="w-4 h-4">
                        <span class="font-semibold text-purple-800">üîí Make this a secret trade</span>
                        <span class="text-xs text-purple-600">(${me.secretTradesAvailable || 0} secret trades available)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-2">Secret trades won't be visible to other players. You have ${me.secretTradesAvailable || 0} secret trade credits. Each one used (even if rejected) costs 1 credit.</p>
                </div>
            `;
            
            showModal(`ü§ù Trade with ${them.name}`, body, [
                {text: 'üì§ Send Offer', class: 'bg-blue-600 hover:bg-blue-700', action: () => proposeTrade(targetPlayerId)},
                {text: 'Cancel', class: 'bg-gray-400 hover:bg-gray-500', action: hideModal}
            ]);
        }
        
        async function proposeTrade(targetPlayerId) {
             const offerMoney = parseInt(document.getElementById('trade-my-money').value) || 0;
             const requestMoney = parseInt(document.getElementById('trade-their-money').value) || 0;
             const isSecret = document.getElementById('trade-secret-checkbox')?.checked || false;
             
             const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
             
             // Gizli trade kontrol√º
             if (isSecret && (myPlayer.secretTradesAvailable || 0) <= 0) {
                 showModal('Not Enough Secret Trades', 'You don\'t have any secret trade credits left!', [
                     {text: 'OK', class:'bg-red-500', action: () => window.showTradeModal(targetPlayerId)}
                 ]);
                 return;
             }
             
             let offerProps = [];
             let requestProps = [];
             
             document.querySelectorAll('.my-prop-checkbox:checked').forEach(cb => {
                 offerProps.push(parseInt(cb.value));
             });
             
             document.querySelectorAll('.their-prop-checkbox:checked').forEach(cb => {
                 requestProps.push(parseInt(cb.value));
             });
             
             // Validation
             if (offerMoney === 0 && requestMoney === 0 && offerProps.length === 0 && requestProps.length === 0) {
                 showModal('Invalid Trade', 'You must offer or request something!', [{text: 'OK', class:'bg-red-500', action: () => window.showTradeModal(targetPlayerId)}]);
                 return;
             }
             
             // Gizli trade kullanƒ±ldƒ±ysa, hakkƒ± azalt
             const playersCopy = JSON.parse(JSON.stringify(gameData.players));
             if (isSecret) {
                 const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
                 playersCopy[myIndex].secretTradesAvailable = (playersCopy[myIndex].secretTradesAvailable || 0) - 1;
             }
             
             const tradeOffer = {
                 id: `trade_${Date.now()}`,
                 fromId: localPlayer.id,
                 toId: targetPlayerId,
                 offer: { money: offerMoney, properties: offerProps },
                 request: { money: requestMoney, properties: requestProps },
                 status: 'pending', // pending, accepted, rejected, countered, cancelled
                 timestamp: Date.now(),
                 isSecret: isSecret
             };
             
             // Add to trades array
             const trades = gameData.trades || [];
             trades.push(tradeOffer);
             
             await updateGame({ 
                 trades: trades,
                 players: playersCopy,
                 gameLog: [...(gameData.gameLog || []), `${isSecret ? 'üîí' : 'ü§ù'} ${myPlayer.name} sent a ${isSecret ? 'secret ' : ''}trade offer!`]
             });
             hideModal();
             
             const them = gameData.players.find(p => p.id === targetPlayerId);
             showModal("‚úÖ Trade Sent!", `Your ${isSecret ? 'secret ' : ''}trade offer has been sent to ${them.name}. Waiting for response...`, [
                 {text: 'OK', class:'bg-green-500', action: hideModal}
             ]);
        }

        // ÔøΩ Calculate Total Wealth (money + property value)
        function calculateTotalWealth(player) {
            const properties = gameData.properties
                .map((prop, idx) => ({...prop, spaceIndex: idx}))
                .filter(prop => prop.owners && prop.owners[player.id] > 0);
            
            let totalPropertyValue = 0;
            properties.forEach(prop => {
                const space = gameData.settings.board[prop.spaceIndex];
                if (space.price) {
                    const sharePercentage = prop.owners[player.id] || 0;
                    totalPropertyValue += space.price * (sharePercentage / 100);
                    if (prop.houses > 0 && prop.houses < 5) {
                        totalPropertyValue += prop.houses * (space.houseCost || 50) * (sharePercentage / 100);
                    } else if (prop.houses === 5) {
                        totalPropertyValue += 5 * (space.houseCost || 50) * (sharePercentage / 100);
                    }
                }
            });
            
            return player.money + totalPropertyValue;
        }

        // ÔøΩ KREDƒ∞ Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI
        
        /**
         * Oyuncunun kredi limitini hesaplar
         * Kredi Limit = Œ£ [ (M√ºlk Fiyatƒ± + Bina Sayƒ±sƒ± √ó Bina Maliyeti) / 2 ]
         * Sadece ev veya otel bulunan m√ºlkler i√ßin hesaplanƒ±r
         */
        function calculateCreditLimit(player) {
            let totalLiquidationValue = 0;
            
            // Oyuncunun sahip olduƒüu t√ºm m√ºlkleri kontrol et
            gameData.properties.forEach((property, index) => {
                // M√ºlk bu oyuncuya ait mi?
                const isOwner = property.ownerId === player.id || 
                               (property.owners && property.owners[player.id]);
                
                if (!isOwner || property.houses === 0) return; // Ev/otel yoksa atla
                
                const space = gameData.settings.board[index];
                if (space.type !== 'property') return; // Sadece normal m√ºlkler
                
                // Bina Birimi Sayƒ±sƒ± (1-4 ev veya 5 otel)
                const buildingUnits = property.houses;
                
                // Bina Maliyeti
                const buildingCost = space.houseCost || 0;
                
                // M√ºlk Fiyatƒ±
                const propertyPrice = space.price || 0;
                
                // Likidasyon Deƒüeri = (P + B √ó C) / 2
                const liquidationValue = (propertyPrice + (buildingUnits * buildingCost)) / 2;
                
                totalLiquidationValue += liquidationValue;
            });
            
            return Math.floor(totalLiquidationValue);
        }
        
        /**
         * Kredi alma modalini g√∂sterir
         */
        function showCreditModal() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Sadece kendi turunda ve oyuncu bankrupt deƒüilse
            if (currentPlayer.id !== localPlayer.id) {
                showModal('‚ö†Ô∏è Uyarƒ±', 'Kredi almak i√ßin kendi turunuzu beklemelisiniz.', [
                    {text: 'Tamam', class: 'bg-blue-500', action: hideModal}
                ]);
                return;
            }
            
            if (currentPlayer.isBankrupt) {
                showModal('‚ö†Ô∏è Uyarƒ±', 'ƒ∞flas etmi≈ü oyuncular kredi alamaz.', [
                    {text: 'Tamam', class: 'bg-blue-500', action: hideModal}
                ]);
                return;
            }
            
            // Aktif kredi var mƒ± kontrol et
            if (currentPlayer.creditAmount > 0) {
                const turnsLeft = currentPlayer.creditTurnsLeft || 0;
                showModal('‚ö†Ô∏è Aktif Krediniz Var', 
                    `<div class="text-left">
                        <p class="mb-2">Halihazƒ±rda <strong class="text-red-600">$${currentPlayer.creditAmount}</strong> krediniz var.</p>
                        <p class="mb-2">Kalan geri √∂deme s√ºresi: <strong>${turnsLeft}</strong> tur</p>
                        <p class="text-sm text-gray-600">Mevcut kredinizi geri √∂demeden yeni kredi alamazsƒ±nƒ±z.</p>
                    </div>`, 
                    [
                        {text: 'Tamam', class: 'bg-blue-500', action: hideModal},
                        {text: 'üí∞ ≈ûimdi √ñde', class: 'bg-green-500', action: () => {
                            hideModal();
                            payCreditNow(currentPlayer);
                        }}
                    ]
                );
                return;
            }
            
            // Kredi limitini hesapla
            const creditLimit = calculateCreditLimit(currentPlayer);
            
            if (creditLimit === 0) {
                showModal('‚ùå Kredi Alamazsƒ±nƒ±z', 
                    `<div class="text-left">
                        <p class="mb-2">Kredi alabilmek i√ßin en az bir m√ºlk√ºn√ºzde <strong>ev veya otel</strong> olmalƒ±dƒ±r.</p>
                        <p class="text-sm text-gray-600">üí° ƒ∞pucu: Monopol olu≈üturup ev/otel satƒ±n alarak kredi limitinizi artƒ±rabilirsiniz.</p>
                    </div>`, 
                    [{text: 'Tamam', class: 'bg-blue-500', action: hideModal}]
                );
                return;
            }
            
            // Kredi alma formu g√∂ster
            const modalContent = `
                <div class="text-left space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Kredi Limitiniz</p>
                        <p class="text-3xl font-bold text-green-600">$${creditLimit}</p>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded">
                        <p class="text-sm font-semibold mb-2">üìã Kredi Ko≈üullarƒ±:</p>
                        <ul class="text-sm space-y-1 list-disc ml-5">
                            <li>Geri √∂deme s√ºresi: <strong>5 tur</strong></li>
                            <li>√ñdeyemezseniz: <strong>ƒ∞flas edersiniz</strong></li>
                            <li>T√ºm m√ºlkleriniz bankaya ge√ßer</li>
                        </ul>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">√áekmek istediƒüiniz tutar:</label>
                        <input type="number" id="creditAmountInput" 
                               class="w-full px-4 py-2 border rounded-lg" 
                               min="1" max="${creditLimit}" value="${creditLimit}"
                               placeholder="Miktar girin">
                    </div>
                    
                    <p class="text-xs text-gray-500">
                        üí° Kredi limitiniz, m√ºlklerinizin ve binalarƒ±n likidasyon deƒüerine g√∂re hesaplanmƒ±≈ütƒ±r.
                    </p>
                </div>
            `;
            
            showModal('üí≥ Kredi Al', modalContent, [
                {text: 'ƒ∞ptal', class: 'bg-gray-500', action: hideModal},
                {text: '‚úÖ Kredi √áek', class: 'bg-green-600', action: () => {
                    const amount = parseInt(document.getElementById('creditAmountInput').value);
                    if (isNaN(amount) || amount <= 0) {
                        alert('L√ºtfen ge√ßerli bir miktar girin!');
                        return;
                    }
                    if (amount > creditLimit) {
                        alert(`Maksimum kredi limitiniz $${creditLimit}'dir!`);
                        return;
                    }
                    hideModal();
                    takeCredit(amount);
                }}
            ]);
        }
        
        /**
         * Kredi √ßeker
         */
        async function takeCredit(amount) {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const player = playersCopy[currentPlayerIndex];
            
            // Kredi ver
            player.money += amount;
            player.creditAmount = amount;
            player.creditTurnsLeft = 5;
            
            if (!player.creditHistory) player.creditHistory = [];
            player.creditHistory.push({
                amount: amount,
                turn: gameData.turnCount || 0,
                action: 'taken'
            });
            
            addLog(`üí≥ ${player.name} $${amount} kredi √ßekti! (5 tur i√ßinde geri √∂deme gerekli)`);
            
            await updateGame({ players: playersCopy });
            
            showModal('‚úÖ Kredi Onaylandƒ±', 
                `<div class="text-center">
                    <p class="text-2xl mb-4">üí∞</p>
                    <p class="mb-2"><strong>$${amount}</strong> krediniz hesabƒ±nƒ±za yatƒ±rƒ±ldƒ±!</p>
                    <p class="text-sm text-orange-600">‚è∞ 5 tur i√ßinde geri √∂demeyi unutmayƒ±n!</p>
                </div>`, 
                [{text: 'Tamam', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        /**
         * Krediyi ≈üimdi √∂der
         */
        async function payCreditNow(player) {
            const playerIndex = gameData.players.findIndex(p => p.id === player.id);
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const currentPlayer = playersCopy[playerIndex];
            
            if (currentPlayer.money < currentPlayer.creditAmount) {
                showModal('‚ùå Yetersiz Bakiye', 
                    `<p>Kredi tutarƒ±: <strong>$${currentPlayer.creditAmount}</strong></p>
                     <p>Mevcut paranƒ±z: <strong>$${currentPlayer.money}</strong></p>
                     <p class="text-red-600 mt-2">√ñdeme i√ßin yeterli paranƒ±z yok!</p>`, 
                    [{text: 'Tamam', class: 'bg-blue-500', action: hideModal}]
                );
                return;
            }
            
            // Krediyi √∂de
            currentPlayer.money -= currentPlayer.creditAmount;
            const paidAmount = currentPlayer.creditAmount;
            currentPlayer.creditAmount = 0;
            currentPlayer.creditTurnsLeft = 0;
            
            if (!currentPlayer.creditHistory) currentPlayer.creditHistory = [];
            currentPlayer.creditHistory.push({
                amount: paidAmount,
                turn: gameData.turnCount || 0,
                action: 'paid'
            });
            
            addLog(`‚úÖ ${currentPlayer.name} $${paidAmount} krediyi geri √∂dedi!`);
            
            await updateGame({ players: playersCopy });
            
            showModal('‚úÖ Kredi √ñdendi', 
                `<p class="text-green-600 font-bold">Krediniz ba≈üarƒ±yla √∂dendi!</p>
                 <p class="mt-2">√ñdenen tutar: $${paidAmount}</p>`, 
                [{text: 'Tamam', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        /**
         * Her tur sonunda kredi kontrol√º yapar
         */
        async function checkCreditPayment(playerIndex) {
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const player = playersCopy[playerIndex];
            
            // Kredi yoksa atla
            if (player.creditAmount <= 0) return;
            
            // Tur sayacƒ±nƒ± azalt
            player.creditTurnsLeft--;
            
            await updateGame({ players: playersCopy });
            
            // Son tur uyarƒ±sƒ±
            if (player.creditTurnsLeft === 1) {
                if (player.id === localPlayer.id) {
                    showModal('‚ö†Ô∏è SON TUR UYARISI!', 
                        `<div class="text-center">
                            <p class="text-4xl mb-4">‚è∞</p>
                            <p class="text-xl font-bold text-red-600 mb-2">SADECE 1 TUR KALDI!</p>
                            <p class="mb-2">Kredi tutarƒ±: <strong>$${player.creditAmount}</strong></p>
                            <p class="text-sm text-gray-600">Bir sonraki turda √∂deme yapmazsanƒ±z iflas edeceksiniz!</p>
                        </div>`, 
                        [{text: 'Anladƒ±m', class: 'bg-red-600', action: hideModal}]
                    );
                }
                addLog(`‚ö†Ô∏è ${player.name} i√ßin son tur! Kredi: $${player.creditAmount}`);
            }
            
            // S√ºre doldu - √ñdeme kontrol√º yap
            if (player.creditTurnsLeft <= 0) {
                // G√ºncel oyuncu bilgisini al (gameData'dan)
                const currentPlayer = gameData.players[playerIndex];
                const creditAmount = currentPlayer.creditAmount || 0;
                const playerMoney = currentPlayer.money || 0;
                
                // Kredi tutarƒ± √ßƒ±karƒ±ldƒ±ƒüƒ±nda para durumu
                const moneyAfterPayment = playerMoney - creditAmount;
                
                // Eƒüer yeterli para varsa, otomatik olarak √∂de
                if (playerMoney >= creditAmount) {
                    // Otomatik √∂deme yap
                    const paidPlayersCopy = JSON.parse(JSON.stringify(gameData.players));
                    const paidPlayer = paidPlayersCopy[playerIndex];
                    
                    paidPlayer.money -= creditAmount;
                    const paidAmount = paidPlayer.creditAmount;
                    paidPlayer.creditAmount = 0;
                    paidPlayer.creditTurnsLeft = 0;
                    
                    if (!paidPlayer.creditHistory) paidPlayer.creditHistory = [];
                    paidPlayer.creditHistory.push({
                        type: 'payment',
                        amount: paidAmount,
                        timestamp: Date.now()
                    });
                    
                    await updateGame({ players: paidPlayersCopy });
                    addLog(`‚úÖ ${paidPlayer.name} krediyi otomatik olarak √∂dedi: $${paidAmount}`);
                    
                    // Eƒüer local player ise bilgi ver
                    if (paidPlayer.id === localPlayer.id) {
                        showModal('‚úÖ Kredi Otomatik √ñdendi', 
                            `<div class="text-center">
                                <p class="text-4xl mb-4">üí≥</p>
                                <p class="text-xl font-bold text-green-600 mb-4">Krediniz otomatik olarak √∂dendi!</p>
                                <p class="mb-2">√ñdenen tutar: <strong>$${paidAmount}</strong></p>
                                <p class="text-sm text-gray-600">Kalan para: $${paidPlayer.money}</p>
                            </div>`, 
                            [{text: 'Tamam', class: 'bg-green-600', action: hideModal}]
                        );
                    }
                } else {
                    // Yeterli para yok - ƒ∞flas et
                    addLog(`üí• ${currentPlayer.name} krediyi √∂deyemedi ve iflas etti! (Para: $${playerMoney}, Kredi: $${creditAmount})`);
                    
                    if (currentPlayer.id === localPlayer.id) {
                    showModal('üí• KREDƒ∞ √ñDENEMEDƒ∞ - ƒ∞FLAS!', 
                        `<div class="text-center">
                            <p class="text-4xl mb-4">üí∏</p>
                                <p class="text-xl font-bold text-red-600 mb-4">Krediyi √∂deyemediniz!</p>
                                <p class="mb-2">Kredi tutarƒ±: <strong>$${creditAmount}</strong></p>
                                <p class="mb-2">Mevcut para: <strong>$${playerMoney}</strong></p>
                                <p class="mb-2 text-red-600">Kredi √ßƒ±karƒ±ldƒ±ƒüƒ±nda para: <strong>$${moneyAfterPayment}</strong> (eksiye d√º≈ü√ºyor!)</p>
                            <p class="text-sm text-gray-600">T√ºm m√ºlkleriniz bankaya devredildi.</p>
                        </div>`, 
                        [{text: 'ƒ∞flas Et', class: 'bg-red-600', action: () => {
                            hideModal();
                            sendMessage({
                                type: 'declare_bankruptcy',
                                playerId: localPlayer.id
                            });
                        }}]
                    );
                } else {
                    // Bot veya diƒüer oyuncular i√ßin otomatik iflas
                    sendMessage({
                        type: 'declare_bankruptcy',
                            playerId: currentPlayer.id
                    });
                    }
                }
            }
        }

        // ÔøΩüö® Check for bankruptcy after money deduction
        async function checkBankruptcy(playerIndex) {
            const player = gameData.players[playerIndex];
            
            // If player has enough money, no bankruptcy check needed
            if (player.money >= 0) return false;
            
            const totalWealth = calculateTotalWealth(player);
            
            // If total wealth is negative, force bankruptcy
            if (totalWealth < 0) {
                if (player.isBot) {
                    // Bots automatically declare bankruptcy
                    addLog(`üí• ${player.name} (BOT) went bankrupt! Total wealth: $${totalWealth.toFixed(0)}`);
                    sendMessage({
                        type: 'declare_bankruptcy',
                        playerId: player.id
                    });
                    return true;
                } else if (player.id === localPlayer.id) {
                    // Human player forced to bankruptcy
                    showModal(
                        'üí• Bankruptcy!',
                        `<p class="text-red-600 font-bold">Your total wealth is negative: $${totalWealth.toFixed(0)}</p>
                         <p class="mt-2">You cannot continue playing. You must declare bankruptcy.</p>`,
                        [{text: 'Declare Bankruptcy', class: 'bg-red-600', action: () => {
                            sendMessage({
                                type: 'declare_bankruptcy',
                                playerId: localPlayer.id
                            });
                            localStorage.removeItem('monopolyCurrentGameId');
                            localStorage.removeItem('monopolyPlayerId');
                            hideModal();
                        }}]
                    );
                    return true;
                }
            }
            
            // ü§ñ Bot i√ßin otomatik ipotek/satƒ±≈ü kararƒ±
            if (player.isBot && player.money < 0 && totalWealth >= 0) {
                // Botun para sƒ±kƒ±ntƒ±sƒ± var ama toplam serveti pozitif
                const actionTaken = await botDecideMortgageOrSell(playerIndex);
                if (actionTaken) {
                    // Eƒüer i≈ülem yapƒ±ldƒ±ysa, tekrar kontrol et
                    await new Promise(resolve => setTimeout(resolve, 500)); // Kƒ±sa bir bekleme
                    return await checkBankruptcy(playerIndex); // Tekrar kontrol et
                }
            }
            
            // If money is negative but total wealth is positive, offer options
            if (player.id === localPlayer.id && player.money < 0) {
                showModal(
                    '‚ö†Ô∏è Negative Cash!',
                    `<p class="text-orange-600 font-bold">Your cash is negative: $${player.money}</p>
                     <p>Total wealth: $${totalWealth.toFixed(0)}</p>
                     <p class="mt-2">You can sell/mortgage properties or declare bankruptcy.</p>`,
                    [
                        {text: 'Manage Properties', class: 'bg-blue-500', action: () => {
                            hideModal();
                            // TODO: Open property management
                        }},
                        {text: 'Declare Bankruptcy', class: 'bg-red-600', action: () => {
                            hideModal();
                            window.declareBankruptcy();
                        }}
                    ]
                );
            }
            
            return false;
        }

        // ÔøΩüí• Declare Bankruptcy
        window.declareBankruptcy = () => {
            showModal('üí• ƒ∞flas Et', 'ƒ∞flas etmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz ve oyun dƒ±≈üƒ± kalacaksƒ±nƒ±z.', [
                {text: 'ƒ∞ptal', class: 'bg-gray-500', action: hideModal},
                {text: 'Evet, ƒ∞flas Et', class: 'bg-red-600', action: () => {
                    sendMessage({
                        type: 'declare_bankruptcy',
                        playerId: localPlayer.id
                    });
                    // Clear session when bankrupt
                    localStorage.removeItem('monopolyCurrentGameId');
                    localStorage.removeItem('monopolyPlayerId');
                    hideModal();
                }}
            ]);
        }

        // üì¨ Show Pending Trades Notification
        function checkPendingTrades() {
            if (!gameData || !gameData.trades) return;
            
            // First, handle bot trades automatically
            const botTrades = gameData.trades.filter(t => {
                if (!t || !t.id || t.status !== 'pending') return false;
                const toPlayer = gameData.players.find(p => p.id === t.toId);
                return toPlayer && toPlayer.isBot;
            });
            
            // Process bot trades automatically
            botTrades.forEach(trade => {
                const toPlayer = gameData.players.find(p => p.id === trade.toId);
                if (toPlayer && toPlayer.isBot && !shownTradeIds.has(trade.id)) {
                    shownTradeIds.add(trade.id);
                    console.log(`ü§ñ Bot ${toPlayer.name} received trade offer, processing...`);
                    botDecideTrade(trade);
                }
            });
            
            // Check for trades where I'm the receiver
            const incomingTrades = gameData.trades.filter(t => 
                t && t.id && t.toId === localPlayer.id && t.status === 'pending' && 
                !decidedLaterTrades.includes(t.id)
            );
            
            // Check for my outgoing trades
            const outgoingTrades = gameData.trades.filter(t => 
                t && t.id && t.fromId === localPlayer.id && t.status === 'pending'
            );
            
            if (incomingTrades.length > 0) {
                // Show notification badge or auto-show latest trade
                const latestTrade = incomingTrades[incomingTrades.length - 1];
                
                // Verify trade has all required fields before showing modal
                if (latestTrade && latestTrade.id && latestTrade.fromId && latestTrade.toId) {
                    showIncomingTradeModal(latestTrade);
                }
            }
        }

        // üì® Show Incoming Trade Modal
        function showIncomingTradeModal(trade) {
            if (!trade || !trade.id || !trade.fromId || !trade.toId) {
                return;
            }
            
            const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
            const me = gameData.players.find(p => p.id === localPlayer.id);
            
            if (!fromPlayer || !me) {
                return;
            }
            
            // If recipient is a bot, auto-decide on trade
            if (me.isBot) {
                botDecideTrade(trade);
                return;
            }
            
            const getPropertyNames = (indices) => {
                if (!indices || indices.length === 0) return '<span class="text-gray-500 italic">Nothing</span>';
                return indices.map(i => {
                    const space = gameData.settings.board[i];
                    return `<div class="text-sm">‚Ä¢ ${space.name} ($${space.price})</div>`;
                }).join('');
            };

            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">üì§ ${fromPlayer.name} Offers You:</h4>
                        <div class="ml-2">
                            ${trade.offer.money > 0 ? `<div class="font-semibold text-green-700">üí∞ $${trade.offer.money}</div>` : ''}
                            ${getPropertyNames(trade.offer.properties)}
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-bold text-green-800 mb-2">üì• In Exchange For:</h4>
                        <div class="ml-2">
                            ${trade.request.money > 0 ? `<div class="font-semibold text-red-700">üí∏ $${trade.request.money}</div>` : ''}
                            ${getPropertyNames(trade.request.properties)}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`ü§ù Trade Offer from ${fromPlayer.name}`, body, [
                {text: '‚úÖ Accept', class: 'bg-green-600 hover:bg-green-700', action: () => acceptTrade(trade.id)},
                {text: 'üîÑ Counter Offer', class: 'bg-yellow-600 hover:bg-yellow-700', action: () => counterTrade(trade)},
                {text: '‚ùå Reject', class: 'bg-red-600 hover:bg-red-700', action: () => rejectTrade(trade.id)},
                {text: '‚è∏Ô∏è Decide Later', class: 'bg-gray-400 hover:bg-gray-500', action: () => decideLaterTrade(trade.id)}
            ]);
        }

        // ‚úÖ Accept Trade
        async function acceptTrade(tradeId) {
            // Get fresh copy of trades
            const trades = [...(gameData.trades || [])];
            const trade = trades.find(t => t && t.id === tradeId);
            
            if (!trade) {
                hideModal();
                showModal('Trade Not Found', 'This trade no longer exists. It may have been cancelled or already accepted.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            if (!trade.fromId || !trade.toId) {
                console.error('Invalid trade data:', trade);
                hideModal();
                showModal('Invalid Trade', 'This trade has invalid data.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            // Execute the trade
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const fromPlayerIndex = playersCopy.findIndex(p => p && p.id === trade.fromId);
            const toPlayerIndex = playersCopy.findIndex(p => p && p.id === trade.toId);
            
            if (fromPlayerIndex === -1 || toPlayerIndex === -1) {
                hideModal();
                showModal('Player Not Found', 'One of the players in this trade no longer exists.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            // Transfer money
            playersCopy[fromPlayerIndex].money -= trade.offer.money;
            playersCopy[toPlayerIndex].money += trade.offer.money;
            playersCopy[toPlayerIndex].money -= trade.request.money;
            playersCopy[fromPlayerIndex].money += trade.request.money;
            
            // Transfer properties - HEM ownerId HEM de owners'ƒ± g√ºncelle
            (trade.offer.properties || []).forEach(propIndex => {
                if (propertiesCopy[propIndex]) {
                    propertiesCopy[propIndex].ownerId = trade.toId;
                    // Hisse sistemini g√ºncelle - %100 yeni sahibin
                    propertiesCopy[propIndex].owners = {
                        [trade.toId]: 100
                    };
                    propertiesCopy[propIndex].houses = 0; // Reset houses
                }
            });
            
            (trade.request.properties || []).forEach(propIndex => {
                if (propertiesCopy[propIndex]) {
                    propertiesCopy[propIndex].ownerId = trade.fromId;
                    // Hisse sistemini g√ºncelle - %100 yeni sahibin
                    propertiesCopy[propIndex].owners = {
                        [trade.fromId]: 100
                    };
                    propertiesCopy[propIndex].houses = 0; // Reset houses
                }
            });
            
            // Remove trade from list
            const updatedTrades = trades.filter(t => t.id !== tradeId);
            
            const fromPlayer = gameData.players.find(p => p && p.id === trade.fromId);
            const toPlayer = gameData.players.find(p => p && p.id === trade.toId);
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                trades: updatedTrades,
                gameLog: [...gameData.gameLog, `ü§ù ${toPlayer.name} accepted a trade from ${fromPlayer.name}!`]
            });
            
            hideModal();
            playSound('purchase');
            showModal('‚úÖ Trade Completed!', 'The trade has been executed successfully!', [
                {text: 'OK', class: 'bg-green-500', action: hideModal}
            ]);
        }

        // ‚ùå Reject Trade
        async function rejectTrade(tradeId) {
            const trades = [...(gameData.trades || [])];
            const trade = trades.find(t => t && t.id === tradeId);
            
            if (!trade) {
                hideModal();
                showModal('Trade Not Found', 'This trade no longer exists.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            const fromPlayer = gameData.players.find(p => p && p.id === trade.fromId);
            
            // Remove the trade
            const updatedTrades = trades.filter(t => t.id !== tradeId);
            
            await updateGame({
                trades: updatedTrades,
                gameLog: [...gameData.gameLog, `‚ùå Trade offer from ${fromPlayer ? fromPlayer.name : 'Unknown'} was rejected.`]
            });
            
            hideModal();
            showModal('Trade Rejected', 'You have rejected the trade offer.', [
                {text: 'OK', class: 'bg-red-500', action: hideModal}
            ]);
        }

        // ‚è∏Ô∏è Decide Later - Trade'i sakla ve modal'ƒ± kapat
        function decideLaterTrade(tradeId) {
            if (!decidedLaterTrades.includes(tradeId)) {
                decidedLaterTrades.push(tradeId);
            }
            hideModal();
            addLog('You decided to review the trade offer later.');
        }

        // üîÑ Counter Trade
        function counterTrade(originalTrade) {
            hideModal();
            // Flip the trade and show modal for counter offer
            setTimeout(() => {
                window.showTradeModal(originalTrade.fromId);
                
                // Pre-fill with reverse of original trade (optional)
                setTimeout(() => {
                    const myMoneyInput = document.getElementById('trade-my-money');
                    const theirMoneyInput = document.getElementById('trade-their-money');
                    
                    if (myMoneyInput) myMoneyInput.value = originalTrade.request.money;
                    if (theirMoneyInput) theirMoneyInput.value = originalTrade.offer.money;
                    
                    originalTrade.request.properties.forEach(propIndex => {
                        const checkbox = document.querySelector(`.my-prop-checkbox[value="${propIndex}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    
                    originalTrade.offer.properties.forEach(propIndex => {
                        const checkbox = document.querySelector(`.their-prop-checkbox[value="${propIndex}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }, 200);
            }, 300);
        }

        // ‚è∏Ô∏è View My Pending Trades
        function viewPendingTrades() {
            if (!gameData || !gameData.trades) {
                showModal('No Trades', 'You have no pending trades.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            const sentTrades = gameData.trades.filter(t => t.fromId === localPlayer.id && t.status === 'pending');
            const receivedTrades = gameData.trades.filter(t => t.toId === localPlayer.id && t.status === 'pending');
            const completedTrades = gameData.trades.filter(t => t.status !== 'pending');
            
            // T√ºm tradeleri g√∂ster
            const allVisibleTrades = [...sentTrades, ...receivedTrades, ...completedTrades.filter(t => {
                // Gizli trade ise ve ben dahil deƒüilsem g√∂sterme
                if (t.isSecret && t.fromId !== localPlayer.id && t.toId !== localPlayer.id) {
                    return false;
                }
                return true;
            })];
            
            if (allVisibleTrades.length === 0) {
                showModal('No Trades', 'No trades have been made yet.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            let tradesHTML = '';
            
            // üì§ Sent Trades
            if (sentTrades.length > 0) {
                tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-blue-700">üì§ Sent Trades</h3>';
                tradesHTML += sentTrades.map(trade => {
                    const toPlayer = gameData.players.find(p => p.id === trade.toId);
                    const getPropertyNames = (indices) => {
                        if (!indices || indices.length === 0) return 'Nothing';
                        return indices.map(i => gameData.settings.board[i].name).join(', ');
                    };
                    return `
                        <div class="border-2 border-blue-300 rounded-lg p-3 mb-2 bg-blue-50">
                            <div class="font-bold mb-1">To: ${toPlayer.name} ${trade.isSecret ? 'üîí' : ''}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div><b>You offer:</b> $${trade.offer.money}, ${getPropertyNames(trade.offer.properties)}</div>
                                <div><b>You want:</b> $${trade.request.money}, ${getPropertyNames(trade.request.properties)}</div>
                            </div>
                            <div class="text-sm text-gray-600">Sent: ${new Date(trade.timestamp).toLocaleTimeString()}</div>
                            <button onclick="event.stopPropagation(); window.cancelTrade('${trade.id}')" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
                                üóëÔ∏è Cancel
                            </button>
                        </div>
                    `;
                }).join('');
                tradesHTML += '</div>';
            }
            
            // üì• Received Trades
            if (receivedTrades.length > 0) {
                tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-green-700">üì• Received Trades</h3>';
                tradesHTML += receivedTrades.map(trade => {
                    const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
                    const getPropertyNames = (indices) => {
                        if (!indices || indices.length === 0) return 'Nothing';
                        return indices.map(i => gameData.settings.board[i].name).join(', ');
                    };
                    return `
                        <div class="border-2 border-green-300 rounded-lg p-3 mb-2 bg-green-50">
                            <div class="font-bold mb-1">From: ${fromPlayer.name} ${trade.isSecret ? 'üîí' : ''}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div><b>They offer:</b> $${trade.offer.money}, ${getPropertyNames(trade.offer.properties)}</div>
                                <div><b>They want:</b> $${trade.request.money}, ${getPropertyNames(trade.request.properties)}</div>
                            </div>
                            <div class="text-sm text-gray-600">Received: ${new Date(trade.timestamp).toLocaleTimeString()}</div>
                            <button onclick="event.stopPropagation(); window.respondToTrade('${trade.id}')" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                üëÄ View & Respond
                            </button>
                        </div>
                    `;
                }).join('');
                tradesHTML += '</div>';
            }
            
            // üìä Trade History
            if (completedTrades.length > 0) {
                const visibleCompletedTrades = completedTrades.filter(t => {
                    if (t.isSecret && t.fromId !== localPlayer.id && t.toId !== localPlayer.id) {
                        return false;
                    }
                    return true;
                });
                
                if (visibleCompletedTrades.length > 0) {
                    tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-gray-700">üìä Trade History</h3>';
                    tradesHTML += visibleCompletedTrades.map(trade => {
                        const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
                        const toPlayer = gameData.players.find(p => p.id === trade.toId);
                        
                        const statusBadge = trade.status === 'accepted' ? 
                            '<span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded">‚úÖ Accepted</span>' :
                            '<span class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded">‚ùå Rejected</span>';
                        
                        return `
                            <div class="border border-gray-300 rounded-lg p-2 mb-2 bg-gray-50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">${fromPlayer?.name || 'Unknown'} ‚Üí ${toPlayer?.name || 'Unknown'} ${trade.isSecret ? 'üîí' : ''}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                        `;
                    }).join('');
                    tradesHTML += '</div>';
                }
            }
            
            showModal('ü§ù All Trades', `<div class="max-h-96 overflow-y-auto">${tradesHTML}</div>`, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }
        
        // üëÄ Respond to Trade from list
        window.respondToTrade = function(tradeId) {
            const trade = gameData.trades.find(t => t && t.id === tradeId);
            if (trade) {
                hideModal();
                setTimeout(() => showIncomingTradeModal(trade), 300);
            } else {
                hideModal();
                setTimeout(() => {
                    showModal('Trade Not Found', 'This trade no longer exists.', [
                        {text: 'OK', class: 'bg-red-500', action: hideModal}
                    ]);
                }, 100);
            }
        }

        // üóëÔ∏è Cancel Trade
        window.cancelTrade = async function(tradeId) {
            const trades = [...(gameData.trades || [])];
            const tradeIndex = trades.findIndex(t => t.id === tradeId);
            if (tradeIndex === -1) return;
            
            trades.splice(tradeIndex, 1);
            
            await updateGame({
                trades: trades,
                gameLog: [...gameData.gameLog, `${localPlayer.name} cancelled a trade offer.`]
            });
            
            hideModal();
            showModal('Trade Cancelled', 'Your trade offer has been cancelled.', [
                {text: 'OK', class: 'bg-blue-500', action: hideModal}
            ]);
        }

        // --- MODAL ---
        function showModal(title, body, buttons = [], persistent = false) {
            // Clear any existing onclick handler first
            modal.onclick = null;
            
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            modalButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `text-white font-bold py-2 px-4 rounded ${btnInfo.class} disabled:bg-gray-400`;
                button.onclick = (e) => {
                    e.stopPropagation(); // Prevent modal from closing
                    if (btnInfo.action) btnInfo.action();
                };
                if(btnInfo.disabled) button.disabled = true;
                modalButtons.appendChild(button);
            });
            
            // Show modal first
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            // Set onclick handler after modal is fully visible
            setTimeout(() => {
                // Eƒüer persistent deƒüilse, modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapansƒ±n
                if (!persistent) {
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            hideModal();
                        }
                    };
                } else {
                    modal.onclick = null; // Persistent modal'da dƒ±≈üarƒ±ya tƒ±klanƒ±nca kapanma
                }
            }, 300);
        }

        function hideModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
        
        // --- PROPERTY BUY PANEL ---
        function showPropertyBuyPanel(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // ü§ñ Bot kontrol√º - Bot ise panel g√∂sterme!
            if (currentPlayer.isBot) {
                console.warn('‚ö†Ô∏è Bot cannot show property buy panel! Bot should use botDecidePropertyPurchase instead.');
                return;
            }
            
            propertyBuyTitle.textContent = `üè° Buy ${space.name}?`;
            propertyBuyName.textContent = space.name;
            propertyBuyDesc.innerHTML = `
                <p class="text-sm text-gray-600">This property is unowned. Choose your ownership share:</p>
                <p class="text-xs text-gray-500 mt-2">üí° Tip: Lower shares cost less but you'll share rental income and building rights.</p>
            `;
            
            // Clear previous options
            propertyBuyOptions.innerHTML = '';
            
            // Add share options
            const shareOptions = [
                { percentage: 100, label: '100% Full Ownership', class: 'bg-green-600 hover:bg-green-700' },
                { percentage: 75, label: '75% Majority', class: 'bg-green-500 hover:bg-green-600' },
                { percentage: 50, label: '50% Half', class: 'bg-green-400 hover:bg-green-500' },
                { percentage: 25, label: '25% Quarter', class: 'bg-green-300 hover:bg-green-400 text-gray-800' }
            ];
            
            shareOptions.forEach(option => {
                const cost = Math.floor(space.price * (option.percentage / 100));
                const canAfford = currentPlayer.money >= cost;
                
                const button = document.createElement('button');
                button.className = `w-full ${option.class} text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed`;
                button.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${option.label}</span>
                        <span class="text-lg">$${cost}</span>
                    </div>
                `;
                button.disabled = !canAfford;
                button.onclick = () => {
                    buyPropertyWithShare(position, option.percentage);
                    hidePropertyBuyPanel();
                };
                
                propertyBuyOptions.appendChild(button);
            });
            
            // Add auction option
            const auctionButton = document.createElement('button');
            auctionButton.className = 'w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200';
            auctionButton.innerHTML = 'üî® Decline & Start Auction';
            auctionButton.onclick = () => {
                startAuction(position);
                hidePropertyBuyPanel();
            };
            propertyBuyOptions.appendChild(auctionButton);
            
            // Show panel with animation
            propertyBuyPanel.classList.remove('hidden');
            setTimeout(() => {
                propertyBuyPanel.style.opacity = '0';
                propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(0.8)';
                propertyBuyPanel.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    propertyBuyPanel.style.opacity = '1';
                    propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 10);
            }, 10);
        }
        
        function hidePropertyBuyPanel() {
            propertyBuyPanel.style.opacity = '0';
            propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(0.8)';
            setTimeout(() => {
                propertyBuyPanel.classList.add('hidden');
            }, 300);
        }
        
        // Close button handler
        if (propertyBuyClose) {
            propertyBuyClose.addEventListener('click', () => {
                console.log('üîò Close button clicked');
                hidePropertyBuyPanel();
                
                // Property almadan kapatƒ±ldƒ±, tur tamamlandƒ± sayƒ±lsƒ±n
                if (gameData && gameData.turnState !== 'action_complete') {
                    gameData.turnState = 'action_complete';
                    updateGameUI();
                    console.log('‚úÖ Turn state set to action_complete - End Turn enabled');
                }
                
                // Optionally start auction if player doesn't buy
                // startAuction(currentPosition);
            });
        }
        
        // --- UTILITIES ---
        async function updateGame(data) {
            sendMessage({
                type: 'update_game',
                gameId: currentGameId,
                updates: data
            });
        }

        function validatePlayerName() {
            addDebugLog('üîç Validating name...');
            const name = playerNameInput.value.trim();
            addDebugLog('üìù Name value: "' + name + '" (length: ' + name.length + ')');
            
            if (name.length < 2 || name.length > 15) {
                lobbyError.textContent = 'Name must be between 2 and 15 characters.';
                addDebugLog('‚ùå Name length invalid: ' + name.length);
                return false;
            }
            
            let playerId = localStorage.getItem('monopolyPlayerId');
            if (!playerId) {
                try {
                    // Try crypto.randomUUID() first (modern browsers)
                    if (crypto && crypto.randomUUID) {
                        playerId = crypto.randomUUID();
                        addDebugLog('‚úÖ UUID created (crypto)');
                    } else {
                        // Fallback for older browsers
                        playerId = 'player-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        addDebugLog('‚úÖ UUID created (fallback)');
                    }
                    localStorage.setItem('monopolyPlayerId', playerId);
                    addDebugLog('‚úÖ Player ID saved to localStorage');
                } catch (error) {
                    addDebugLog('‚ùå UUID ERROR: ' + error.message);
                    // Emergency fallback
                    playerId = 'player-' + Date.now();
                    addDebugLog('‚ö†Ô∏è Using emergency ID');
                }
            } else {
                addDebugLog('‚úÖ Existing player ID found');
            }
            
            localPlayer = { id: playerId, name: name };
            lobbyError.textContent = '';
            addDebugLog('‚úÖ Name validated: ' + name);
            return true;
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }
        
        // Helper function to adjust color brightness
        function adjustColor(color, amount) {
            const clamp = (num) => Math.min(Math.max(num, 0), 255);
            const num = parseInt(color.replace("#", ""), 16);
            const r = clamp((num >> 16) + amount);
            const g = clamp(((num >> 8) & 0x00FF) + amount);
            const b = clamp((num & 0x0000FF) + amount);
            return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }
        
        copyGameIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentGameId).then(() => {
                const originalText = copyGameIdBtn.innerHTML;
                copyGameIdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"></path></svg>`;
                setTimeout(() => { copyGameIdBtn.innerHTML = originalText; }, 2000);
            });
        });

        // Copy game link button event listener
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', () => {
                const gameLinkInput = document.getElementById('gameLinkInput');
                if (gameLinkInput && gameLinkInput.value) {
                    navigator.clipboard.writeText(gameLinkInput.value).then(() => {
                        const originalText = copyLinkBtn.textContent;
                        copyLinkBtn.textContent = 'Copied!';
                        setTimeout(() => { copyLinkBtn.textContent = originalText; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy link:', err);
                        copyLinkBtn.textContent = 'Error!';
                        setTimeout(() => { copyLinkBtn.textContent = originalText; }, 2000);
                    });
                }
            });
        }
        
        // Chat functions
        function addChatMessage(playerName, text, isOwn = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'bg-blue-50 border-blue-400' : ''}`;
            messageDiv.innerHTML = `
                <div class="sender">${playerName}</div>
                <div class="text">${text}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const text = chatInput.value.trim();
            
            console.log('Chat attempt - text:', text, 'currentGameId:', currentGameId, 'localPlayer:', localPlayer, 'ws state:', ws ? ws.readyState : 'no ws');
            
            if (!text) {
                console.log('Chat: Empty message');
                return;
            }
            
            if (!currentGameId) {
                console.log('Chat: No currentGameId');
                addChatMessage('System', 'Please join a game first', false);
                return;
            }
            
            if (!localPlayer) {
                console.log('Chat: No localPlayer');
                addChatMessage('System', 'Please enter your name first', false);
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('Chat: WebSocket not connected');
                addChatMessage('System', 'Connection lost. Reconnecting...', false);
                connectWebSocket();
                return;
            }
            
            const message = {
                type: 'chat_message',
                gameId: currentGameId,
                playerName: localPlayer.name,
                text: text
            };
            console.log('Sending chat message:', message);
            
            try {
                sendMessage(message);
                addChatMessage(localPlayer.name, text, true);
                chatInput.value = '';
            } catch (error) {
                console.error('Chat send error:', error);
                addChatMessage('System', 'Failed to send message: ' + error.message, false);
            }
        }
        
        // Public games functions
        function loadPublicGames() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('WebSocket not connected, cannot load games');
                return;
            }
            
            sendMessage({ type: 'list_games' });
        }
        
        function displayPublicGames(games) {
            const gamesList = document.getElementById('public-games-list');
            if (!gamesList) return;
            
            if (games.length === 0) {
                gamesList.innerHTML = '<p class="text="text-gray-500 text-sm">No public games available</p>';
                return;
            }
            
            gamesList.innerHTML = '';
            
            games.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'bg-white p-3 rounded-lg border border-gray-200 hover:border-blue-300 cursor-pointer transition-colors';
                gameDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-gray-800">${game.gameId}</div>
                            <div class="text-sm text-gray-600">Host: ${game.hostName}</div>
                            <div class="text-xs text-gray-500">Map: ${game.map} ‚Ä¢ Players: ${game.playerCount}/${game.maxPlayers}</div>
                        </div>
                        <button class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors join-game-btn" data-game-id="${game.gameId}">
                            Join
                        </button>
                    </div>
                `;
                
                // Add click handler for join button
                const joinBtn = gameDiv.querySelector('.join-game-btn');
                joinBtn.addEventListener('click', () => {
                    document.getElementById('gameIdInput').value = game.gameId;
                    document.getElementById('joinGameBtn').click();
                });
                
                gamesList.appendChild(gameDiv);
            });
        }
        
        function init() {
            const storedName = localStorage.getItem('monopolyPlayerName');
            if (storedName) playerNameInput.value = storedName;
            
            playerNameInput.addEventListener('change', () => {
                localStorage.setItem('monopolyPlayerName', playerNameInput.value);
            });
            
            // üîÑ Check for stored game session (F5 protection)
            const storedGameId = localStorage.getItem('monopolyCurrentGameId');
            const storedPlayerId = localStorage.getItem('monopolyPlayerId');
            const storedPlayerName = localStorage.getItem('monopolyPlayerName');
            
            // Show "Continue Game" button if there's a saved session
            const continueSection = document.getElementById('continue-game-section');
            const continueBtn = document.getElementById('continueGameBtn');
            const clearSessionBtn = document.getElementById('clearSessionBtn');
            
            if (storedGameId && storedPlayerId) {
                console.log('üîÑ Found previous game session:', storedGameId);
                continueSection.classList.remove('hidden');
                
                // Get additional saved info
                const savedMoney = localStorage.getItem('monopolyPlayerMoney');
                const savedPosition = localStorage.getItem('monopolyPlayerPosition');
                
                // Update button text with saved info
                let btnText = 'üîÑ Oyuna Devam Et';
                if (savedMoney && savedPosition) {
                    btnText += ` (üí∞$${savedMoney} | üìçPos ${savedPosition})`;
                }
                continueBtn.innerHTML = btnText;
                
                // Continue game button handler
                continueBtn.onclick = () => {
                    console.log('üîÑ Reconnecting to previous game:', storedGameId);
                    currentGameId = storedGameId;
                    localPlayer.id = storedPlayerId;
                    if (storedPlayerName) {
                        playerNameInput.value = storedPlayerName;
                        localPlayer.name = storedPlayerName;
                    }
                    
                    // Send rejoin request to server
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        sendMessage({
                            type: 'rejoin_game',
                            gameId: storedGameId,
                            playerId: storedPlayerId
                        });
                    }
                };
                
                // Clear session button handler
                clearSessionBtn.onclick = () => {
                    if (confirm('Kayƒ±tlƒ± oturumu silmek istediƒüinize emin misiniz?')) {
                        localStorage.removeItem('monopolyCurrentGameId');
                        localStorage.removeItem('monopolyPlayerId');
                        localStorage.removeItem('monopolyPlayerMoney');
                        localStorage.removeItem('monopolyPlayerPosition');
                        continueSection.classList.add('hidden');
                        console.log('üóëÔ∏è Session cleared');
                    }
                };
            }
            
            // Check URL parameters for auto-join
            const urlParams = new URLSearchParams(window.location.search);
            const autoJoinGameId = urlParams.get('gameId');
            if (autoJoinGameId) {
                gameIdInput.value = autoJoinGameId;
                // Auto-join will happen after WebSocket connects
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        // Check if we need to prompt for name/character
                        if (!playerNameInput.value.trim()) {
                            const name = prompt('Enter your name to join the game:');
                            if (name && name.trim()) {
                                playerNameInput.value = name.trim();
                                localStorage.setItem('monopolyPlayerName', name.trim());
                            } else {
                                return; // Cancel auto-join if no name provided
                            }
                        }
                        
                        if (!selectedCharacter) {
                            // Auto-select first available character
                            const availableCharacters = ['dog', 'car', 'ship', 'hat', 'thimble', 'boot', 'wheelbarrow', 'iron'];
                            selectedCharacter = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
                            // Update UI to show selected character
                            document.querySelectorAll('.character-option').forEach(option => {
                                if (option.dataset.character === selectedCharacter) {
                                    option.classList.add('ring-2', 'ring-blue-500');
                                } else {
                                    option.classList.remove('ring-2', 'ring-blue-500');
                                }
                            });
                        }
                        
                        joinGame();
                    }
                }, 1000);
            }
            
            // Load public games list
            loadPublicGames();
            
            // Refresh games button
            const refreshGamesBtn = document.getElementById('refreshGamesBtn');
            if (refreshGamesBtn) {
                refreshGamesBtn.addEventListener('click', loadPublicGames);
            }
            
            // Hide game-settings-only elements on initial load (lobby screen)
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            
            if (customizeTitle) customizeTitle.style.display = 'none';
            if (propertiesEditor) propertiesEditor.style.display = 'none';
            if (lobbyControls) lobbyControls.style.display = 'none';
            if (allowTradingContainer) allowTradingContainer.style.display = 'none';
            
            // Chat event listeners
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            if (chatInput && chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Game link copy button event listener (desktop)
            const copyGameLinkBtn = document.getElementById('copy-game-link-btn');
            if (copyGameLinkBtn) {
                copyGameLinkBtn.addEventListener('click', () => {
                    const gameLinkInput = document.getElementById('game-link-input');
                    if (gameLinkInput && gameLinkInput.value) {
                        navigator.clipboard.writeText(gameLinkInput.value).then(() => {
                            const originalText = copyGameLinkBtn.innerHTML;
                            copyGameLinkBtn.innerHTML = '‚úÖ';
                            setTimeout(() => { copyGameLinkBtn.innerHTML = originalText; }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy game link:', err);
                            copyGameLinkBtn.innerHTML = '‚ùå';
                            setTimeout(() => { copyGameLinkBtn.innerHTML = originalText; }, 2000);
                        });
                    }
                });
            }
            
            // Game link copy button event listener (mobile)
            const copyGameLinkBtnMobile = document.getElementById('copy-game-link-btn-mobile');
            if (copyGameLinkBtnMobile) {
                copyGameLinkBtnMobile.addEventListener('click', () => {
                    const gameLinkInputMobile = document.getElementById('game-link-input-mobile');
                    if (gameLinkInputMobile && gameLinkInputMobile.value) {
                        navigator.clipboard.writeText(gameLinkInputMobile.value).then(() => {
                            const originalText = copyGameLinkBtnMobile.innerHTML;
                            copyGameLinkBtnMobile.innerHTML = '‚úÖ';
                            setTimeout(() => { copyGameLinkBtnMobile.innerHTML = originalText; }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy game link:', err);
                            copyGameLinkBtnMobile.innerHTML = '‚ùå';
                            setTimeout(() => { copyGameLinkBtnMobile.innerHTML = originalText; }, 2000);
                        });
                    }
                });
            }
            
            // Chat event listeners
            const chatInputEl = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            
            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', sendChatMessage);
            }
            
            if (chatInputEl) {
                chatInputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Voice Chat event listeners
            const joinVoiceBtn = document.getElementById('join-voice-btn');
            const leaveVoiceBtn = document.getElementById('leave-voice-btn');
            const toggleMicBtn = document.getElementById('toggle-mic-btn');
            let isInVoice = false;
            let isMicMuted = false;
            let localStream = null;
            let peers = {}; // Store peer connections by player ID
            
            // WebRTC Voice Chat Implementation
            async function startVoiceChat() {
                try {
                    console.log('üé§ Requesting microphone access...');
                    
                    // Get user's audio stream
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }, 
                        video: false 
                    });
                    
                    console.log('‚úÖ Got local audio stream');
                    console.log('Audio tracks:', localStream.getAudioTracks());
                    
                    // Check if audio is enabled
                    localStream.getAudioTracks().forEach(track => {
                        console.log(`Track: ${track.kind}, enabled: ${track.enabled}, muted: ${track.muted}`);
                    });
                    
                    // Notify other players that we joined voice
                    sendMessage({
                        type: 'voice_join',
                        playerId: localPlayer.id,
                        playerName: localPlayer.name
                    });
                    
                    isInVoice = true;
                    joinVoiceBtn.classList.add('hidden');
                    leaveVoiceBtn.classList.remove('hidden');
                    toggleMicBtn.classList.remove('hidden');
                    addChatMessage('SYSTEM', 'üé§ You joined voice chat', false);
                    
                } catch (error) {
                    console.error('‚ùå Error accessing microphone:', error);
                    let errorMsg = 'Could not access microphone. ';
                    if (error.name === 'NotAllowedError') {
                        errorMsg += 'Please allow microphone access in your browser.';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += 'No microphone found.';
                    } else {
                        errorMsg += error.message;
                    }
                    alert(errorMsg);
                }
            }
            
            function stopVoiceChat() {
                // Stop local stream
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                // Close all peer connections
                Object.values(peers).forEach(peer => {
                    if (peer) peer.destroy();
                });
                peers = {};
                
                // Notify others that we left
                sendMessage({
                    type: 'voice_leave',
                    playerId: localPlayer.id
                });
                
                isInVoice = false;
                isMicMuted = false;
                joinVoiceBtn.classList.remove('hidden');
                leaveVoiceBtn.classList.add('hidden');
                toggleMicBtn.classList.add('hidden');
                toggleMicBtn.innerHTML = '<span class="material-icons-outlined text-sm">mic_off</span>';
                toggleMicBtn.style.background = '#374151';
                addChatMessage('SYSTEM', 'üîá You left voice chat', false);
                
                console.log('üîá Left voice chat');
            }
            
            function createPeerConnection(remotePeerId, initiator = false) {
                console.log(`üîó Creating peer connection with ${remotePeerId}, initiator: ${initiator}`);
                
                if (!localStream) {
                    console.error('‚ùå No local stream available');
                    return null;
                }
                
                const peer = new SimplePeer({
                    initiator: initiator,
                    stream: localStream,
                    trickle: true,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('signal', signal => {
                    console.log(`üì° Sending signal to ${remotePeerId}`, signal.type);
                    sendMessage({
                        type: 'voice_signal',
                        from: localPlayer.id,
                        to: remotePeerId,
                        signal: signal
                    });
                });
                
                peer.on('stream', remoteStream => {
                    console.log(`üîä Received remote stream from ${remotePeerId}`);
                    console.log('Stream tracks:', remoteStream.getTracks());
                    
                    // Create audio element and add to DOM
                    const audio = document.createElement('audio');
                    audio.id = `voice-${remotePeerId}`;
                    audio.srcObject = remoteStream;
                    audio.autoplay = true;
                    audio.volume = 1.0;
                    
                    // Add to body (hidden)
                    document.body.appendChild(audio);
                    
                    // Play audio
                    audio.play()
                        .then(() => console.log(`‚úÖ Playing audio from ${remotePeerId}`))
                        .catch(e => console.error('‚ùå Error playing audio:', e));
                });
                
                peer.on('connect', () => {
                    console.log(`‚úÖ Connected to ${remotePeerId}`);
                });
                
                peer.on('error', err => {
                    console.error(`‚ùå Peer error with ${remotePeerId}:`, err);
                });
                
                peer.on('close', () => {
                    console.log(`üîå Peer connection closed with ${remotePeerId}`);
                    
                    // Remove audio element
                    const audio = document.getElementById(`voice-${remotePeerId}`);
                    if (audio) audio.remove();
                    
                    delete peers[remotePeerId];
                });
                
                peers[remotePeerId] = peer;
                return peer;
            }
            
            function toggleMicrophone() {
                if (!localStream) return;
                
                isMicMuted = !isMicMuted;
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMicMuted;
                });
                
                if (isMicMuted) {
                    toggleMicBtn.innerHTML = '<span class="material-icons-outlined text-sm">mic_off</span>';
                    toggleMicBtn.style.background = '#374151';
                    toggleMicBtn.style.color = '#E5E7EB';
                    addChatMessage('SYSTEM', 'üîá Microphone muted', false);
                } else {
                    toggleMicBtn.innerHTML = '<span class="material-icons-outlined text-sm">mic</span>';
                    toggleMicBtn.style.background = '#00F5D4';
                    toggleMicBtn.style.color = '#0D0C14';
                    addChatMessage('SYSTEM', 'üé§ Microphone unmuted', false);
                }
                
                console.log('üé§ Mic muted:', isMicMuted);
            }
            
            if (joinVoiceBtn) {
                joinVoiceBtn.addEventListener('click', startVoiceChat);
            }
            
            if (leaveVoiceBtn) {
                leaveVoiceBtn.addEventListener('click', stopVoiceChat);
            }
            
            if (toggleMicBtn) {
                toggleMicBtn.addEventListener('click', toggleMicrophone);
            }
            
            // Initialize WebSocket connection
            connectWebSocket();
        }
        
        init();

    </script>

    <!-- Game Management Modal -->
    <div id="gameManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Game Management</h3>
            <p id="managementPlayerName" class="mb-4"></p>
            <button id="kickPlayerBtn" class="w-full bg-red-500 text-white p-2 rounded mb-2">Kick Player</button>
            <button id="forceEndTurnBtn" class="w-full bg-yellow-500 text-white p-2 rounded mb-2">Force End Turn</button>
            <button id="forceRollDiceBtn" class="w-full bg-blue-500 text-white p-2 rounded mb-4">Force Roll Dice</button>
            <button id="closeManagementModal" class="w-full bg-gray-500 text-white p-2 rounded">Close</button>
        </div>
    </div>

    <!-- Structured Data (Schema.org) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "DeepPixel - Online Monopoly Oyunu",
        "url": "https://deeppixel.online",
        "description": "√úcretsiz online √ßok oyunculu monopoly oyunu. Arkada≈ülarƒ±nƒ±zla ger√ßek zamanlƒ± oynayƒ±n, √∂zelle≈ütirilebilir oyun modlarƒ±.",
        "applicationCategory": "GameApplication",
        "genre": "Board Game",
        "inLanguage": "tr-TR",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "TRY"
        },
        "author": {
            "@type": "Organization",
            "name": "DeepPixel"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "156"
        },
        "featureList": [
            "Ger√ßek zamanlƒ± √ßok oyunculu oyun",
            "2-8 oyuncu desteƒüi",
            "√ñzelle≈ütirilebilir oyun tahtasƒ±",
            "Takas sistemi",
            "Mobil uyumlu tasarƒ±m",
            "√úcretsiz oyna"
        ]
    }
    </script>

</body>
</html>
